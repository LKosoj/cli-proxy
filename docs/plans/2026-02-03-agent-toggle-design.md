# Дизайн: агентный режим (ON/OFF) для CLI-бота

Дата: 2026-02-03

## Цели
- Добавить переключаемый агентный режим **в рамках конкретной сессии**.
- При OFF запросы идут напрямую в CLI.
- При ON запросы обрабатываются Python-агентом, который оркестрирует вызовы CLI и остальных тулов.
- Переключение режима — через команду в боте с инлайн-клавиатурой.
- В статусе сессии показывать состояние агента.
- Агент имеет **полный набор тулов** как в LocalTopSH, включая memory-tool.

## Поведение и UX
- Команда `/agent` открывает инлайн-клавиатуру:
  - Если агент выключен → кнопка «Включить агента» + «Отмена».
  - Если агент включен → кнопка «Выключить агента» + «Отмена».
- Нажатие кнопки переключает `session.agent_enabled` и подтверждает действие.
- «Отмена» не меняет состояние.
- В статусе сессии отображается `Agent: ON|OFF`.
- Дефолт для новой сессии: **OFF**.

## Архитектура и хранение состояния
- Состояние хранится в объекте сессии: `agent_enabled: bool`.
- Состояние сохраняется в рамках сессии и восстанавливается при загрузке сессии (если есть storage).
- Перезапуск процесса не должен менять логику маршрутизации: либо восстановить состояние из storage, либо по умолчанию OFF.

## Агентный pipeline (Python)
- Агент — отдельный Python-модуль (например `agent/`) в составе проекта.
- Вход: запрос пользователя + контекст сессии (cwd, историю/summary, лимиты).
- Выход: финальный ответ + краткая трассировка действий (для логов/отладки).

### Логика выбора CLI
- CLI обязателен, если требуется:
  - выполнение команд,
  - работа с файлами,
  - генерация артефактов,
  - сборка/запуск/проверки.
- CLI не нужен, если запрос информационный или решается контекстом.
- При неопределенности — `ask_user`.
- Агент всегда кратко фиксирует причину выбора (CLI/без CLI) в служебном логе.

## Набор тулов (полное соответствие LocalTopSH)
Обязательные инструменты агента:
1) `run_command`
2) `read_file`
3) `write_file`
4) `edit_file`
5) `delete_file`
6) `search_files`
7) `search_text`
8) `list_directory`
9) `search_web`
10) `fetch_page`
11) `manage_tasks`
12) `ask_user`
13) `send_file`
14) `message` (служебные сообщения/статусы)
15) `meme` (поддержка, но по умолчанию не использовать в сценариях)
16) `scheduler`
17) `memory` (обязательный tool)

## Memory-tool
- Агенту доступен `memory` для краткого контекста/суммаризации.
- Лимиты по объему памяти задаются существующими параметрами (без новых конфигов).

## Интеграция с CLI
- При OFF: текущий путь исполнения без изменений.
- При ON: запрос проходит через агент, который вызывает CLI и остальные тулы через единый реестр.

## Требования к конфигу
- Новые ключи конфигурации **не добавляются**.
- Агент использует уже существующие креденшелы из `config.yaml`.

## Тестовые сценарии (ручные)
1) OFF: запрос должен уйти напрямую в CLI (без агентной трассы).
2) ON: запрос должен пройти через агент, выполняется цепочка действий.
3) Переключение ON/OFF в одной сессии корректно меняет маршрут.
4) В статусе сессии отображается `Agent: ON|OFF`.
5) `ask_user` в агенте работает через инлайн-кнопки.
6) `memory` используется агентом для краткого контекста.

## Открытые вопросы
- Нужна ли опциональная команда `/agent status` или достаточно `/status`?
- Нужно ли сохранять состояние агента при рестарте процесса, если storage отключен?
