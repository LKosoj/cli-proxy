# ТЗ: сценарий C — агент в песочнице, очистка, служебные файлы

## 1. Цель
Снизить риск «мусора» в рабочих проектах, формализовать правила работы агента и очистки его артефактов, сохранить удобство через inline‑меню в Telegram.

## 2. Аудитория
Инженеры, которые дорабатывают `cli-proxy`.

## 3. Контекст (кратко)
Проект поддерживает два режима:
1) прямой запуск CLI (Codex/и т.п.);
2) запуск агента‑оркестратора, который сам использует инструменты и может создавать файлы.

Проблема: агент оставляет артефакты в рабочих каталогах, нет встроенной очистки по сессии/песочнице.

## 4. Ключевые принципы сценария C
1) **Одна песочница на все сессии** — агент всегда работает внутри одного каталога sandbox, заданного как `workdir/_sandbox`.
2) **Служебные файлы защищены** — при очистке не удаляются.
3) **Очистка на выбор**:
   - очистить всё в песочнице (кроме служебных);
   - очистить файлы, относящиеся к текущей сессии (кроме служебных).
4) **UI управление через inline‑меню** — дополнительные кнопки видны, когда агент включён.

## 5. Служебные файлы (явный перечень)
Все служебные файлы и каталоги **находятся внутри** `workdir/_sandbox`.

### В корне песочницы
- `workdir/_sandbox/SESSION.json` — история шагов/результатов агента (исполнитель + оркестратор).
- `workdir/_sandbox/MEMORY.md` — долговременная память.

### В shared‑зоне внутри песочницы
- `workdir/_sandbox/_shared/` — служебный каталог.
- `workdir/_sandbox/_shared/GLOBAL_LOG.md` — общий лог активности (агент пишет события через `log_global`).
- `workdir/_sandbox/_shared/chats/` — служебный каталог с чат‑логами.
- `workdir/_sandbox/_shared/chats/chat_global.md` — общий чат‑лог.
- `workdir/_sandbox/_shared/chats/chat_<chat_id>.md` — чат‑логи по чатам (используются как RECENT_CHAT в промпте).

**Решение:** переносим `_shared` внутрь `workdir/_sandbox` и считаем содержимое служебным. Сейчас `agent/agent_core.py` пишет в `/workspace/_shared`, а память/SESSION — в cwd.

## 6. Термины и сущности
- **Session** — пользовательская сессия бота (`session_id`).
- **Sandbox** — корневая директория, выделенная агенту на время сессии. Все артефакты агента пишутся внутрь.
- **Service files** — файлы, необходимые для устойчивости и контекста агента (см. список выше).

## 7. Требования к поведению

### 7.1 Размещение файлов
- Все операции записи/чтения/создания файлов агентом должны происходить относительно **одного sandbox‑каталога**: `workdir/_sandbox`.
- Для прямого CLI режим остается без изменений.

### 7.2 Привязка артефактов к сессии
- Поскольку sandbox общий для всех сессий, каждый артефакт должен иметь явную привязку к `session_id` (через структуру каталогов или метаданные).
- Очистка «по сессии» должна удалять всё, что относится к этой сессии, кроме service files.

### 7.3 Очистка
- **Очистка песочницы целиком**: удалить все **не‑служебные** файлы в sandbox.
- **Очистка текущей сессии**: удалить все не‑служебные файлы, относящиеся к текущей сессии.
- Service files не трогаются в обоих случаях.

### 7.4 Inline‑меню
В режиме агента (через `/agent`) отображать расширенное меню:
- Базовые: «Отключить», «Отменить».
- Дополнительные (через подменю):
  - «Очистить песочницу (кроме служебных)»
  - «Очистить текущую сессию (кроме служебных)»

### 7.5 Сброс сессии
- При сбросе сессии: сначала `/interrupt`, затем шаги сброса, затем очистка in‑memory контекста агента.

### 7.6 Буферизация сообщений Telegram
Логика буфера применяется **только** к сообщениям **без вложений**.
- Если длина < 3000 и это первое сообщение — не ждать.
- Если короткое сообщение пришло в буфер — считать последним и сразу отправлять.

### 7.7 Загрузка истории
- Оркестратор перед стартом подгружает **25 последних записей** из `SESSION.json`.

## 8. Риски и контроль
- **Риск:** глобальная `_shared` зона обходится sandbox‑ограничений.
  - **Контроль:** перенос `_shared` внутрь `workdir/_sandbox` и исключение из очистки.
- **Риск:** агент через tool может записывать вне sandbox.
  - **Контроль:** проверка пути и запрет записи вне sandbox‑корня.

## 9. Проверки приемки (definition of done)
1) Все файлы агента находятся внутри sandbox‑директории.
2) Очистка песочницы не удаляет service files.
3) Очистка текущей сессии удаляет только файлы данной сессии, service files сохраняются.
4) Inline‑меню отображается корректно и вызывает нужные действия.
5) Сброс сессии вызывает `/interrupt` и очищает runtime‑контекст.
6) Буфер сообщений работает по правилам (без вложений).

## 10. Открытые вопросы
Нет.

## 11. Несоответствия текущей реализации (для выполнения ТЗ)
1) Оркестратор (`agent/orchestrator.py`) читает/пишет `SESSION.json` и `MEMORY.md` в `config.defaults.workdir`, а не в `workdir/_sandbox`.
2) `agent/agent_core.py` использует жёсткий путь `/workspace/_shared` для логов и чатов, а не `workdir/_sandbox/_shared`.
3) `AgentRunner`/`Executor` используют `session.workdir` как `cwd`, что выводит артефакты за пределы песочницы при включённом агенте.

## 12. Требуемые корректировки поведения (без кода)
1) Все точки записи/чтения агента (оркестратор, executor, tool‑слой) должны работать относительно `workdir/_sandbox`.
2) `_shared` должен создаваться и использоваться только внутри `workdir/_sandbox/_shared`.
3) Все операции очистки должны учитывать явный список service files из раздела 5.
4) При активном агенте любые операции файловых инструментов должны быть ограничены песочницей.

## 13. Точки в коде (где вносить изменения)
- `agent/agent_core.py`: `log_global`, `save_chat_message`, `get_chat_history` — перенос `_shared` внутрь `workdir/_sandbox/_shared`.
- `agent/agent_core.py`: загрузка/сохранение `SESSION.json` и `MEMORY.md` через `state_root` (sandbox‑корень).
- `agent/executor.py`: запуск агента в `workdir/_sandbox/sessions/<session_id>`; прокидывание `state_root`.
- `agent/orchestrator.py`: чтение/запись `SESSION.json` и `MEMORY.md` в `workdir/_sandbox`.
- `bot.py`: inline‑меню `/agent`, очистка песочницы/сессии, настройка `AGENT_SANDBOX_ROOT`, создание `workdir/_sandbox/_shared`.
