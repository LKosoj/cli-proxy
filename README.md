# CLI Proxy Telegram Bridge

[English version](README_EN.MD) | [Русская версия](README.md)

Telegram‑бот для управления CLI‑агентами (Codex / Gemini / Qwen / Claude) с поддержкой нескольких сессий, очереди запросов, HTML‑вывода и кэширования справки по /командам каждого инструмента.

## Возможности
- Несколько сессий CLI в разных каталогах.
- Очередь запросов и контроль занятости.
- Вывод всегда в HTML‑файл (с сохранением ANSI‑цветов).
- Краткий анонс: саммари через OpenAI или превью 4000 символов.
- Автодетект prompt и resume‑токена, сохранение в `state.json`.
- Восстановление активной сессии после перезапуска.
- Inline‑меню для выбора сессий, каталогов и команд.
- Кнопка “Использовать этот каталог” при выборе директории.
- Кнопка “git clone” для клонирования репозитория в выбранный каталог.
- Inline‑меню Git‑операций (status/fetch/pull ff‑only/merge/rebase/diff/log/stash) для активной сессии.
- Обработка конфликтов merge/rebase с кнопками diff/abort/continue/позвать агента.
- Кэш help‑команд инструмента в `toolhelp.json`.

## Быстрый старт
1) Установите зависимости:
```bash
pip install -r requirements.txt
```

2) Заполните `config.yaml`:
- `telegram.token`
- `telegram.whitelist_chat_ids`
- `defaults.workdir`
- при необходимости `openai_*` для автоматического создания summary ответов от CLI инструментов

3) Запустите бота:
```bash
python bot.py
```

## Конфигурация
`config.yaml` поддерживает:
- `tools.*`: команды запуска, режим, prompt/resume/help (включая `resume_cmd` для отдельных команд возобновления)
- `defaults.*`: базовый каталог, таймауты, пути к state/toolhelp, OpenAI настройки

Для каждого инструмента можно задать переменные окружения:
```yaml
tools:
  codex:
    env:
      OPENAI_API_KEY: "..."
      OPENAI_MODEL: "..."
```
Эти переменные будут добавлены к окружению процесса CLI.

Поддерживаются подстановки переменных окружения вида `${VAR}`.
Значения `null` игнорируются и не добавляются в окружение.

## YOLO/auto‑approve режим
В `config.yaml` включены авто‑одобрения:
- **Gemini CLI**: `--approval-mode yolo`
- **Qwen Code**: `--yolo`
- **Claude Code**: `--dangerously-skip-permissions`
- **Codex**: в интерактивном режиме отправляется `/approvals full`

OpenAI может быть задан как через `config.yaml`, так и через env:
- `OPENAI_API_KEY`
- `OPENAI_MODEL`
- `OPENAI_BASE_URL`

Переменные окружения имеют приоритет.

## Команды бота
- `/tools` — список инструментов
- `/new` — создать сессию (inline‑меню)
- `/newpath <path>` — задать путь после выбора инструмента
- `/sessions` — список сессий
- `/use` — выбрать активную сессию (menu)
- `/close` — закрыть сессию (menu)
- `/rename <id> <name>` или `/rename <name>` — переименовать сессию
- `/status` — статус активной сессии (busy, последняя активность/тик секундомера)
- `/interrupt` — прервать генерацию
- `/queue` — показать очередь
- `/clearqueue` — очистить очередь активной сессии
- `/send <текст>` — отправить текст напрямую в CLI
- `/resume [token]` — показать/установить resume
- `/state [tool path]` — состояние по tool+path или меню
- `/setprompt <tool> <regex>` — установить prompt_regex для инструмента
- `/dirs` — просмотр каталогов (menu)
- `/gitclone` — клонировать репозиторий в выбранный каталог (menu)
- `/git` — Git‑операции по активной сессии (inline‑меню: статус/fetch/pull/merge/rebase/diff/log/stash)
- `/cwd <path>` — создать сессию в каталоге
- `/toolhelp` — получить /команды выбранного инструмента
- `/menu` — подсказка по меню (меню доступно через кнопку рядом с полем ввода)
- `/start` — показать подсказку по меню
- `/purge <id>` — удалить сессию из сохранённого состояния

## Состояния
- `state.json` — последняя точка (resume + саммари) для tool+workdir
- `state.json` — также хранит последнюю активную сессию (tool+workdir)
- `state.json` — хранит список сессий (имя, очередь) для восстановления после перезапуска
- `toolhelp.json` — кэш справки /help для каждого инструмента

## Тесты
```bash
pytest -q
```

## Прямой ввод в CLI
Если нужно отправить строку, начинающуюся с `/`, используйте один из способов:
- `/send /help`
- Или префикс `>` в обычном сообщении: `> /help`
