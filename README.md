# CLI Proxy Telegram Bridge

[English version](README_EN.MD) | [Русская версия](README.md)

Telegram‑бот для управления CLI‑агентами (Codex / Gemini / Qwen / Claude) с поддержкой нескольких сессий, очереди запросов, HTML‑вывода и кэширования справки по /командам каждого инструмента.

## Возможности
- Несколько сессий CLI в разных каталогах.
- Очередь запросов и контроль занятости.
- Вывод всегда в HTML‑файл (Markdown‑разметка, ANSI‑цвета, mermaid‑диаграммы в SVG; при ошибке рендера остаются как код‑блоки).
- Краткий анонс: саммари через OpenAI или превью 4000 символов.
- Автодетект prompt и resume‑токена, сохранение в `state.json`.
- Восстановление активной сессии после перезапуска.
- Inline‑меню для выбора сессий, каталогов и команд.
- Кнопка “Использовать этот каталог” при выборе директории.
- Кнопка “git clone” для клонирования репозитория в выбранный каталог.
- Inline‑меню Git‑операций (status/fetch/pull ff‑only/merge/rebase/diff/log/stash/commit/push) для активной сессии.
- Обработка конфликтов merge/rebase с кнопками diff/abort/continue/позвать агента.
- Кэш help‑команд инструмента в `toolhelp.json`.
- Отдельное MTProto‑меню: задача отправляется в CLI, результат формируется в md‑файл и его содержимое отправляется в выбранный чат.
- Отправка файлов из рабочей директории через `/files`.
- Шаблоны задач (скрытая команда `/preset`).

## Быстрый старт
1) Установите зависимости:
```bash
pip install -r requirements.txt
```

2) Заполните `config.yaml`:
- `telegram.token`
- `telegram.whitelist_chat_ids`
- `defaults.workdir`
- при необходимости `openai_*` для автоматического создания summary ответов от CLI инструментов

3) Запустите бота:
```bash
python bot.py
```

## Рабочий процесс (рекомендуемый)
1) **Старт и выбор инструмента**
   - Откройте меню бота и выберите `/tools`, чтобы увидеть доступные CLI.
   - Создайте сессию через `/new` и выберите рабочую директорию.

2) **Отправка задачи**
   - Пишите задачу обычным сообщением — она уйдёт в активную сессию.
   - Если сообщение начинается с `/`, используйте `/send /команда` или `> /команда`.
   - Длинные сообщения склеиваются в буфер в течение 2 секунд; короткие (<3000) отправляются сразу.
- Вложения `.txt`, `.md`, `.rst`, `.log`, `.html`, `.htm` (до 500 КБ) отправляются сразу и объединяются с описанием.

3) **Контроль выполнения**
   - Если сессия занята, бот предложит: отменить, поставить в очередь или отменить ввод.
   - Статус активной сессии смотрите через `/status` или в меню `/sessions`.
   - Очередь можно проверить `/queue` и очистить `/clearqueue`.

4) **Работа с результатом**
   - Сначала приходит краткий анонс (summary или превью).
   - Полный результат отправляется HTML‑файлом — откройте его для просмотра.
   - При необходимости скачайте файлы из рабочей директории через `/files`.

5) **Сессии и продолжение**
   - Используйте `/sessions` для переключения, переименования или закрытия сессий.
   - Resume‑токен сохраняется и может быть восстановлен автоматически.

6) **Дополнительно**
   - Git‑операции доступны через `/git` (status, pull, diff, commit, summary и т.д.).
   - MTProto‑меню (`/mtproto`) отправляет задачу в CLI. CLI сохраняет результат в md‑файл (с timestamp), а бот отправляет содержимое в выбранный чат (до 12000 символов). Статус всегда приходит в бот.

## Конфигурация
`config.yaml` поддерживает:
- `tools.*`: команды запуска, режим, prompt/resume/help (включая `resume_cmd` для отдельных команд возобновления) и `image_cmd` (добавляется к базовой команде/resume_cmd для обработки изображений)
- `defaults.*`: базовый каталог, таймауты, пути к state/toolhelp, OpenAI настройки, `zai_api_key`/`tavily_api_key` для web‑поиска/reader, `github_token` для git по HTTPS
- `defaults.log_path`: путь к файлу логов бота
- `defaults.mtproto_output_dir`: каталог для md‑файлов результата MTProto (относительно workdir или абсолютный). Файлы создаются с timestamp в имени.
- `defaults.mtproto_cleanup_days`: удалять md‑файлы старше N дней (по умолчанию 5).
- `defaults.image_temp_dir`: каталог для временных изображений (относительно workdir или абсолютный).
- `defaults.image_max_mb`: лимит размера одного изображения (по умолчанию 10 МБ).
- `mtproto.*`: включение MTProto, `api_id/api_hash`, `session_string` или `session_path`, список `targets` для меню отправки
- `mcp.*`: TCP‑bridge для внешних клиентов (host/port/token)
- `presets`: список шаблонов задач (name + prompt)

Для каждого инструмента можно задать переменные окружения:
```yaml
tools:
  codex:
    env:
      OPENAI_API_KEY: "..."
      OPENAI_MODEL: "..."
```
Эти переменные будут добавлены к окружению процесса CLI.

Поддерживаются подстановки переменных окружения вида `${VAR}`.
Значения `null` игнорируются и не добавляются в окружение.

## YOLO/auto‑approve режим
В `config.yaml` включены авто‑одобрения:
- **Gemini CLI**: `--approval-mode yolo`
- **Qwen Code**: `--yolo`
- **Claude Code**: `--dangerously-skip-permissions`
- **Codex**: в интерактивном режиме отправляется `/approvals full`

OpenAI может быть задан как через `config.yaml`, так и через env:
- `OPENAI_API_KEY`
- `OPENAI_MODEL`
- `OPENAI_BASE_URL`

Переменные окружения имеют приоритет.

Z.AI для web‑поиска/reader:
- `defaults.zai_api_key` в `config.yaml`
- или env `ZAI_API_KEY` (имеет приоритет)

Tavily для web‑поиска/reader:
- `defaults.tavily_api_key` в `config.yaml`
- или env `TAVILY_API_KEY` (имеет приоритет)

GitHub токен (PAT) для git по HTTPS:
- `defaults.github_token` в `config.yaml` (используется для clone/fetch/pull/push, без интерактивных запросов)

MTProto:
- `mtproto.enabled` включает меню MTProto.
- `mtproto.api_id` и `mtproto.api_hash` — креденшелы Telegram API.
- `mtproto.session_string` (рекомендуется) или `mtproto.session_path` для авторизации.
- `mtproto.targets` — список целей (title + peer), которые появятся в меню.
Логика: сообщение из MTProto‑меню → выполняется в активной CLI‑сессии → CLI пишет md‑файл (timestamp) → бот отправляет его содержимое в выбранный чат (до 12000 символов), статус всегда приходит в бот.

## Вложения сообщений
- Текстовые вложения: `.txt`, `.md`, `.rst`, `.log`, `.html`, `.htm` (до 500 КБ). Бот объединяет подпись и содержимое файла и отправляет в CLI.
- Изображения: `.png`, `.jpg`, `.jpeg` (photo/document). Для обработки нужен `image_cmd` у выбранного CLI.
  Если у текущего инструмента нет `image_cmd`, бот сообщит, что изображения не поддерживаются.
  В качестве текста запроса используется подпись к изображению.

## Команды бота
### Видимые в меню Telegram
- `/new` — создать сессию (inline‑меню)
- `/sessions` — меню управления сессиями (use/status/rename/close/resume/state/queue/clearqueue)
- `/interrupt` — прервать генерацию
- `/git` — Git‑операции по активной сессии (inline‑меню: status/fetch/pull/merge/rebase/diff/log/stash/commit/push/summary/help)
- `/mtproto` — MTProto меню: отправить задачу в CLI и получить результат в выбранном чате
  - Если команда вызвана без текста, бот запросит задание (можно отправить `-` для отмены).
- `/files` — отправить файл из рабочей директории
- `/tools` — список инструментов
- `/toolhelp` — получить /команды выбранного инструмента
### Доступны, но скрыты из меню
- `/dirs` — просмотр каталогов (menu)
- `/newpath <path>` — задать путь после выбора инструмента
- `/use` — выбрать активную сессию (menu)
- `/cwd <path>` — создать сессию в каталоге
- `/setprompt <tool> <regex>` — установить prompt_regex для инструмента
- `/send <текст>` — отправить текст напрямую в CLI
- `/resume [token]` — показать/установить resume
- `/close` — закрыть сессию и удалить её из сохранённого состояния (menu)
- `/status` — статус активной сессии (busy, последняя активность/тик секундомера)
- `/rename <id> <name>` или `/rename <name>` — переименовать сессию
- `/state [tool path]` — состояние по tool+path или меню
- `/clearqueue` — очистить очередь активной сессии
- `/queue` — показать очередь
- `/preset` — шаблоны задач для CLI
- Шаблоны берутся из `config.yaml` (секция `presets`).
- `/metrics` — метрики бота

## Состояния
- `state.json` — последняя точка (resume + саммари) для tool+workdir
- `state.json` — также хранит последнюю активную сессию (tool+workdir)
- `state.json` — хранит список сессий (имя, очередь) для восстановления после перезапуска
- `toolhelp.json` — кэш справки /help для каждого инструмента

## Тесты
```bash
pytest -q
```

## Прямой ввод в CLI
Если нужно отправить строку, начинающуюся с `/`, используйте один из способов:
- `/send /help`
- Или префикс `>` в обычном сообщении: `> /help`
- `/state [tool path]` — состояние по tool+path или меню
