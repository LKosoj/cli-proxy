from __future__ import annotations

# NOTE: Manager mode uses defaults.openai_model for all LLM calls.


DECOMPOSE_INSTRUCTION = """## Задание: анализ проекта и декомпозиция задачи

### Цель пользователя:
{user_goal}

### Что от тебя требуется:
1. Кратко проанализируй текущее состояние проекта в рабочей директории (что уже есть, какие есть тесты/команды).
2. Предложи план разработки в виде списка задач (до {max_tasks}).
3. Для каждой задачи: заголовок, подробное описание (что сделать), критерии приёмки (что проверять), зависимости.

### Правила для задач:
- Задачи должны быть достаточно маленькими, чтобы их можно было сделать и проверить за 1 итерацию.
- Дай явные критерии приёмки (что должен проверить ревьюер).
- Если задача зависит от другой — явно укажи depends_on (id/номер).
- Не включай задачу "сформировать финальный ответ пользователю": финальный отчёт делает ManagerOrchestrator.

### Важно:
- НЕ пиши JSON. Пиши обычным текстом, но структурированно (заголовки/списки).
- Учти, что разработку будет делать CLI-инструмент, а проверку — агент-ревьюер.
"""


DECOMPOSE_NORMALIZE_SYSTEM = """Ты — нормализатор. Тебе дан свободный текст с анализом проекта и планом задач.
Преобразуй его в строго валидный JSON (без markdown, без комментариев) по схеме:
{
  "project_goal": "...",
  "analysis": {
    "current_state": "...",
    "already_done": ["..."],
    "remaining_work": ["..."]
  },
  "tasks": [
    {
      "id": "task_1",
      "title": "...",
      "description": "...",
      "acceptance_criteria": ["..."],
      "depends_on": ["task_0"]
    }
  ]
}
Правила:
- Максимум 10 задач. Если больше — укрупни/объедини.
- depends_on: список id задач.
- acceptance_criteria: минимум 2 пункта.
"""


DEV_INSTRUCTION_TEMPLATE = """## Задание на разработку

### Задача: {task_title}

### Описание:
{task_description}

### Критерии приёмки
{task_acceptance}

### Контекст проекта
{project_context}

### ⚠️ Замечания ревьюера (исправь обязательно):
{reviewer_comments}
"""


REVIEW_INSTRUCTION_TEMPLATE = """## Задание на ревью

### Задача: {task_title}

### Описание задачи (ТЗ):
{task_description}

### Критерии приёмки:
{task_acceptance}

### Отчёт разработчика:
{dev_report}

### Инструкции для ревью:
- Проверь соответствие критериям приёмки.
- Проверь, что изменения не ломают проект.
- По возможности запусти тесты (или хотя бы базовые команды), и отметь результат.
- Список просмотренных файлов укажи явно.

### Формат ответа (строго JSON):
{{
  "approved": true/false,
  "summary": "кратко",
  "comments": "подробно (если rejected — обязательно)",
  "tests_passed": true/false/null,
  "files_reviewed": ["path1", "path2"]
}}
"""


REVIEW_NORMALIZE_SYSTEM = """Тебе дан ответ ревьюера. Верни строго валидный JSON по схеме:
{
  "approved": true/false,
  "summary": "...",
  "comments": "...",
  "tests_passed": true/false/null,
  "files_reviewed": ["..."]
}
Если в ответе есть лишний текст/markdown — вырежи и нормализуй.
"""


DECISION_SYSTEM = """Ты — арбитр. Тебе даны: отчёт разработчика и результат ревью.
Верни строго JSON:
{"verdict": "approved" или "rejected", "reasons": ["причина1", "причина2"]}
Правила:
- Если ревьюер отклонил — verdict=rejected.
- Если ревьюер одобрил — verdict=approved.
"""


FINAL_REPORT_SYSTEM = """Ты — менеджер проекта. Сформируй итоговый отчёт для пользователя.

Правила:
- Не описывай внутренние процессы (ревью, попытки, инструменты).
- Перечисли, что было сделано.
- Если были проблемы/failed задачи — кратко укажи.
- Дай рекомендации по следующим шагам (если уместно).
- Формат: Markdown с заголовками и списками.
"""

