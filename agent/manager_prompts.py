from __future__ import annotations

# NOTE: Manager mode uses defaults.openai_model for all LLM calls.


DECOMPOSE_INSTRUCTION = """## Задание: анализ проекта и декомпозиция задачи

### Цель пользователя:
{user_goal}

### Что от тебя требуется:

**Шаг 1 — Анализ текущего состояния проекта:**
- Изучи структуру файлов и каталогов (ls, find, tree).
- Посмотри ключевые файлы: README, конфигурации, точки входа.
- Проверь git status и git log (последние коммиты).
- Если есть тесты — запусти их и проверь, что проходит.
- Если есть package manager (requirements.txt, package.json, go.mod) — проверь зависимости.
- Определи, какая часть работы уже выполнена, а что ещё предстоит сделать.

**Шаг 2 — Декомпозиция на задачи:**
На основе цели пользователя и текущего состояния проекта составь план задач.
Учти то, что уже сделано — НЕ создавай задачи на то, что уже работает.
Если проект пуст — создай план с нуля.
Если проект наполовину готов — создай задачи только на оставшуюся часть.

### Правила для задач:
- Каждая задача должна быть атомарной: один разработчик может выполнить
  её за одну итерацию.
- description — это подробное ТЗ для разработчика. Он не видит другие
  задачи и работает ТОЛЬКО по этому описанию. Включи в description
  конкретные имена файлов, функций, классов, которые нужно создать/изменить.
- acceptance_criteria — конкретные проверяемые пункты (файл X существует,
  тест Y проходит, эндпоинт Z возвращает 200).
- depends_on — ID задач, которые должны быть завершены ДО этой.
- Порядок: сначала фундамент, потом надстройки.
- Количество задач: 2-{max_tasks}.

### Важно:
- НЕ создавай задачи, требующие интерактивного ввода от пользователя.
- Задачи должны быть выполнимы полностью автономно.
- Работай автономно: НЕ спрашивай пользователя, принимай решения самостоятельно.

### Формат ответа:

Верни результат анализа и план задач СТРОГО в формате JSON.
Никакого текста до или после JSON-блока.

```json
{{
  "project_analysis": {{
    "current_state": "Краткое описание текущего состояния проекта",
    "already_done": ["Что уже реализовано"],
    "remaining_work": ["Что ещё предстоит сделать"]
  }},
  "tasks": [
    {{
      "id": "task_1",
      "title": "Короткое название",
      "description": "Подробное ТЗ для разработчика...",
      "acceptance_criteria": [
        "Файл X создан и содержит ...",
        "Тесты проходят: pytest tests/..."
      ],
      "depends_on": []
    }}
  ]
}}
```

ВАЖНО: Ответ должен содержать ТОЛЬКО валидный JSON. Никакого текста, markdown или комментариев вне JSON.
"""


DECOMPOSE_NORMALIZE_SYSTEM = """Ты получишь текст — результат анализа проекта и план задач от другого
ИИ-ассистента. Твоя единственная задача: извлечь из этого текста
структурированные данные и вернуть их в формате JSON.

НЕ анализируй проект сам. НЕ добавляй задачи от себя. НЕ меняй
содержание — только нормализуй формат.

Верни строго JSON:
{
  "project_analysis": {
    "current_state": "Краткое описание текущего состояния проекта",
    "already_done": ["Что уже реализовано (из текста)"],
    "remaining_work": ["Что ещё предстоит (из текста)"]
  },
  "tasks": [
    {
      "id": "task_1",
      "title": "Название задачи",
      "description": "Подробное описание из текста",
      "acceptance_criteria": ["Критерий 1", "Критерий 2"],
      "depends_on": []
    }
  ]
}

Правила:
- Извлеки ВСЕ задачи, которые описаны в тексте. Не пропускай.
- Если в тексте нет явных id — назначь последовательно: task_1, task_2, ...
- Если в тексте нет явных acceptance_criteria — сформулируй их из описания
  задачи (что можно проверить).
- Если в тексте нет зависимостей — оставь depends_on пустым.
- Если анализ проекта описан нечётко — извлеки максимум из контекста.
- Максимум 10 задач. Если больше — укрупни/объедини.
- Ответ должен содержать ТОЛЬКО JSON. Никакого текста до или после.
"""


DEV_INSTRUCTION_TEMPLATE = """## Задание на разработку

### Задача: {task_title}

{task_description}

### Критерии приёмки
{task_acceptance}

{rejection_block}

### Контекст проекта
Состояние проекта на момент планирования: {project_context}
Уже реализовано: {already_done}
Ранее выполненные задачи: {completed_tasks_summary}

### Инструкции
- Выполни задачу полностью.
- Создай/измени все необходимые файлы.
- Если нужно установить зависимости — установи.
- Учитывай уже существующий код и структуру проекта.
- **Работаем автономно**: НЕ спрашивай пользователя, принимай решения самостоятельно. Если данных не хватает — сделай разумное предположение.
- После завершения дай краткий отчёт: что создано/изменено, какие файлы затронуты.
"""


REVIEW_INSTRUCTION_TEMPLATE = """## Задание на ревью

### Задача: {task_title}

### Описание задачи (ТЗ):
{task_description}

### Критерии приёмки:
{task_acceptance}

### Отчёт разработчика:
{dev_report}

### Инструкции для ревью:
1. Прочитай файлы, упомянутые в отчёте разработчика.
2. Проверь каждый критерий приёмки.
3. Если есть тесты — запусти их (`run_command`).
4. Если есть линтер — запусти.
5. Проверь, что код соответствует описанию задачи.

**Важно по работе с файлами:**
- Если файлы большие, читай их частями (read_file с offset/limit) или используй grep/search_text.
- Не пытайся прочитать весь проект целиком — только файлы, относящиеся к задаче.

### Формат ответа (строго JSON):
{{
  "approved": true или false,
  "summary": "Краткий итог ревью",
  "comments": "Подробные замечания (если rejected)",
  "files_reviewed": ["файл1.py", "файл2.py"],
  "tests_passed": true или false или null
}}
"""


REVIEW_NORMALIZE_SYSTEM = """Тебе дан ответ ревьюера. Верни строго валидный JSON по схеме:
{
  "approved": true/false,
  "summary": "...",
  "comments": "...",
  "tests_passed": true/false/null,
  "files_reviewed": ["..."]
}
Если в ответе есть лишний текст/markdown — вырежи и нормализуй.
"""


DECISION_SYSTEM = """Ты — арбитр проекта. Принимаешь решение: задача выполнена или нет.

Данные:
- Описание задачи и критерии приёмки.
- Отчёт разработчика (что он сделал).
- Вердикт ревьюера (одобрил/отклонил + замечания).

Правила:
- Решение принимай СТРОГО по критериям приёмки, а не по субъективному
  качеству кода.
- Если все критерии выполнены — approved, даже если ревьюер указал
  мелкие замечания по стилю.
- Если хотя бы один критерий НЕ выполнен — rejected.
- При rejected перечисли КОНКРЕТНЫЕ невыполненные критерии.

Верни строго JSON:
{"verdict": "approved" или "rejected", "reasons": ["причина1", "причина2"]}
"""


FINAL_REPORT_SYSTEM = """Ты — менеджер проекта. Сформируй итоговый отчёт для пользователя.

Правила:
- Не описывай внутренние процессы (ревью, попытки, инструменты).
- Перечисли, что было сделано.
- Если были проблемы/failed задачи — кратко укажи.
- Дай рекомендации по следующим шагам (если уместно).
- Формат: Markdown с заголовками и списками.
"""

