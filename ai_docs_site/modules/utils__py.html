<!DOCTYPE html>

<html data-bs-theme="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<title>utils.py - cli-proxy</title>
<link href="../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../css/fontawesome.min.css" rel="stylesheet"/>
<link href="../css/brands.min.css" rel="stylesheet"/>
<link href="../css/solid.min.css" rel="stylesheet"/>
<link href="../css/v4-font-face.min.css" rel="stylesheet"/>
<link href="../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" id="hljs-light" rel="stylesheet"/>
<link disabled="" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" id="hljs-dark" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../index.html">cli-proxy</a>
<!-- Expander button -->
<button aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar-collapse" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="nav-item">
<a class="nav-link" href="../index.html">Главная</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../architecture.html">Архитектура</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../runtime.html">Запуск</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../dependencies.html">Зависимости</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../testing.html">Тестирование</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../conventions.html">Соглашения</a>
</li>
<li class="nav-item">
<a class="nav-link" href="../glossary.html">Глоссарий</a>
</li>
<li class="nav-item dropdown">
<a aria-expanded="false" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button">Конфигурация проекта</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../configs/index.html">Обзор</a>
</li>
<li>
<a class="dropdown-item" href="../configs/files/config_example__yaml.html">config_example.yaml</a>
</li>
<li>
<a class="dropdown-item" href="../configs/files/toolhelp__json.html">toolhelp.json</a>
</li>
</ul>
</li>
<li class="nav-item dropdown">
<a aria-current="page" aria-expanded="false" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button">Модули</a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="index.html">Обзор</a>
</li>
<li>
<a class="dropdown-item" href="bot__py.html">bot.py</a>
</li>
<li>
<a class="dropdown-item" href="command_registry__py.html">command_registry.py</a>
</li>
<li>
<a class="dropdown-item" href="config__py.html">config.py</a>
</li>
<li>
<a class="dropdown-item" href="dirs_ui__py.html">dirs_ui.py</a>
</li>
<li>
<a class="dropdown-item" href="git_ops__py.html">git_ops.py</a>
</li>
<li>
<a class="dropdown-item" href="mcp_bridge__py.html">mcp_bridge.py</a>
</li>
<li>
<a class="dropdown-item" href="metrics__py.html">metrics.py</a>
</li>
<li>
<a class="dropdown-item" href="mtproto_ui__py.html">mtproto_ui.py</a>
</li>
<li>
<a class="dropdown-item" href="session__py.html">session.py</a>
</li>
<li>
<a class="dropdown-item" href="session_ui__py.html">session_ui.py</a>
</li>
<li>
<a class="dropdown-item" href="state__py.html">state.py</a>
</li>
<li>
<a class="dropdown-item" href="summary__py.html">summary.py</a>
</li>
<li>
<a class="dropdown-item" href="toolhelp__py.html">toolhelp.py</a>
</li>
<li>
<a aria-current="page" class="dropdown-item active" href="utils__py.html">utils.py</a>
</li>
</ul>
</li>
<li class="nav-item">
<a class="nav-link" href="../changes.html">Изменения</a>
</li>
</ul>
<ul class="nav navbar-nav ms-md-auto">
<li class="nav-item">
<a class="nav-link" data-bs-target="#mkdocs_search_modal" data-bs-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="toolhelp__py.html" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../changes.html" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-bs-target="#toc-collapse" data-bs-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-body-tertiary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-bs-level="1"><a class="nav-link" href="#utils">utils</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="utils">utils</h1>
<p>Модуль предоставляет инструменты для обработки текста, содержащего ANSI-коды, Markdown и Mermaid-диаграммы, с последующей конвертацией в HTML. Основное назначение — преобразование терминального вывода (например, логов) в читаемый HTML-формат с сохранением цветового форматирования и визуализацией диаграмм. Поддерживаются фильтрация служебных строк, удаление дубликатов блоков и извлечение временных меток.</p>
<p>Ключевые структуры данных<br/>
_ANSI_FG_COLORS — словарь, сопоставляющий коды цветов ANSI с соответствующими CSS-цветами (не экспортируется напрямую, используется внутри функций)</p>
<p>strip_ansi(text)
Удаляет ANSI-escape последовательности из строки.
Аргументы
text — входной текст с возможными ANSI-кодами
Возвращает
текст без ANSI-кодов
Исключения
не выбрасывает</p>
<hr/>
<p>has_ansi(text)
Проверяет, содержит ли строка ANSI-коды.
Аргументы
text — входной текст
Возвращает
True, если найдены ANSI-коды, иначе False
Исключения
не выбрасывает</p>
<hr/>
<p>extract_tick_tokens(text)
Извлекает временные метки и тики (например, "12:34:56" или "5s") из текста.
Аргументы
text — входной текст
Возвращает
список найденных временных меток
Исключения
не выбрасывает</p>
<hr/>
<p>ansi_to_html(text)
Преобразует текст с ANSI-кодами в полноценный HTML-документ с поддержкой Markdown и Mermaid.
Аргументы
text — входной текст с ANSI-кодами и разметкой
Возвращает
валидный HTML-документ как строку
Исключения
не выбрасывает</p>
<hr/>
<p>_normalize_text(text, strip_ansi)
Нормализует текст: удаляет ANSI, фильтрует MCP-строки, устраняет повторяющиеся блоки.
Аргументы
text — исходный текст
strip_ansi — флаг, указывающий, нужно ли удалять ANSI-коды
Возвращает
нормализованный текст
Исключения
не выбрасывает</p>
<hr/>
<p>strip_ansi_codes(text)
Удаляет ANSI-коды из текста (синоним strip_ansi).
Аргументы
text — текст для обработки
Возвращает
текст без ANSI-кодов
Исключения
не выбрасывает</p>
<hr/>
<p>_remove_mcp_lines(text)
Удаляет строки между первым вхождением "mcp:" и строкой "mcp startup:".
Аргументы
text — входной текст построчно
Возвращает
текст без MCP-блоков
Исключения
не выбрасывает</p>
<hr/>
<p>_dedupe_repeated_blocks(text)
Удаляет последовательные повторяющиеся блоки строк.
Аргументы
text — входной текст
Возвращает
текст без дублирующихся блоков
Исключения
не выбрасывает</p>
<hr/>
<p>_render_mermaid_svg(source)
Преобразует Mermaid-диаграмму в SVG через внешний сервис mermaid.ink.
Аргументы
source — исходный код диаграммы Mermaid
Возвращает
SVG-разметку как строку или None при ошибке
Исключения
не выбрасывает</p>
<hr/>
<p>_apply_ansi_to_html(html_text)
Применяет цветовое форматирование ANSI к HTML-тексту.
Аргументы
html_text — HTML-текст с ANSI-кодами в текстовых узлах
Возвращает
HTML с добавленным стилем для ANSI-цветов
Исключения
не выбрасывает</p>
<hr/>
<p>_ansi_to_html_fragment(text)
Конвертирует фрагмент текста с ANSI-кодами в HTML с цветами.
Аргументы
text — текстовый фрагмент с ANSI-кодами
Возвращает
HTML-фрагмент с тегами <span> и стилями
Исключения
не выбрасывает</span></p>
<hr/>
<p>_span()
Обновляет HTML-тег <span> в выходном потоке в зависимости от текущего стиля и состояния открытия тега
Аргументы
Нет аргументов
Возвращает
Нет возвращаемого значения
Исключения
Нет исключений</span></p>
<hr/>
<p>build_command(cmd_template: List[str], prompt: str, resume: Optional[str] = None, image: Optional[str] = None) -&gt; Tuple[List[str], bool]
Формирует команду из шаблона с подстановкой значений {prompt}, {resume}, {image} и управлением флагами
Аргументы
cmd_template — шаблон команды в виде списка строк
prompt — текст запроса для подстановки вместо {prompt}
resume — идентификатор возобновления диалога (опционально)
image — путь к изображению для подстановки (опционально)
Возвращает
Кортеж из списка строк (готовая команда) и флага, указывающего, нужно ли передавать prompt через stdin
Исключения
Нет исключений</p>
<hr/>
<p>detect_prompt_regex(lines: List[str]) -&gt; Optional[str]
Определяет регулярное выражение для поиска приглашения ввода на основе анализа последних строк
Аргументы
lines — список строк вывода с возможной ANSI-разметкой
Возвращает
Строку с регулярным выражением, если приглашение обнаружено, иначе None
Исключения
Нет исключений</p>
<hr/>
<p>detect_resume_regex(text: str) -&gt; Optional[str]
Обнаруживает в тексте шаблоны, указывающие на наличие идентификатора сессии, и возвращает соответствующее регулярное выражение
Аргументы
text — текст для анализа (возможно, с ANSI-разметкой)
Возвращает
Строку с регулярным выражением для извлечения идентификатора сессии, если найдено, иначе None
Исключения
Нет исключений</p>
<hr/>
<p>make_html_file(html_text: str, prefix: str) -&gt; str
Создаёт временный HTML-файл с указанным содержимым и возвращает путь к нему
Аргументы
html_text — содержимое HTML-страницы
prefix — префикс для имени временного файла
Возвращает
Путь к созданному временному HTML-файлу
Исключения
Может выбросить исключение при ошибках ввода-вывода (не перехватывается)</p>
<hr/>
<p>build_preview(text: str, max_chars: int) -&gt; str
Формирует краткий текстовый превью заданной длины, удаляя ANSI-разметку
Аргументы
text — исходный текст, возможно, с ANSI-разметкой
max_chars — максимальное количество символов в превью
Возвращает
Обрезанный до max_chars текст без ANSI-разметки
Исключения
Нет исключений</p>
<hr/>
<p>escape_html_text(text: str) -&gt; str
Экранирует специальные HTML-символы в строке
Аргументы
text — строка для экранирования
Возвращает
Экранированная строка, безопасная для вставки в HTML
Исключения
Нет исключений</p>
<hr/>
<p>is_within_root(path: str, root: str) -&gt; bool
Проверяет, находится ли путь внутри заданного корневого каталога (защита от выхода за пределы)
Аргументы
path — проверяемый путь
root — корневой каталог
Возвращает
True, если путь находится внутри root, иначе False
Исключения
Возвращает False при любых ошибках (например, доступе к файловой системе)</p>
<hr/>
<p>resolve_env_value(value: Optional[str]) -&gt; Optional[str]
Раскрывает переменные окружения в строке с помощью os.path.expandvars
Аргументы
value — строка с переменными окружения (например, $HOME), может быть None
Возвращает
Строка с раскрытыми переменными окружения или None, если входное значение None
Исключения
Нет исключений</p></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script src="../js/bootstrap.bundle.min.js"></script>
<script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script src="../js/base.js"></script>
<script src="../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
