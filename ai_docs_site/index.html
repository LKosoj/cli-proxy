
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="architecture.html" rel="next"/>
<link href="assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>cli-proxy</title>
<link href="assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="cli-proxy" class="md-header__button md-logo" data-md-component="logo" href="index.html" title="cli-proxy">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            cli-proxy
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Главная
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="cli-proxy" class="md-nav__button md-logo" data-md-component="logo" href="index.html" title="cli-proxy">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    cli-proxy
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    
  
    Главная
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="index.html">
<span class="md-ellipsis">
    
  
    Главная
  

    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        Обзор архитектуры
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        Основные компоненты
      
    </span>
</a>
<nav aria-label="Основные компоненты" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#botapp">
<span class="md-ellipsis">
      
        BotApp
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sessionmanager">
<span class="md-ellipsis">
      
        SessionManager
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#session">
<span class="md-ellipsis">
      
        Session
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sessionui">
<span class="md-ellipsis">
      
        SessionUI
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gitops">
<span class="md-ellipsis">
      
        GitOps
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mtprotoui">
<span class="md-ellipsis">
      
        MTProtoUI
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mcpbridge">
<span class="md-ellipsis">
      
        MCPBridge
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configyaml">
<span class="md-ellipsis">
      
        Конфигурация (config.yaml)
      
    </span>
</a>
<nav aria-label="Конфигурация (config.yaml)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#telegram">
<span class="md-ellipsis">
      
        Telegram
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        Инструменты
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        Пути и лимиты
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mtproto">
<span class="md-ellipsis">
      
        MTProto
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mcp">
<span class="md-ellipsis">
      
        MCP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#presets">
<span class="md-ellipsis">
      
        Presets
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        Работа с файлами
      
    </span>
</a>
<nav aria-label="Работа с файлами" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        Поддерживаемые типы
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        Безопасность
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        Обработка вывода
      
    </span>
</a>
<nav aria-label="Обработка вывода" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ansi-html">
<span class="md-ellipsis">
      
        ANSI → HTML
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#markdown-html">
<span class="md-ellipsis">
      
        Markdown → HTML
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mermaid">
<span class="md-ellipsis">
      
        Mermaid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        Буферизация
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        Состояние и данные
      
    </span>
</a>
<nav aria-label="Состояние и данные" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#statejson">
<span class="md-ellipsis">
      
        state.json
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#toolhelpjson">
<span class="md-ellipsis">
      
        toolhelp.json
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        Запуск и тестирование
      
    </span>
</a>
<nav aria-label="Запуск и тестирование" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        Установка зависимостей
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        Запуск
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        Тестирование
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        Безопасность
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        Дорожная карта
      
    </span>
</a>
<nav aria-label="Дорожная карта" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1">
<span class="md-ellipsis">
      
        Фаза 1: Надёжность
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2">
<span class="md-ellipsis">
      
        Фаза 2: Интеграции
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3">
<span class="md-ellipsis">
      
        Фаза 3: Масштабирование
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="architecture.html">
<span class="md-ellipsis">
    
  
    Архитектура
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="runtime.html">
<span class="md-ellipsis">
    
  
    Запуск
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="dependencies.html">
<span class="md-ellipsis">
    
  
    Зависимости
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="testing.html">
<span class="md-ellipsis">
    
  
    Тестирование
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="conventions.html">
<span class="md-ellipsis">
    
  
    Соглашения
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="glossary.html">
<span class="md-ellipsis">
    
  
    Глоссарий
  

    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Конфигурация проекта
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            
  
    Конфигурация проекта
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="configs/index.html">
<span class="md-ellipsis">
    
  
    Обзор
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="configs/files/config_example__yaml.html">
<span class="md-ellipsis">
    
  
    config_example.yaml
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="configs/files/toolhelp__json.html">
<span class="md-ellipsis">
    
  
    toolhelp.json
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
<span class="md-ellipsis">
    
  
    Модули
  

    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
            
  
    Модули
  

          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="modules/index.html">
<span class="md-ellipsis">
    
  
    Обзор
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/bot__py.html">
<span class="md-ellipsis">
    
  
    bot.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/command_registry__py.html">
<span class="md-ellipsis">
    
  
    command_registry.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/config__py.html">
<span class="md-ellipsis">
    
  
    config.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/dirs_ui__py.html">
<span class="md-ellipsis">
    
  
    dirs_ui.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/git_ops__py.html">
<span class="md-ellipsis">
    
  
    git_ops.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/mcp_bridge__py.html">
<span class="md-ellipsis">
    
  
    mcp_bridge.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/metrics__py.html">
<span class="md-ellipsis">
    
  
    metrics.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/mtproto_ui__py.html">
<span class="md-ellipsis">
    
  
    mtproto_ui.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/session__py.html">
<span class="md-ellipsis">
    
  
    session.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/session_ui__py.html">
<span class="md-ellipsis">
    
  
    session_ui.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/state__py.html">
<span class="md-ellipsis">
    
  
    state.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/summary__py.html">
<span class="md-ellipsis">
    
  
    summary.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/toolhelp__py.html">
<span class="md-ellipsis">
    
  
    toolhelp.py
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="modules/utils__py.html">
<span class="md-ellipsis">
    
  
    utils.py
  

    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="changes.html">
<span class="md-ellipsis">
    
  
    Изменения
  

    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      
        Обзор архитектуры
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      
        Основные компоненты
      
    </span>
</a>
<nav aria-label="Основные компоненты" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#botapp">
<span class="md-ellipsis">
      
        BotApp
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sessionmanager">
<span class="md-ellipsis">
      
        SessionManager
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#session">
<span class="md-ellipsis">
      
        Session
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#sessionui">
<span class="md-ellipsis">
      
        SessionUI
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gitops">
<span class="md-ellipsis">
      
        GitOps
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mtprotoui">
<span class="md-ellipsis">
      
        MTProtoUI
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mcpbridge">
<span class="md-ellipsis">
      
        MCPBridge
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configyaml">
<span class="md-ellipsis">
      
        Конфигурация (config.yaml)
      
    </span>
</a>
<nav aria-label="Конфигурация (config.yaml)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#telegram">
<span class="md-ellipsis">
      
        Telegram
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_4">
<span class="md-ellipsis">
      
        Инструменты
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_5">
<span class="md-ellipsis">
      
        Пути и лимиты
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mtproto">
<span class="md-ellipsis">
      
        MTProto
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mcp">
<span class="md-ellipsis">
      
        MCP
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#presets">
<span class="md-ellipsis">
      
        Presets
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_6">
<span class="md-ellipsis">
      
        Работа с файлами
      
    </span>
</a>
<nav aria-label="Работа с файлами" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_7">
<span class="md-ellipsis">
      
        Поддерживаемые типы
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_8">
<span class="md-ellipsis">
      
        Безопасность
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_9">
<span class="md-ellipsis">
      
        Обработка вывода
      
    </span>
</a>
<nav aria-label="Обработка вывода" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ansi-html">
<span class="md-ellipsis">
      
        ANSI → HTML
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#markdown-html">
<span class="md-ellipsis">
      
        Markdown → HTML
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#mermaid">
<span class="md-ellipsis">
      
        Mermaid
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_10">
<span class="md-ellipsis">
      
        Буферизация
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_11">
<span class="md-ellipsis">
      
        Состояние и данные
      
    </span>
</a>
<nav aria-label="Состояние и данные" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#statejson">
<span class="md-ellipsis">
      
        state.json
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#toolhelpjson">
<span class="md-ellipsis">
      
        toolhelp.json
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_12">
<span class="md-ellipsis">
      
        Запуск и тестирование
      
    </span>
</a>
<nav aria-label="Запуск и тестирование" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#_13">
<span class="md-ellipsis">
      
        Установка зависимостей
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_14">
<span class="md-ellipsis">
      
        Запуск
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_15">
<span class="md-ellipsis">
      
        Тестирование
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_16">
<span class="md-ellipsis">
      
        Безопасность
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_17">
<span class="md-ellipsis">
      
        Дорожная карта
      
    </span>
</a>
<nav aria-label="Дорожная карта" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1">
<span class="md-ellipsis">
      
        Фаза 1: Надёжность
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2">
<span class="md-ellipsis">
      
        Фаза 2: Интеграции
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3">
<span class="md-ellipsis">
      
        Фаза 3: Масштабирование
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="_1">Документация проекта</h1>
<h2 id="_2">Обзор архитектуры</h2>
<p><code>cli-proxy</code> — это автономный Telegram-бот для управления CLI-сессиями с ИИ-инструментами (Codex, Claude, Gemini, Qwen и др.). Работает в режиме polling, не требует внешних серверов или туннелей. Обеспечивает глубокую интеграцию с локальной средой: файловой системой, Git, MTProto, OpenAI.</p>
<p>Ключевые особенности:
- Управление сессиями через inline-меню
- Поддержка headless и интерактивных режимов
- Автовосстановление сессий после перезапуска
- HTML-рендеринг вывода с поддержкой ANSI, Markdown, Mermaid
- Работа с файлами и изображениями
- Git-операции через Telegram
- MCP-совместимость (опционально)</p>
<hr/>
<h2 id="_3">Основные компоненты</h2>
<h3 id="botapp"><code>BotApp</code></h3>
<p>Центральный класс бота. Управляет:
- Обработкой команд и сообщений
- Сессиями через <code>SessionManager</code>
- Интерактивными меню (<code>SessionUI</code>, <code>DirsUI</code>, <code>GitOps</code>)
- Интеграциями: MTProto, MCP, OpenAI</p>
<p><strong>Инициализация</strong>:
<div class="highlight"><pre><span></span><code><span class="n">app</span> <span class="o">=</span> <span class="n">BotApp</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">build_app</span><span class="p">()</span>  <span class="c1"># настройка обработчиков</span>
<span class="n">app</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>       <span class="c1"># запуск polling</span>
</code></pre></div></p>
<hr/>
<h3 id="sessionmanager"><code>SessionManager</code></h3>
<p>Управляет жизненным циклом сессий. Гарантирует потокобезопасность через <code>run_lock</code>.</p>
<p><strong>Функции</strong>:
- Создание/удаление сессий
- Переключение активной сессии
- Восстановление сессий из <code>state.json</code>
- Контроль очереди команд</p>
<p><strong>Восстановление</strong>:
<div class="highlight"><pre><span></span><code><span class="n">sessions</span> <span class="o">=</span> <span class="n">restore_sessions</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">state_path</span><span class="p">)</span>
</code></pre></div>
Загружает сессии из <code>state.json</code>, восстанавливает <code>resume_token</code>, очередь, активную сессию.</p>
<hr/>
<h3 id="session"><code>Session</code></h3>
<p>Инкапсулирует состояние CLI-сессии. Работает через <code>pexpect</code> и <code>asyncio</code>.</p>
<p><strong>Режимы</strong>:
- <code>headless</code>: однократный запуск команды
- <code>interactive</code>: постоянная сессия с поддержкой <code>resume</code></p>
<p><strong>Ключевые параметры</strong>:
- <code>tool</code>: имя инструмента (codex, claude и т.д.)
- <code>workdir</code>: рабочая директория
- <code>resume_token</code>: токен для возобновления
- <code>image_cmd</code>: обработка изображений</p>
<p><strong>Обнаружение состояния</strong>:
- <code>prompt_regex</code> — определяет готовность сессии
- <code>resume_regex</code> — извлекает токен из вывода
- "Тик-токены" — активность в выводе</p>
<hr/>
<h3 id="sessionui"><code>SessionUI</code></h3>
<p>Предоставляет интерфейс управления сессиями через Telegram.</p>
<p><strong>Функции</strong>:
- <code>build_sessions_menu()</code> — список сессий с индикаторами:
  - Занятость
  - Git-состояние
  - Время работы
  - Длина очереди
- Обработка колбэков: выбор, активация, переименование, изменение <code>resume_token</code>
- Управление очередью: просмотр, очистка</p>
<p><strong>Ожидание ввода</strong>:
- <code>pending_session_rename</code> — ожидание нового имени
- <code>pending_session_resume</code> — ожидание нового токена
- Поддержка отмены: <code>-</code>, <code>отмена</code></p>
<hr/>
<h3 id="gitops"><code>GitOps</code></h3>
<p>Интеграция Git-операций в Telegram.</p>
<p><strong>Поддерживаемые операции</strong>:
- <code>status</code>, <code>log</code>, <code>diff</code>, <code>summary</code>
- <code>fetch</code>, <code>pull</code> (с <code>--ff-only</code>), <code>push</code>
- <code>commit</code> с подтверждением
- <code>merge</code>, <code>rebase</code>, <code>stash</code>
- Работа с конфликтами: просмотр, <code>abort</code>, <code>continue</code></p>
<p><strong>Безопасность</strong>:
- Аутентификация через <code>GIT_ASKPASS</code> (токен не в истории)
- Подтверждение всех операций
- Автоопределение upstream-ветки</p>
<p><strong>Интеграции</strong>:
- Генерация сообщений коммита через OpenAI
- HTML-справка из <code>git.md</code></p>
<hr/>
<h3 id="mtprotoui"><code>MTProtoUI</code></h3>
<p>Интерфейс для отправки сообщений в Telegram-чаты через MTProto (Telethon).</p>
<p><strong>Требования</strong>:
<div class="highlight"><pre><span></span><code><span class="nt">mtproto</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">api_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12345</span>
<span class="w">  </span><span class="nt">api_hash</span><span class="p">:</span><span class="w"> </span><span class="s">"abcde"</span>
<span class="w">  </span><span class="nt">session_string</span><span class="p">:</span><span class="w"> </span><span class="s">"12345:abcdef..."</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">"Сохранённые"</span>
<span class="w">      </span><span class="nt">peer</span><span class="p">:</span><span class="w"> </span><span class="s">"me"</span>
</code></pre></div></p>
<p><strong>Функции</strong>:
- <code>show_menu()</code> — выбор цели
- <code>request_task()</code> — ввод сообщения
- <code>send_text()</code>, <code>send_file()</code> — отправка
- Поддержка отмены</p>
<hr/>
<h3 id="mcpbridge"><code>MCPBridge</code></h3>
<p>TCP-сервер для внешних клиентов (MCP-совместимость).</p>
<p><strong>Запрос</strong>:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"secret"</span><span class="p">,</span><span class="w"> </span><span class="nt">"prompt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ls -la"</span><span class="p">,</span><span class="w"> </span><span class="nt">"session_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"codex::/work"</span><span class="p">}</span>
</code></pre></div></p>
<p><strong>Ответ</strong>:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">"ok"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nt">"output"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file1.txt\nfile2.txt"</span><span class="p">}</span>
</code></pre></div></p>
<p><strong>Настройки</strong>:
<div class="highlight"><pre><span></span><code><span class="nt">mcp</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">"127.0.0.1"</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">"secret"</span>
</code></pre></div></p>
<hr/>
<h2 id="configyaml">Конфигурация (<code>config.yaml</code>)</h2>
<h3 id="telegram">Telegram</h3>
<div class="highlight"><pre><span></span><code><span class="nt">telegram</span><span class="p">:</span>
<span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">"BOT_TOKEN"</span>
<span class="w">  </span><span class="nt">whitelist_chat_ids</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">123456789</span><span class="p p-Indicator">]</span>
</code></pre></div>
<h3 id="_4">Инструменты</h3>
<div class="highlight"><pre><span></span><code><span class="nt">tools</span><span class="p">:</span>
<span class="w">  </span><span class="nt">codex</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">headless</span>
<span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s">"codex</span><span class="nv"> </span><span class="s">'{prompt}'"</span>
<span class="w">    </span><span class="nt">resume_cmd</span><span class="p">:</span><span class="w"> </span><span class="s">"codex</span><span class="nv"> </span><span class="s">--thread</span><span class="nv"> </span><span class="s">{resume}"</span>
<span class="w">    </span><span class="nt">resume_regex</span><span class="p">:</span><span class="w"> </span><span class="s">"thread_id=([a-f0-9]+)"</span>
<span class="w">    </span><span class="nt">env</span><span class="p">:</span>
<span class="w">      </span><span class="nt">OPENAI_API_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">"${OPENAI_API_KEY}"</span>
</code></pre></div>
<h3 id="_5">Пути и лимиты</h3>
<div class="highlight"><pre><span></span><code><span class="nt">defaults</span><span class="p">:</span>
<span class="w">  </span><span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="s">"/home/user/work"</span>
<span class="w">  </span><span class="nt">state_path</span><span class="p">:</span><span class="w"> </span><span class="s">"state.json"</span>
<span class="w">  </span><span class="nt">log_path</span><span class="p">:</span><span class="w"> </span><span class="s">"bot.log"</span>
<span class="w">  </span><span class="nt">image_temp_dir</span><span class="p">:</span><span class="w"> </span><span class="s">"/tmp/images"</span>
<span class="w">  </span><span class="nt">image_max_mb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">idle_timeout_sec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div>
<h3 id="mtproto">MTProto</h3>
<div class="highlight"><pre><span></span><code><span class="nt">mtproto</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">api_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12345</span>
<span class="w">  </span><span class="nt">api_hash</span><span class="p">:</span><span class="w"> </span><span class="s">"abcde"</span>
<span class="w">  </span><span class="nt">session_string</span><span class="p">:</span><span class="w"> </span><span class="s">"..."</span>
<span class="w">  </span><span class="nt">targets</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">"Me"</span>
<span class="w">      </span><span class="nt">peer</span><span class="p">:</span><span class="w"> </span><span class="s">"me"</span>
</code></pre></div>
<h3 id="mcp">MCP</h3>
<div class="highlight"><pre><span></span><code><span class="nt">mcp</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">"127.0.0.1"</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="s">"secret"</span>
</code></pre></div>
<h3 id="presets">Presets</h3>
<div class="highlight"><pre><span></span><code><span class="nt">presets</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tests</span><span class="p">:</span><span class="w"> </span><span class="s">"Run</span><span class="nv"> </span><span class="s">all</span><span class="nv"> </span><span class="s">tests"</span>
<span class="w">  </span><span class="nt">lint</span><span class="p">:</span><span class="w"> </span><span class="s">"Check</span><span class="nv"> </span><span class="s">code</span><span class="nv"> </span><span class="s">style"</span>
</code></pre></div>
<hr/>
<h2 id="_6">Работа с файлами</h2>
<h3 id="_7">Поддерживаемые типы</h3>
<ul>
<li><strong>Текстовые</strong> (до 300 КБ): вставляются в промпт</li>
<li><strong>Изображения</strong>: обрабатываются через <code>image_cmd</code>, запрос из подписи</li>
</ul>
<h3 id="_8">Безопасность</h3>
<ul>
<li>Проверка <code>is_within_root()</code> — защита от выхода за пределы <code>workdir</code></li>
<li>Ограничение размера: <code>image_max_mb</code></li>
<li>Проверка MIME-типов</li>
</ul>
<hr/>
<h2 id="_9">Обработка вывода</h2>
<h3 id="ansi-html">ANSI → HTML</h3>
<ul>
<li>Цвета, жирный текст через <code>&lt;span&gt;</code></li>
<li>Использует <code>ansi2html</code></li>
</ul>
<h3 id="markdown-html">Markdown → HTML</h3>
<ul>
<li>Поддержка списков, таблиц, tasklists</li>
<li>Через <code>markdown-it-py</code></li>
</ul>
<h3 id="mermaid">Mermaid</h3>
<ul>
<li>Блоки <code>mermaid</code> → SVG через <code>https://mermaid.ink/svg/</code></li>
<li>Таймаут 10 сек</li>
</ul>
<h3 id="_10">Буферизация</h3>
<ul>
<li>Длинные сообщения буферизуются</li>
<li>Отправка с задержкой через <code>_flush_after_delay</code></li>
<li>Полный вывод — как временный HTML-файл</li>
</ul>
<hr/>
<h2 id="_11">Состояние и данные</h2>
<h3 id="statejson"><code>state.json</code></h3>
<p>Хранит:
- Сессии: <code>{tool}::{workdir}</code> → <code>SessionState</code>
- Активную сессию: <code>_active</code>
- Дополнительные данные: <code>_sessions</code></p>
<p><strong>Поля <code>SessionState</code></strong>:
- <code>tool</code>, <code>workdir</code>, <code>resume_token</code>, <code>name</code>
- <code>summary</code>, <code>updated_at</code></p>
<h3 id="toolhelpjson"><code>toolhelp.json</code></h3>
<p>Кэш справки по инструментам:
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"codex"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"tool"</span><span class="p">:</span><span class="w"> </span><span class="s2">"codex"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/help, /status, /reset..."</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"updated_at"</span><span class="p">:</span><span class="w"> </span><span class="mi">1712345678</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<hr/>
<h2 id="_12">Запуск и тестирование</h2>
<h3 id="_13">Установка зависимостей</h3>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>
<h3 id="_14">Запуск</h3>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>bot.py
</code></pre></div>
<h3 id="_15">Тестирование</h3>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>-q
</code></pre></div>
<hr/>
<h2 id="_16">Безопасность</h2>
<ul>
<li>Доступ только по <code>whitelist_chat_ids</code></li>
<li>Проверка путей: <code>is_within_root()</code></li>
<li>Ограничение размера вложений</li>
<li>Токены в переменных окружения: <code>${GITHUB_TOKEN}</code></li>
<li>MTProto: сессия хранится зашифрованно</li>
</ul>
<hr/>
<h2 id="_17">Дорожная карта</h2>
<h3 id="1">Фаза 1: Надёжность</h3>
<ul>
<li>Блокировка сессий</li>
<li>Приоритизация команд</li>
<li>Единый журнал событий</li>
<li>Разделение статусов CLI/Git</li>
</ul>
<h3 id="2">Фаза 2: Интеграции</h3>
<ul>
<li>MCP-бридж</li>
<li>Git-шаблоны (PR, коммиты)</li>
<li>Preset-кнопки: тесты, линтинг</li>
</ul>
<h3 id="3">Фаза 3: Масштабирование</h3>
<ul>
<li>Профили (dev/prod)</li>
<li>Метрики и мониторинг</li>
<li>Аудит и контроль команд</li>
</ul>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": ".", "features": [], "search": "assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="assets/javascripts/bundle.79ae519e.min.js"></script>
</body>
</html>