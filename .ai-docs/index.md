# Документация проекта

## Обзор

CLI Proxy Telegram Bridge — это Telegram-бот, преобразующий CLI-инструменты (Codex, Gemini, Qwen, Claude и др.) в управляемые, визуализированные и автоматизированные процессы. Проект обеспечивает масштабируемое многопользовательское взаимодействие с агентами через Telegram, включая оркестрацию задач, Git-интеграцию и работу с файлами.

### Ключевые возможности
- **Многопользовательские сессии**: изолированные контексты выполнения с сохранением состояния в `state.json`.
- **Очередь команд**: управление параллельными задачами, предотвращение конфликтов.
- **HTML-вывод**: отображение результатов с поддержкой Markdown, ANSI-цветов и mermaid-диаграмм.
- **Git-интеграция**: inline-меню для операций `status`, `commit`, `push`, `merge`, `rebase`, `diff`.
- **Файловый доступ**: просмотр и отправка файлов через `/files`.
- **Режимы работы**: `Agent` (ReAct-агент) и `Manager` (мультиагентная оркестрация).

## Архитектура

Проект построен на модульной архитектуре с четким разделением ответственности:

- **`SessionManager`**: управление жизненным циклом сессий, включая создание, активацию и сохранение состояния.
- **`SessionUI`**: интерфейс для управления сессиями через Telegram-кнопки.
- **`GitOps`**: выполнение Git-операций с интерактивным подтверждением.
- **`ManagerOrchestrator`**: оркестрация мультиагентной разработки, включая декомпозицию задач и ревью.
- **`ToolRegistry`**: централизованное управление инструментами и плагинами.
- **`MCPBridge`**: TCP-мост для взаимодействия с внешними клиентами.

## Работа с сессиями

### Управление через Telegram

Сессии управляются через команды и inline-меню:

- `/new` — создать новую сессию.
- `/sessions` — открыть меню управления сессиями.
- `/use <id>` — активировать сессию.
- `/close` — закрыть активную сессию.

### Интерфейс `SessionUI`

Класс `SessionUI` предоставляет интерактивный интерфейс для управления сессиями:

- **Выбор сессии**: отображает список доступных сессий с кнопками.
- **Действия**:
  - `sess_use` — активация сессии.
  - `sess_status` — просмотр состояния (время работы, очередь, занятость).
  - `sess_rename` — переименование сессии (ожидает ввода).
  - `sess_resume` — установка resume-токена (ожидает ввода).
  - `sess_clearqueue` — очистка очереди команд.
  - `sess_state` — просмотр текущего состояния.
  - `sess_close` — закрытие сессии.

Изменения сохраняются автоматически через `manager._persist_sessions()`.

## Режимы работы

### Agent-режим

- Активируется командой `/agent`.
- Реализует архитектуру ReAct (Reasoning + Acting).
- Поддерживает диалог, память и циклическое выполнение действий.
- Ограничен одной сессией.

### Manager-режим

- Активируется командой `/manager`.
- Оркестрирует мультиагентную разработку: декомпозиция задачи, выполнение, ревью, финальный отчет.
- Поддерживает автокоммит в Git при успехе (`manager_auto_commit=true`).
- План сохраняется в `MANAGER_PLAN.json`.

## Конфигурация

Основной файл настройки — `config.yaml`. Поддерживает подстановку переменных окружения через `${VAR}`.

### Ключевые параметры

```yaml
telegram:
  token: "YOUR_TELEGRAM_BOT_TOKEN"
  whitelist_chat_ids: [123456789]

defaults:
  workdir: "/path/to/working/directory"
  log_path: "/path/to/logs/bot.log"
  image_temp_dir: "/tmp/images"

tools:
  codex:
    cmd: "codex --prompt {prompt}"
    resume_cmd: "codex --resume {resume}"
    prompt_regex: ".*>"
    resume_regex: "thread_id: ([a-f0-9-]+)"

manager_max_tasks: 10
manager_max_attempts: 3
manager_decompose_timeout_sec: 300
manager_dev_timeout_sec: 600
manager_auto_resume: true
manager_auto_commit: true
```

## Git-интеграция

Git-бот позволяет выполнять основные операции без знания CLI:

- **Просмотр состояния**: `Status`, `Log`, `Diff`, `Summary`.
- **Синхронизация**: `Fetch`, `Pull` (с `--ff-only`).
- **Коммиты и отправка**: `Commit`, `Push`.
- **Слияние веток**: `Merge`, `Rebase`.
- **Работа с конфликтами**: отображение конфликтующих файлов, кнопки `Abort`, `Continue`.

### Настройка

Для приватных репозиториев укажите токен в `config.yaml`:

```yaml
defaults:
  github_token: "YOUR_GITHUB_TOKEN"
```

## Обработка вложений

- **Текстовые файлы** (до 500 КБ): объединяются с подписью и передаются в CLI.
- **Изображения**: обрабатываются при наличии `image_cmd`, текст берётся из подписи.

## Команды

### Видимые в меню
- `/new`, `/sessions`, `/git`, `/files`, `/agent`, `/manager`, `/tools`, `/toolhelp`

### Скрытые
- `/dirs`, `/newpath`, `/use`, `/cwd`, `/setprompt`, `/send`, `/resume`, `/close`, `/status`, `/rename`, `/state`, `/clearqueue`, `/queue`, `/preset`, `/metrics`

### Прямой ввод
- Через `/send` или с префиксом `>`.

## Восстановление состояния

После перезапуска бот восстанавливает:
- Активные сессии из `state.json`.
- Очередь задач.
- Состояние `toolhelp.json`.

## Автоодобрение (YOLO)

Активируется флагами:
- Gemini: `--approval-mode yolo`
- Qwen: `--yolo`
- Claude: `--dangerously-skip-permissions`
- Codex: `/approvals full` в чате.
