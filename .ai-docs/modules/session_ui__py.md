# session_ui

Модуль предоставляет пользовательский интерфейс для управления сессиями через Telegram-бота. Он позволяет просматривать список сессий, выбирать активную, переименовывать, обновлять resume-токен, проверять статус и управлять очередью. Взаимодействие осуществляется через inline-кнопки и текстовые сообщения. Модуль отвечает за обработку пользовательских действий с сессиями в Telegram-интерфейсе, включая просмотр состояния, управление очередью и закрытие сессий. Он взаимодействует с менеджером сессий и системой хранения состояний, обеспечивая отображение информации и выполнение операций через callback-запросы. Логика обработки разделена по префиксам входящих данных, что позволяет маршрутизировать действия в зависимости от типа запроса.

Ключевые структуры данных  
SessionUI — Класс для управления интерфейсом сессий в Telegram, включая построение меню, обработку колбэков и ввода  
Session — объект, управляющий состоянием и очередью инструмента для конкретного пользователя  
SessionManager — централизованное хранилище активных сессий с возможностью сохранения на диск

---
class SessionUI  
Предоставляет интерфейс управления сессиями через Telegram: меню, колбэки, обработка ввода.  
Поля  
config — Конфигурация приложения.  
manager — Менеджер сессий, управляющий жизненным циклом сессий.  
_send_message — Асинхронная функция отправки сообщений в чат.  
_format_ts — Функция форматирования временных меток.  
_short_label — Функция усечения текста до заданной длины.  
_on_close — Опциональный колбэк, вызываемый при закрытии сессии.  
_on_before_close — Опциональный асинхронный колбэк перед закрытием сессии.  
pending_session_rename — Словарь: chat_id → session_id для отслеживания сессий, ожидающих переименования.  
pending_session_resume — Словарь: chat_id → session_id для отслеживания сессий, ожидающих обновления resume-токена.  
Методы  
build_sessions_menu() -> InlineKeyboardMarkup — Создаёт клавиатуру с списком всех сессий.  
handle_pending_message(chat_id: int, text: str, context: ContextTypes.DEFAULT_TYPE) -> bool — Обрабатывает текстовые сообщения от пользователей, ожидающие ввода (переименование, resume).  
handle_callback(query, chat_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool — Обрабатывает нажатия на inline-кнопки меню сессий.

---
build_sessions_menu() -> InlineKeyboardMarkup  
Создаёт inline-клавиатуру со списком всех доступных сессий.  
Возвращает  
InlineKeyboardMarkup — Клавиатура с кнопками для выбора сессии.

---
handle_pending_message(chat_id: int, text: str, context: ContextTypes.DEFAULT_TYPE) -> bool  
Обрабатывает текстовые сообщения от пользователя в контексте ожидания ввода (переименование или resume).  
Аргументы  
chat_id — Идентификатор чата.  
text — Введённый пользователем текст.  
context — Контекст выполнения Telegram-бота.  
Возвращает  
True, если сообщение было обработано как ожидающий ввод; иначе False.

---
handle_callback(query, chat_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool  
Обрабатывает нажатие на inline-кнопки в меню сессий.  
Аргументы  
query — Объект колбэка от Telegram.  
chat_id — Идентификатор чата.  
context — Контекст выполнения Telegram-бота.  
Возвращает  
True, если колбэк был обработан; иначе False.

---
async def handle_callback_query(query: CallbackQuery, context: ContextTypes.DEFAULT_TYPE) -> bool  
Обрабатывает callback-запросы от пользователя, связанные с управлением сессиями  
Аргументы  
query — объект callback-запроса от Telegram  
context — контекст выполнения бота, содержащий данные и методы  
Возвращает  
True, если запрос был обработан, иначе False  
Исключения  
Может выбрасывать исключения при ошибках взаимодействия с Telegram API или файловой системой

---
def _send_message(context: ContextTypes.DEFAULT_TYPE, chat_id: int, text: str) -> None  
Асинхронно отправляет сообщение в указанный чат  
Аргументы  
context — контекст выполнения бота  
chat_id — идентификатор получателя  
text — текст сообщения  
Исключения  
Выбрасывает исключение при недоступности Telegram API

---
def _format_ts(timestamp: float) -> str  
Форматирует временную метку в человекочитаемую строку  
Аргументы  
timestamp — время в формате Unix timestamp  
Возвращает  
Строка с датой и временем в локальном формате

---
class SessionManager  
Управляет жизненным циклом сессий: создание, получение, закрытие и сохранение  
Поля  
sessions — словарь активных сессий, индексированных по ID  
session_file — путь к файлу для сохранения состояния сессий  
Методы  
get(session_id: str) -> Session | None — возвращает сессию по ID или None, если не найдена  
close(session_id: str) -> bool — закрывает и удаляет сессию, возвращает успех операции  
_persist_sessions() — сохраняет текущее состояние сессий в файл
