# state

Модуль предоставляет средства для управления состоянием сессий и активного состояния инструментов в файле формата JSON. Поддерживается сохранение, загрузка, обновление и удаление состояний по ключу, а также работа с активной сессией и дополнительными сессионными данными. Все операции выполняются с обработкой ошибок и логированием, данные хранятся в виде JSON-файлов на диске.

Ключевые структуры данных  
SessionState — Состояние сохранённой сессии, включая инструмент, рабочую директорию, токен возобновления, резюме, метку времени и опциональное имя.  
ActiveState — Состояние активной сессии, включая инструмент, рабочую директорию, метку времени и идентификатор сессии.

_load_raw(path: str) -> Dict[str, Any]  
Загружает JSON-данные из файла, возвращает пустой словарь при отсутствии файла или ошибке.  
Аргументы  
path — путь к файлу для чтения  
Возвращает  
словарь с данными из JSON-файла или пустой словарь при ошибке  
Исключения  
записываются в лог через logging.exception

---
_save_raw(path: str, raw: Dict[str, Any]) -> None  
Сохраняет словарь в JSON-файл с отступами и поддержкой UTF-8.  
Аргументы  
path — путь к файлу для записи  
raw — данные для сохранения  
Исключения  
записываются в лог через logging.exception

---
load_state(path: str) -> Dict[str, SessionState]  
Загружает состояние всех сессий из файла и возвращает словарь SessionState.  
Аргументы  
path — путь к файлу состояния  
Возвращает  
словарь, где ключ — строка вида "tool::workdir", значение — объект SessionState

---
save_state(path: str, data: Dict[str, SessionState]) -> None  
Сохраняет состояние сессий в файл, перезаписывая существующие данные.  
Аргументы  
path — путь к файлу состояния  
data — словарь сессий для сохранения

---
delete_state(path: str, tool: str, workdir: str) -> None  
Удаляет состояние сессии по указанному инструменту и рабочей директории.  
Аргументы  
path — путь к файлу состояния  
tool — название инструмента  
workdir — путь к рабочей директории

---
make_key(tool: str, workdir: str) -> str  
Формирует строковый ключ для идентификации сессии по инструменту и рабочей директории.  
Аргументы  
tool — название инструмента  
workdir — путь к рабочей директории  
Возвращает  
строку в формате "tool::workdir"

---
update_state(path: str, tool: str, workdir: str, resume_token: Optional[str], summary: Optional[str], name: Optional[str] = None) -> None  
Обновляет или создаёт состояние сессии с текущей временной меткой.  
Аргументы  
path — путь к файлу состояния  
tool — название инструмента  
workdir — путь к рабочей директории  
resume_token — токен для возобновления сессии (опционально)  
summary — текстовое резюме сессии (опционально)  
name — имя сессии (опционально)

---
get_state(path: str, tool: str, workdir: str) -> Optional[SessionState]  
Возвращает состояние сессии по инструменту и рабочей директории или None, если не найдено.  
Аргументы  
path — путь к файлу состояния  
tool — название инструмента  
workdir — путь к рабочей директории  
Возвращает  
объект SessionState или None

---
load_active_state(path: str) -> Optional[ActiveState]  
Загружает состояние активной сессии из файла.  
Аргументы  
path — путь к файлу состояния  
Возвращает  
объект ActiveState или None, если активная сессия не установлена

---
set_active_state(path: str, tool: str, workdir: str, session_id: Optional[str] = None) -> None  
Устанавливает активное состояние сессии с текущей временной меткой.  
Аргументы  
path — путь к файлу состояния  
tool — название инструмента  
workdir — путь к рабочей директории  
session_id — идентификатор сессии (опционально)

---
clear_active_state(path: str) -> None  
Удаляет информацию об активной сессии из файла.  
Аргументы  
path — путь к файлу состояния

---
load_sessions(path: str) -> Dict[str, Any]  
Загружает дополнительные сессионные данные (например, история чата) из файла.  
Аргументы  
path — путь к файлу состояния  
Возвращает  
словарь с данными из поля _sessions или пустой словарь

---
save_sessions(path: str, sessions: Dict[str, Any]) -> None  
Сохраняет дополнительные сессионные данные в поле _sessions файла.  
Аргументы  
path — путь к файлу состояния  
sessions — словарь сессионных данных для сохранения
