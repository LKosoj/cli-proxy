# state

```markdown
Модуль предоставляет функции для управления состоянием сессий и активного контекста в файле JSON. Основное состояние хранится в разделе `_sessions`, где каждая сессия идентифицируется по уникальному `session_id`. Поддерживается обратная совместимость с устаревшим форматом хранения состояния на верхнем уровне по ключу `{tool}::{workdir}`. Также реализовано управление активной сессией через раздел `_active`.

Ключевые структуры данных
SessionState — состояние отдельной сессии, включая идентификатор, инструмент, рабочую директорию, токен возобновления, резюме, метку времени обновления и имя.
ActiveState — состояние активной сессии, содержащее инструмент, рабочую директорию, идентификатор сессии и время обновления.

_load_raw
Загружает JSON-данные из файла по указанному пути.
Аргументы
path — путь к файлу для чтения.
Возвращает
Словарь с данными из JSON-файла или пустой словарь в случае ошибки или отсутствия файла.
Исключения
Любые исключения логируются, но не прерывают выполнение.

---
_save_raw
Сохраняет словарь в JSON-файл с отступами и поддержкой UTF-8.
Аргументы
path — путь к файлу для записи.
raw — данные для сохранения.
Исключения
Любые исключения логируются, но не прерывают выполнение.

---
load_state
Загружает состояние всех сессий из файла, приоритизируя данные из раздела `_sessions`, с поддержкой устаревшего формата.
Аргументы
path — путь к файлу состояния.
Возвращает
Словарь, где ключ — идентификатор сессии (или ключ `{tool}::{workdir}` для устаревшего формата), значение — объект SessionState.

---
save_state
Сохраняет состояние сессий в раздел `_sessions` JSON-файла.
Аргументы
path — путь к файлу состояния.
data — словарь сессий, где ключ — идентификатор сессии, значение — объект SessionState.
Исключения
Ошибка записи логируется, но не прерывает выполнение.

---
delete_state
Удаляет устаревшую запись состояния по ключу `{tool}::{workdir}`.
Аргументы
path — путь к файлу состояния.
tool — название инструмента.
workdir — рабочая директория.

---
make_key
Формирует строковый ключ по комбинации инструмента и рабочей директории.
Аргументы
tool — название инструмента.
workdir — рабочая директория.
Возвращает
Строку в формате `{tool}::{workdir}`.

---
update_state
Обновляет состояние в устаревшем формате (на верхнем уровне), если отсутствуют данные в `_sessions`.
Аргументы
path — путь к файлу состояния.
tool — название инструмента.
workdir — рабочая директория.
resume_token — токен для возобновления сессии.
summary — текстовое резюме сессии.
name — опциональное имя сессии.
Исключения
Ошибка записи логируется, но не прерывает выполнение.

---
get_state
Получает состояние сессии по идентификатору или по комбинации инструмента и рабочей директории.
Аргументы
path — путь к файлу состояния.
tool — название инструмента.
workdir — рабочая директория.
session_id — опциональный идентификатор сессии.
Возвращает
Объект SessionState, если найден, иначе None.

---
load_active_state
Загружает состояние активной сессии из раздела `_active`.
Аргументы
path — путь к файлу состояния.
Возвращает
Объект ActiveState, если данные существуют, иначе None.

---
set_active_state
Сохраняет состояние активной сессии в раздел `_active`.
Аргументы
path — путь к файлу состояния.
tool — название инструмента.
workdir — рабочая директория.
session_id — опциональный идентификатор сессии.

---
clear_active_state
Удаляет состояние активной сессии из файла.
Аргументы
path — путь к файлу состояния.

---
load_sessions
Загружает содержимое раздела `_sessions` как словарь.
Аргументы
path — путь к файлу состояния.
Возвращает
Словарь с данными из раздела `_sessions` или пустой словарь, если раздел отсутствует.

---
save_sessions
Сохраняет словарь в раздел `_sessions` файла состояния.
Аргументы
path — путь к файлу состояния.
sessions — словарь для сохранения в `_sessions`.
Исключения
Ошибка записи логируется, но не прерывает выполнение.
```
