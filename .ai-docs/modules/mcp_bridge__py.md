# mcp_bridge

Модуль реализует мост между внешними клиентами и ботом через TCP-сервер, используя JSON-сообщения. Клиенты могут отправлять текстовые запросы (prompt) с токеном аутентификации, получать ответы от бота и управлять сессиями. Сервер запускается только если соответствующая функция включена в конфигурации. Поддерживается проверка токена, обработка ошибок и построчная передача JSON-сообщений.

Ключевые структуры данных  
MCPBridge — Основной класс, реализующий TCP-сервер для приёма и обработки запросов от внешних клиентов.

---
class MCPBridge  
Класс, реализующий TCP-мост для обработки запросов от внешних клиентов через JSON-интерфейс.  
Поля  
config — Объект конфигурации с настройками MCP (включено/выключено, хост, порт, токен).  
bot_app — Экземпляр приложения бота, используемый для выполнения запросов.  
_server — Асинхронный TCP-сервер, принимает входящие соединения; инициализируется при старте.  
Методы  
__init__(config, bot_app) — Инициализирует мост с заданной конфигурацией и экземпляром бота.  
start() — Асинхронно запускает TCP-сервер, если MCP включён в конфигурации.  
stop() — Асинхронно останавливает сервер и закрывает все соединения.  
_handle_client(reader, writer) — Обрабатывает входящее соединение: читает JSON-запросы, проверяет токен, выполняет запрос через bot_app и отправляет ответ.  
_write(writer, payload) — Асинхронно записывает JSON-сообщение в поток с добавлением перевода строки и сбросом буфера.

---
__init__(config, bot_app)  
Инициализирует экземпляр MCPBridge с конфигурацией и приложением бота.  
Аргументы  
config — Объект конфигурации, содержащий настройки MCP.  
bot_app — Экземпляр приложения бота для обработки запросов.

---
start()  
Асинхронно запускает TCP-сервер для обработки входящих запросов, если MCP включён.  
Исключения  
Может выбросить исключение, если не удалось запустить сервер (например, порт занят).

---
stop()  
Асинхронно останавливает TCP-сервер, если он запущен, и ожидает завершения всех соединений.

---
_handle_client(reader, writer)  
Обрабатывает входящее TCP-соединение: читает и парсит JSON, проверяет токен, выполняет запрос и отправляет ответ.  
Аргументы  
reader — Объект StreamReader для чтения входящих данных.  
writer — Объект StreamWriter для отправки ответов клиенту.  
Исключения  
Не выбрасывает исключения напрямую, все ошибки обрабатываются внутри и отправляются клиенту в виде JSON.

---
_write(writer, payload)  
Кодирует и отправляет JSON-сообщение клиенту с добавлением перевода строки и сбросом буфера.  
Аргументы  
writer — Объект StreamWriter для отправки данных.  
payload — Словарь Python, который будет сериализован в JSON и отправлен.
