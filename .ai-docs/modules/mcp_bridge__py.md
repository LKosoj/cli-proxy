# mcp_bridge

```markdown
Модуль реализует мост для взаимодействия с внешними системами через TCP-сервер, используя JSON-сообщения. Он позволяет принимать запросы с текстовыми запросами (prompt), аутентифицировать их по токену и передавать в приложение бота для обработки. Ответ возвращается в виде JSON-объекта по тому же соединению. Поддерживается управление жизненным циклом сервера (запуск и остановка).

Ключевые структуры данных
MCPBridge — Основной класс, реализующий TCP-сервер для обработки входящих запросов и взаимодействия с ботом.

---
class MCPBridge
Класс, реализующий TCP-мост для обработки входящих JSON-запросов и выполнения промптов через bot_app.
Поля
config — Конфигурация приложения, содержащая настройки MCP (включено/выключено, хост, порт, токен).
bot_app — Экземпляр приложения бота, используемый для выполнения промптов.
_server — Асинхронный TCP-сервер, обрабатывающий подключения клиентов, или None, если сервер не запущен.
Методы
__init__(config, bot_app) — Инициализирует мост с заданной конфигурацией и экземпляром приложения бота.
start() — Асинхронно запускает TCP-сервер, если MCP включён в конфигурации.
stop() — Асинхронно останавливает сервер, закрывая все соединения.
_handle_client(reader: asyncio.StreamReader, writer: asyncio.StreamWriter) — Обрабатывает входящее соединение: читает JSON-запросы, проверяет токен, выполняет промпты и отправляет ответы.
_write(writer: asyncio.StreamWriter, payload: Dict[str, Any]) — Асинхронно записывает JSON-объект в поток с добавлением перевода строки и сбросом буфера.

---
__init__(config, bot_app)
Инициализирует экземпляр MCPBridge с конфигурацией и приложением бота.
Аргументы
config — Объект конфигурации с параметрами MCP (host, port, token, enabled).
bot_app — Экземпляр приложения бота, поддерживающий метод run_prompt_raw.

---
start()
Асинхронно запускает TCP-сервер для обработки входящих клиентских подключений, если MCP включён.
Исключения
Может выбрасывать исключения, связанные с сетевыми операциями (например, OSError при недоступности порта).

---
stop()
Асинхронно останавливает запущенный TCP-сервер, если он существует.
Исключения
Может выбрасывать исключения, связанные с закрытием соединений.

---
_handle_client(reader: asyncio.StreamReader, writer: asyncio.StreamWriter)
Обрабатывает клиентское соединение: читает строки, парсит JSON, проверяет аутентификацию и выполняет промпты.
Аргументы
reader — Асинхронный поток для чтения данных от клиента.
writer — Асинхронный поток для записи ответов клиенту.
Исключения
Любые исключения при выполнении промпта логируются, но не прерывают обработку соединения.

---
_write(writer: asyncio.StreamWriter, payload: Dict[str, Any])
Кодирует словарь в JSON, добавляет перевод строки, кодирует в UTF-8 и отправляет клиенту.
Аргументы
writer — Поток записи для отправки данных клиенту.
payload — Словарь, который будет сериализован и отправлен.
Исключения
Может выбрасывать исключения, связанные с записью в сокет (например, ConnectionResetError).
```
