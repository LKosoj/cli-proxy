# agent/planner

Модуль отвечает за построение плана выполнения задачи пользователя в виде последовательности шагов.  
Использует LLM для генерации структурированного плана в формате JSON, который затем парсится и валидируется.  
При необходимости добавляет шаг уточнения запроса у пользователя на основе эвристик.  
Гарантирует уникальность идентификаторов шагов и корректность структуры выходных данных.

Ключевые структуры данных  
PlanStep — Описание одного шага в плане выполнения задачи: тип, инструкция, зависимости, параметры параллельного выполнения и данные для уточняющих вопросов.

---
async def plan_steps(config: AppConfig, user_message: str, context: str) -> List[PlanStep]  
Генерирует и валидирует план шагов для выполнения пользовательской задачи.  
Аргументы  
config — Конфигурация приложения, включая параметры LLM.  
user_message — Текст запроса пользователя.  
context — Дополнительный контекст, доступный при планировании.  
Возвращает  
Список объектов PlanStep, представляющих шаги выполнения задачи.  
Исключения  
Не выбрасывает исключения напрямую, обрабатывает ошибки парсинга и возвращает fallback-план.

---
def _ensure_unique_step_ids(steps: List[PlanStep]) -> None  
Обеспечивает уникальность идентификаторов всех шагов в списке.  
Аргументы  
steps — Список шагов, идентификаторы которых необходимо сделать уникальными.  
Возвращает  
Ничего.  
Исключения  
Нет.

---
def _extract_json_object(raw: str) -> str  
Извлекает подстроку, содержащую JSON-объект, из сырого текста ответа LLM.  
Аргументы  
raw — Сырой текст ответа модели, возможно с markdown-разметкой.  
Возвращает  
Строка с валидным JSON-объектом или пустая строка, если объект не найден.  
Исключения  
Нет.
