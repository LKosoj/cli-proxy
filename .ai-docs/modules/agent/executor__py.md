# agent/executor

Модуль реализует исполнителя задач (Executor), управляющий выполнением агентных операций на основе входящих запросов. Он инкапсулирует логику запуска агентов, обработки временных сбоев, повторных попыток и взаимодействия с пользователем через инструменты. Поддерживает изоляцию сессий, управление временными ограничениями и регистрацию действий через реестр инструментов.

Ключевые структуры данных  
Executor — Основной класс, управляющий выполнением задач агентом с поддержкой повторов, таймаутов и взаимодействия с пользователем

---
class Executor  
Управляет выполнением задач агентом с поддержкой повторов, таймаутов, взаимодействия с пользователем и обработки ошибок  
Поля  
_config — Конфигурация исполнителя  
_tool_registry — Реестр доступных инструментов  
_runner — Экземпляр AgentRunner для запуска агентных сессий  
_log — Логгер модуля  
Методы  
__init__(self, config, tool_registry: ToolRegistry) — Инициализирует исполнитель с конфигурацией и реестром инструментов  
run(self, session: Any, request: ExecutorRequest, bot: Any, context: Any, dest: Dict[str, Any], profile: ExecutorProfile) -> ExecutorResponse — Запускает выполнение задачи с поддержкой повторов, таймаутов и обработки запросов к пользователю  
record_message(self, chat_id: int, message_id: int) -> None — Регистрирует отправленное сообщение в контексте чата  
resolve_question(self, question_id: str, answer: str) -> bool — Разрешает ожидающий вопрос, передавая ответ от пользователя  
clear_session_cache(self, session_id: str) -> None — Очищает кэш сессии в агенте  
get_plugin_commands(self, profile: ExecutorProfile) -> Dict[str, Any] — Возвращает команды бота, разрешённые в профиле  
get_plugin_ui(self, profile: ExecutorProfile) -> Dict[str, Any] — Возвращает UI-конфигурацию плагинов, разрешённую в профиле

---
def _sandbox_root(self) -> str  
Возвращает корневую директорию песочницы для хранения временных данных  
Возвращает  
Путь к корневой директории песочницы

---
def _session_workspace(self, session_id: str) -> str  
Формирует путь к рабочей директории сессии  
Аргументы  
session_id — Идентификатор сессии  
Возвращает  
Путь к рабочей директории сессии

---
def _is_transient_exc(self, e: BaseException) -> bool  
Определяет, является ли исключение временным и допускающим повторную попытку  
Аргументы  
e — Исключение для анализа  
Возвращает  
True, если исключение считается временным

---
async def _sleep_backoff(self, attempt: int) -> None  
Выполняет асинхронную задержку с экспоненциальным ростом и дрожанием (jitter)  
Аргументы  
attempt — Номер попытки (определяет длительность задержки)

---
async def run(self, session: Any, request: ExecutorRequest, bot: Any, context: Any, dest: Dict[str, Any], profile: ExecutorProfile) -> ExecutorResponse  
Запускает выполнение задачи с обработкой таймаутов, повторами и взаимодействием с пользователем  
Аргументы  
session — Объект сессии, содержащий контекст выполнения  
request — Входящий запрос к исполнителю  
bot — Экземпляр бота для взаимодействия  
context — Дополнительный контекст выполнения  
dest — Словарь с информацией о получателе (chat_id, chat_type и др.)  
profile — Профиль исполнителя с настройками прав и ограничений  
Возвращает  
Ответ исполнителя с результатом выполнения или ошибкой  
Исключения  
Не выбрасывает напрямую, но обрабатывает asyncio.TimeoutError, ConnectionError и другие в ходе выполнения
