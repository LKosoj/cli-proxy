# agent/mcp/jsonrpc

/**
 * @brief Модуль предоставляет инструменты для работы с JSON-RPC сообщениями, передаваемыми по потоку в рамках двух распространённых форматов фрейминга: LSP-совместимый (на основе заголовка Content-Length) и NDJSON (по одному JSON-объекту на строку). Основной класс `JsonRpcStream` инкапсулирует асинхронное чтение и запись сообщений, обеспечивая прозрачную поддержку обоих форматов. Используется для реализации клиентов или серверов, взаимодействующих по протоколам, основанным на JSON-RPC, таким как Language Server Protocol.
 *
 * Ключевые структуры данных
 * JsonRpcStream — Асинхронный интерфейс для чтения и записи JSON-RPC сообщений с поддержкой Content-Length и NDJSON фрейминга
 */

_json_dumps(obj)
Преобразует объект Python в байты JSON с добавлением символа новой строки
Аргументы
obj — Объект Python, сериализуемый в JSON
Возвращает
Байтовая строка, содержащая JSON-представление объекта и символ новой строки

---
encode_content_length_message(obj)
Формирует сообщение в формате Content-Length: N с последующим JSON-телом
Аргументы
obj — Объект Python, сериализуемый в JSON
Возвращает
Байтовая строка, содержащая заголовок Content-Length и JSON-тело
Исключения
Может выбросить исключение при неудачной сериализации в JSON

---
class JsonRpcStream
Асинхронный поток для обмена JSON-RPC сообщениями с поддержкой Content-Length и NDJSON
Поля
_reader — Объект asyncio.StreamReader для чтения данных из потока
_writer — Объект asyncio.StreamWriter для записи данных в поток
Методы
__init__(reader: asyncio.StreamReader, writer: asyncio.StreamWriter) — Инициализирует поток с указанными reader и writer
write(obj: Any, *, prefer_content_length: bool = True) -> None — Асинхронно записывает JSON-RPC сообщение, используя указанный формат фрейминга
read() -> Optional[Dict[str, Any]] — Асинхронно читает следующее JSON-RPC сообщение, определяя формат автоматически
