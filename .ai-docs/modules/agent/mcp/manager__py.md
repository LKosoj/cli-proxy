# agent/mcp/manager

```markdown
MCPManager управляет клиентами MCP (Model Control Protocol), обеспечивая инициализацию, кэширование инструментов и вызов методов через различные транспортные протоколы (stdio, http). 
Он поддерживает загрузку и сохранение кэша инструментов между сессиями, а также абстрагирует различия в транспорте для единообразного взаимодействия с серверами.
Клиенты инициализируются по мере необходимости, с синхронизацией доступа через асинхронный замок.

Ключевые структуры данных
MCPToolInfo — Информация об инструменте MCP: имя, описание, схема входных данных
AppConfig — Конфигурация приложения, включая настройки MCP-клиентов
MCPClientServerConfig — Конфигурация одного MCP-сервера: имя, команда запуска, URL, транспорт и т.д.

def _sanitize_tool_name(name: str) -> str
Преобразует имя инструмента в формат, совместимый с ограничениями OpenAI (разрешены только [a-zA-Z0-9_-])
Аргументы
name — Исходное имя инструмента
Возвращает
Очищенное имя, пригодное для использования в качестве имени функции
Исключения
Нет

---
class MCPManager
Менеджер MCP-клиентов, отвечающий за запуск, кэширование и вызов инструментов
Поля
_config — Конфигурация приложения
_clients — Активные MCP-клиенты, индексируемые по имени сервера
_tools_cache — Кэш инструментов, полученных от серверов
_init_lock — Асинхронный замок для синхронизации инициализации клиентов
Методы
def __init__(self, config: AppConfig) -> None — Инициализирует менеджер с заданной конфигурацией
def _shared_root(self) -> str — Возвращает путь к общей директории для кэширования
Аргументы
Нет
Возвращает
Путь к общей директории кэша
Исключения
Нет

---
def _cache_path(self) -> str — Возвращает полный путь к файлу кэша инструментов
Аргументы
Нет
Возвращает
Полный путь к файлу кэша инструментов
Исключения
Нет

---
def configured_servers(self) -> List[MCPClientServerConfig] — Возвращает список настроенных MCP-серверов
Аргументы
Нет
Возвращает
Список конфигураций MCP-серверов
Исключения
Нет

---
def load_cached_tools(self) -> List[Tuple[str, MCPToolInfo]] — Загружает кэшированные инструменты из файла
Аргументы
Нет
Возвращает
Список пар (имя_сервера, информация_об_инструменте)
Исключения
Может выбрасывать исключения, связанные с чтением файла (например, FileNotFoundError, JSONDecodeError)

---
def save_cached_tools(self, tools: List[Tuple[str, MCPToolInfo]]) -> None — Сохраняет инструменты в файл кэша
Аргументы
tools — Список пар (имя_сервера, информация_об_инструменте) для сохранения
Возвращает
Ничего
Исключения
Может выбрасывать исключения, связанные с записью файла (например, PermissionError, OSError)

---
async def ensure_started(self) -> None — Асинхронно запускает все включённые MCP-клиенты, если они ещё не запущены
Аргументы
Нет
Возвращает
Ничего
Исключения
Может выбрасывать исключения при ошибках инициализации клиентов

---
async def list_all_tools(self) -> List[Tuple[str, MCPToolInfo]] — Возвращает список всех доступных инструментов от всех запущенных серверов
Аргументы
Нет
Возвращает
Список пар (имя_сервера, информация_об_инструменте)
Исключения
Может выбрасывать исключения при ошибках взаимодействия с клиентами

---
async def call(self, server_name: str, tool_name: str, arguments: Dict[str, Any]) -> Dict[str, Any] — Вызывает указанный инструмент на указанном сервере с переданными аргументами
Аргументы
server_name — Имя MCP-сервера
tool_name — Имя вызываемого инструмента
arguments — Аргументы вызова инструмента в виде словаря
Возвращает
Результат выполнения инструмента в виде словаря
Исключения
Выбрасывает исключение при отсутствии сервера, инструмента или ошибках выполнения

---
def build_registry_name(self, server_name: str, tool_name: str) -> str — Формирует уникальное имя инструмента для регистрации (например, в OpenAI), очищенное и ограниченное по длине
Аргументы
server_name — Имя сервера
tool_name — Исходное имя инструмента
Возвращает
Очищенное и уникальное имя инструмента, пригодное для регистрации
Исключения
Нет
```
