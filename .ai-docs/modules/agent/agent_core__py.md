# agent/agent_core

Модуль реализует агентную систему на основе ReAct-подхода (Reasoning + Action), позволяющую агенту выполнять цепочки рассуждений и вызовов инструментов для решения задач. Основная логика сосредоточена в классе `ReActAgent`, который управляет итерациями выполнения, обработкой результатов инструментов и восстановлением при ошибках. Класс `AgentRunner` предоставляет удобный интерфейс для запуска агента в различных контекстах. Результат выполнения агента возвращается в виде структурированного объекта `AgentRunResult`.

Ключевые структуры данных  
AgentRunResult — Результат выполнения агента, включая вывод, статус и список вызовов инструментов.

---
@dataclass
class AgentState
Состояние агента, включая историю действий, итерации и блокировки.
Поля
history — История действий агента в формате списка словарей.
iteration — Текущий номер итерации в цикле ReAct.
blocked — Счётчик блокировок, ограничивающий бесконечные циклы.
last_action — Последнее выполненное действие (название инструмента или рассуждение).
last_result — Результат последнего действия.

---
class ReActAgent
Агент, реализующий цикл Reasoning-Action с поддержкой инструментов и управления сессиями.
Поля
config — Конфигурация приложения (AppConfig).
_tool_registry — Реестр инструментов, используемый для выполнения действий.
_openai_client — Асинхронный клиент OpenAI для взаимодействия с моделью.
_sessions — Кэш сессий агента, индексированный по ключу состояния.
_openai_cfg — Кортеж с конфигурацией OpenAI (ключ, модель, URL).
Методы
__init__(self, config: AppConfig, tool_registry: PluginToolRegistry) — Инициализирует агента с конфигурацией и реестром инструментов.
record_message(self, chat_id: int, message_id: int) — Регистрирует отправленное сообщение в реестре инструментов.
resolve_question(self, question_id: str, answer: str) -> bool — Разрешает ожидающий вопрос с заданным идентификатором.
_load_system_prompt(self, cwd: str, chat_id: Optional[int]) -> str — Формирует системный промпт с подстановкой контекста (память, история, инструменты).
_load_session(self, state_root: str) -> Dict[str, Any] — Загружает состояние сессии из файла SESSION.json.
_save_session(self, state_root: str, session: Dict[str, Any]) -> None — Сохраняет состояние сессии в файл с блокировкой.
_reset_session(self, state_root: str) -> None — Сбрасывает состояние сессии, удаляя файл состояния.
_execute_step(self, session: Dict[str, Any], prompt: str, cwd: str, chat_id: Optional[int]) -> Tuple[str, bool] — Выполняет один шаг агента: генерация действия и его выполнение.
run(self, prompt: str, cwd: str, chat_id: Optional[int] = None) -> str — Основной метод запуска агента; выполняет цикл ReAct до достижения результата или лимита итераций.

---
save_chat_message(username: str, text: str, is_bot: bool = False, chat_id: Optional[int] = None) -> None
Сохраняет сообщение в файл истории чата с ограничением по длине и количеству сообщений.
Аргументы
username — Имя пользователя, отправившего сообщение.
text — Текст сообщения.
is_bot — Флаг, указывающий, является ли сообщение ответом бота.
chat_id — Идентификатор чата; если None, используется глобальный чат.
Исключения
Не выбрасывает исключения, все ошибки подавляются.

---
get_chat_history(chat_id: Optional[int]) -> Optional[str]
Возвращает содержимое истории чата, ограниченное по размеру и количеству сообщений.
Аргументы
chat_id — Идентификатор чата; если None, возвращается глобальный чат.
Возвращает
Текст истории чата или None, если история отсутствует или пуста.
Исключения
Не выбрасывает исключения, все ошибки подавляются.

---
log_global(user_id: str, action: str, details: Optional[str] = None) -> None
Записывает запись в глобальный лог активности с временной меткой и деталями.
Аргументы
user_id — Идентификатор пользователя.
action — Описание действия.
details — Дополнительные детали (ограничиваются по длине).
Исключения
Не выбрасывает исключения, все ошибки подавляются.

---
get_memory_for_prompt(cwd: str) -> Optional[str]
Читает содержимое файла памяти (MEMORY.md) из указанной директории и возвращает его, ограничивая по длине.
Аргументы
cwd — Текущая рабочая директория, в которой ищется файл памяти.
Возвращает
Содержимое памяти как строку или None, если файл отсутствует или пуст.
Исключения
Не выбрасывает исключения, все ошибки подавляются.

---
_get_openai_config(config: Optional[AppConfig] = None) -> Optional[Tuple[str, str, str]]
Извлекает конфигурацию OpenAI из переменных окружения или конфигурационного файла.
Аргументы
config — Опциональный объект конфигурации приложения.
Возвращает
Кортеж (api_key, model, base_url) или None, если ключ или модель не заданы.
Исключения
Не выбрасывает исключения.

---
read_json_locked(path: str, default: Any = None) -> Any
Читает JSON-файл с эксклюзивной блокировкой для потокобезопасного доступа.
Аргументы
path — путь к файлу.
default — значение по умолчанию, если файл не существует или поврежён.
Возвращает
Десериализованные данные из файла или значение по умолчанию.
Исключения
Может выбрасывать исключения при ошибках файловой системы или блокировки.

---
write_json_locked(path: str, data: Any) -> None
Записывает данные в JSON-файл с эксклюзивной блокировкой.
Аргументы
path — путь к файлу.
data — сериализуемые данные.
Исключения
Может выбрасывать исключения при ошибках файловой системы или блокировки.

---
sandbox_root(workdir: str) -> str
Формирует путь к корневой директории песочницы для хранения состояния сессии.
Аргументы
workdir — рабочая директория по умолчанию.
Возвращает
Путь к директории _sandbox внутри workdir.

---
_load_session(self, state_root: str) -> Dict[str, Any]
Загружает сессию из SESSION.json с обработкой миграции старых данных.
Аргументы
state_root — путь к корню состояния сессии.
Возвращает
Словарь с данными сессии, включая history_by_task.

---
_save_session(self, state_root: str, session: Dict[str, Any]) -> None
Сохраняет сессию в SESSION.json с блокировкой.
Аргументы
state_root — путь к корню состояния.
session — данные сессии для сохранения.

---
_load_system_prompt(self, cwd: str, chat_id: Optional[int]) -> str
Загружает системный промпт из файла, специфичного для chat_id или общего по умолчанию.
Аргументы
cwd — текущая рабочая директория.
chat_id — идентификатор чата для выбора промпта.
Возвращает
Содержимое системного промпта как строка.

---
_build_messages(self, session: Dict[str, Any], user_message: str, cwd: str, chat_id: Optional[int], working: List[Dict[str, Any]], task_id: Optional[str], request_context: Optional[str], constraints: Optional[str], corr_id: Optional[str]) -> List[Dict[str, Any]]
Формирует полный список сообщений для отправки в LLM, включая системные, историю и текущий запрос.
Аргументы
session — текущее состояние сессии.
user_message — ввод пользователя.
cwd — рабочая директория.
chat_id — идентификатор чата.
working — промежуточные сообщения с вызовами инструментов.
task_id — идентификатор задачи для выбора истории.
request_context — дополнительный контекст запроса.
constraints — ограничения на поведение агента.
corr_id — идентификатор корреляции для логирования.
Возвращает
Список сообщений в формате OpenAI API.

---
async _call_openai(self, messages: List[Dict[str, Any]], allowed_tools: Optional[List[str]]) -> Dict[str, Any]
Выполняет асинхронный вызов OpenAI Chat Completions с поддержкой инструментов.
Аргументы
messages — список сообщений для модели.
allowed_tools — список разрешённых инструментов (или None для всех).
Возвращает
Сырой ответ модели в виде словаря.
Исключения
RuntimeError — если конфигурация OpenAI не инициализирована.

---
async run(self, session_id: str, user_text: str, session: Any, bot: Any, context: Any, chat_id: Optional[int], chat_type: Optional[str], task_id: Optional[str] = None, allowed_tools: Optional[List[str]] = None, request_context: Optional[str] = None, constraints: Optional[str] = None, corr_id: Optional[str] = None) -> AgentRunResult
Запускает выполнение агента с заданным пользовательским запросом и управляет циклом ReAct до достижения результата или лимитов.
Аргументы
session_id — Уникальный идентификатор сессии агента.
user_text — Ввод пользователя, с которого начинается выполнение.
session — Объект сессии, содержащий состояние агента.
bot — Экземпляр бота для взаимодействия с пользователем.
context — Контекст выполнения (например, данные запроса).
chat_id — Идентификатор чата (опционально).
chat_type — Тип чата (например, "private", "group") (опционально).
task_id — Идентификатор задачи для отслеживания истории (опционально).
allowed_tools — Список разрешённых к использованию инструментов (опционально).
request_context — Дополнительный контекст запроса, включаемый в промпт (опционально).
constraints — Ограничения на действия агента, добавляемые в системный промпт (опционально).
corr_id — Идентификатор корреляции для логирования (опционально).
Возвращает
Объект AgentRunResult с результатом выполнения агента.
Исключения
RuntimeError — при ошибках конфигурации или превышении лимитов итераций.

---
clear_session_cache(self, session_id: str) -> None
Очищает кэш сессии агента по её идентификатору.
Аргументы
session_id — Идентификатор сессии, которую нужно удалить из кэша.

---
class AgentRunner
Фасад для запуска агента, обеспечивающий инъекцию конфигурации и управление зависимостями.
Методы
__init__(config: AppConfig, tool_registry: PluginToolRegistry) — Инициализирует runner с конфигурацией и реестром инструментов.
record_message(chat_id: int, message_id: int) — Регистрирует отправленное сообщение для последующего редактирования.
resolve_question(question_id: str, answer: str) — Разрешает ожидающий вопрос по его идентификатору.
clear_session_cache(session_id: str) — Очищает кэш сессии в связанном ReAct-агенте.
run(session_id: str, user_text: str, session: Any, bot: Any, context: Any, chat_id: Optional[int], chat_type: Optional[str], task_id: Optional[str] = None, allowed_tools: Optional[List[str]] = None, request_context: Optional[str] = None, constraints: Optional[str] = None, corr_id: Optional[str] = None) — Асинхронно запускает выполнение агента с заданными параметрами.

---
class AgentRunResult
Результат выполнения агента.
Поля
output — Текстовый вывод агента, предназначенный для пользователя.
status — Статус выполнения: "ok", "partial", "error", "blocked".
tool_calls — Список словарей с информацией о вызовах инструментов (название, аргументы, успех, ошибка, вывод).
