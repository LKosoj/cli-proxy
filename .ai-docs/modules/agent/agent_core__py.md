# agent/agent_core

Агентная система, реализующая архитектуру ReAct (Reasoning + Action) для взаимодействия с инструментами и генерации ответов через LLM. Поддерживает асинхронное выполнение, управление сессиями, историей чата, памятью и ограничениями на инструменты. Состояние сессии сохраняется в файловой системе с потокобезопасными операциями. Агент взаимодействует с OpenAI API и поддерживает корреляцию запросов, трассировку и логирование.

Ключевые структуры данных  
AgentState — Состояние агента, включая историю действий, итерации и блокировки  
AgentRunResult — Результат выполнения агента, включает финальный ответ, статус, факты о вызванных инструментах и метрики выполнения

@dataclass  
AgentState  
Состояние агента, включая историю действий, итерации и блокировки.  
Поля  
history — История действий агента в формате списка словарей  
iteration — Текущий номер итерации в цикле ReAct  
blocked — Счётчик блокировок (например, при превышении лимитов)  
last_action — Последнее выполненное действие (название инструмента или "Thought", "Answer")  
last_result — Результат последнего действия (вывод инструмента или ответ)

---
class ReActAgent  
Агент, использующий архитектуру ReAct (Reasoning + Action) для взаимодействия с инструментами и генерации ответов через LLM.  
Поля  
config — Конфигурация приложения (AppConfig)  
_tool_registry — Реестр инструментов, используемый для выполнения действий  
_openai_client — Асинхронный клиент OpenAI для взаимодействия с моделью  
_sessions — Кэш сессий агента, индексированный по ключу состояния  
_openai_cfg — Кортеж с конфигурацией OpenAI (ключ, модель, URL)  
Методы  
__init__(self, config: AppConfig, tool_registry: PluginToolRegistry) — Инициализирует агента с конфигурацией и реестром инструментов  
record_message(self, chat_id: int, message_id: int) — Регистрирует отправленное сообщение в реестре инструментов  
resolve_question(self, question_id: str, answer: str) -> bool — Разрешает ожидающий вопрос с заданным идентификатором  
_load_system_prompt(self, cwd: str, chat_id: Optional[int]) -> str — Формирует системный промпт с подстановкой контекста (память, история, инструменты)  
_load_session(self, state_root: str) -> Dict[str, Any] — Загружает состояние сессии из файла SESSION.json  
_save_session(self, state_root: str, session: Dict[str, Any]) -> None — Сохраняет состояние сессии в файл с блокировкой  
_reset_session(self, state_root: str) -> None — Сбрасывает состояние сессии, удаляя файл состояния  
_execute_step(self, session: Dict[str, Any], prompt: str, cwd: str, chat_id: Optional[int]) -> Tuple[str, bool] — Выполняет один шаг агента: генерация действия и его выполнение  
run(self, prompt: str, cwd: str, chat_id: Optional[int] = None) -> str — Основной метод запуска агента; выполняет цикл ReAct до достижения результата или лимита итераций

---
save_chat_message(username: str, text: str, is_bot: bool = False, chat_id: Optional[int] = None) -> None  
Сохраняет сообщение в файл истории чата с ограничением по длине и количеству сообщений.  
Аргументы  
username — Имя пользователя, отправившего сообщение  
text — Текст сообщения  
is_bot — Флаг, указывающий, является ли сообщение ответом бота  
chat_id — Идентификатор чата; если None, используется глобальный чат  
Исключения  
Не выбрасывает исключения, все ошибки подавляются

---
get_chat_history(chat_id: Optional[int]) -> Optional[str]  
Возвращает содержимое истории чата, ограниченное по размеру и количеству сообщений.  
Аргументы  
chat_id — Идентификатор чата; если None, возвращается глобальный чат  
Возвращает  
Текст истории чата или None, если история отсутствует или пуста  
Исключения  
Не выбрасывает исключения, все ошибки подавляются

---
log_global(user_id: str, action: str, details: Optional[str] = None) -> None  
Записывает запись в глобальный лог активности с временной меткой и деталями.  
Аргументы  
user_id — Идентификатор пользователя  
action — Описание действия  
details — Дополнительные детали (ограничиваются по длине)  
Исключения  
Не выбрасывает исключения, все ошибки подавляются

---
get_memory_for_prompt(cwd: str) -> Optional[str]  
Читает содержимое файла памяти (MEMORY.md) из указанной директории и возвращает его, ограничивая по длине.  
Аргументы  
cwd — Текущая рабочая директория, в которой ищется файл памяти  
Возвращает  
Содержимое памяти как строку или None, если файл отсутствует или пуст  
Исключения  
Не выбрасывает исключения, все ошибки подавляются

---
_get_openai_config(config: Optional[AppConfig] = None) -> Optional[Tuple[str, str, str]]  
Извлекает конфигурацию OpenAI из переменных окружения или конфигурационного файла.  
Аргументы  
config — Опциональный объект конфигурации приложения  
Возвращает  
Кортеж (api_key, model, base_url) или None, если ключ или модель не заданы  
Исключения  
Не выбрасывает исключения

---
read_json_locked(path: str, default: Any = None) -> Any  
Читает JSON-файл с потокобезопасной блокировкой.  
Аргументы  
path — Путь к файлу для чтения  
default — Значение по умолчанию, если файл не существует или поврежён  
Возвращает  
Содержимое файла в виде объекта Python или значение по умолчанию  
Исключения  
Может выбрасывать исключения при ошибках десериализации или ввода-вывода

---
write_json_locked(path: str, data: Any) -> None  
Сохраняет данные в JSON-файл с потокобезопасной блокировкой.  
Аргументы  
path — Путь к файлу для записи  
data — Объект Python для сериализации в JSON  
Исключения  
Может выбрасывать исключения при ошибках сериализации или ввода-вывода

---
sandbox_root(workdir: str) -> str  
Формирует путь к корневой директории песочницы на основе рабочей директории.  
Аргументы  
workdir — Базовая рабочая директория  
Возвращает  
Путь к директории _sandbox внутри workdir

---
_load_session(self, state_root: str) -> Dict[str, Any]  
Загружает состояние сессии из SESSION.json с обработкой устаревшего формата.  
Аргументы  
state_root — Корневая директория для хранения сессии  
Возвращает  
Словарь с данными сессии, включая history_by_task  
Исключения  
Не выбрасывает исключения, возвращает значение по умолчанию при ошибках

---
_save_session(self, state_root: str, session: Dict[str, Any]) -> None  
Сохраняет состояние сессии в файл SESSION.json.  
Аргументы  
state_root — Корневая директория для сохранения  
session — Объект состояния сессии для записи

---
_load_system_prompt(self, cwd: str, chat_id: Optional[int]) -> str  
Загружает системный промпт из файловой системы или возвращает стандартный.  
Аргументы  
cwd — Текущая рабочая директория  
chat_id — Идентификатор чата (опционально)  
Возвращает  
Текст системного промпта

---
_build_messages(self, session: Dict[str, Any], user_message: str, cwd: str, chat_id: Optional[int], working: List[Dict[str, Any]], task_id: Optional[str], request_context: Optional[str], constraints: Optional[str], corr_id: Optional[str]) -> List[Dict[str, Any]]  
Формирует цепочку сообщений для отправки в LLM, включая системный промпт, контекст, историю и текущий ввод.  
Аргументы  
session — Текущее состояние сессии  
user_message — Сообщение от пользователя  
cwd — Текущая рабочая директория  
chat_id — Идентификатор чата  
working — Промежуточные сообщения текущей итерации  
task_id — Идентификатор задачи для выбора истории  
request_context — Дополнительный контекст запроса  
constraints — Ограничения на поведение агента  
corr_id — Идентификатор корреляции для логирования  
Возвращает  
Список сообщений в формате OpenAI API

---
async _call_openai(self, messages: List[Dict[str, Any]], allowed_tools: Optional[List[str]]) -> Dict[str, Any]  
Выполняет асинхронный вызов OpenAI API с поддержкой инструментов.  
Аргументы  
messages — Список сообщений для модели  
allowed_tools — Список разрешённых инструментов (или ["All"])  
Возвращает  
Ответ модели в виде словаря (model_dump)  
Исключения  
RuntimeError — Если конфигурация OpenAI не инициализирована

---
async run(self, session_id: str, user_message: str, session_obj: Any, bot: Any, context: Any, chat_id: Optional[int], chat_type: Optional[str], task_id: Optional[str], allowed_tools: Optional[List[str]] = None, request_context: Optional[str] = None, constraints: Optional[str] = None, corr_id: Optional[str] = None) -> AgentRunResult  
Запускает цикл агента: итеративно вызывает LLM, обрабатывает инструменты, собирает результат.  
Аргументы  
session_id — Уникальный идентификатор сессии  
user_message — Ввод от пользователя  
session_obj — Объект сессии (с workdir)  
bot — Объект бота (Telegram/Discord и т.п.)  
context — Контекст выполнения (например, aiogram)  
chat_id — Идентификатор чата  
chat_type — Тип чата (личный, группа и т.п.)  
task_id — Идентификатор задачи для сегментации истории  
allowed_tools — Ограничение набора доступных инструментов  
request_context — Дополнительный контекст запроса  
constraints — Ограничения на поведение агента  
corr_id — Идентификатор корреляции для трейсинга  
Возвращает  
Объект AgentRunResult с результатом выполнения  
Исключения  
RuntimeError — При отсутствии конфигурации OpenAI

---
class AgentRunResult  
Результат выполнения агента, включающий вывод, статус и список вызовов инструментов.  
Поля  
output — Текстовый ответ агента  
status — Статус выполнения: "ok", "error", "partial", "blocked", "timeout"  
tool_calls — Список словарей с информацией о вызовах инструментов, включая имя, аргументы, успех и ошибки
