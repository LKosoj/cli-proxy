# agent/manager

Модуль реализует логику управления проектным циклом в агентной системе, включая планирование, выполнение задач, ревью, принятие решений и финализацию. Основной компонент — `ManagerOrchestrator`, управляющий жизненным циклом `ProjectPlan`. Модуль обеспечивает декомпозицию цели пользователя, обработку зависимостей между задачами, интеграцию с CLI и LLM-агентами, автоматическое создание коммитов и генерацию финального отчёта. Поддерживается восстановление после сбоев, отладочная запись и уведомления через бота.

Ключевые структуры данных  
ProjectPlan — Основной контейнер плана проекта, включающий цели, задачи, анализ и статус.  
DevTask — Единица работы в плане, содержащая заголовок, описание, критерии приёма и зависимости.  
ProjectAnalysis — Структура с анализом текущего состояния проекта, выполненных и оставшихся работ.  
ReviewResult — Результат ревью задачи, включая статус, комментарии и метаданные.

_now_iso()  
Возвращает текущее время в формате ISO 8601 (UTC).  
Возвращает  
Строка с текущим временем в формате "ГГГГ-ММ-ДД ЧЧ:ММ:СС" по UTC.

---
_debug_ts()  
Возвращает компактную временную метку для использования в именах отладочных файлов.  
Возвращает  
Строка в формате "ГГГГММДД_ЧЧММСС" по UTC.

---
_debug_write(workdir: str, prefix: str, title: str, body: str)  
Записывает отладочный markdown-файл в подкаталог .manager внутри рабочей директории.  
Аргументы  
workdir — Корневая директория проекта.  
prefix — Префикс имени файла (например, этап процесса).  
title — Заголовок содержимого файла.  
body — Основное содержимое для записи.  
Исключения  
Любые исключения перехватываются и логируются на уровне DEBUG, не прерывают выполнение.

---
_extract_json_object(raw: str) -> str  
Извлекает строку с валидным JSON-объектом из текста, удаляя markdown-разметку и мусор.  
Аргументы  
raw — Входной текст, возможно содержащий ```json``` блоки или лишние символы.  
Возвращает  
Очищенная строка JSON или исходный текст, если разбор не удался.

---
_format_acceptance(items: List[str]) -> str  
Форматирует список критериев приёма в маркированный список для отображения.  
Аргументы  
items — Список строк с критериями приёма.  
Возвращает  
Форматированная строка с маркерами "- ", или сообщение об отсутствии критериев.

---
_task_acceptance(task: DevTask) -> str  
Форматирует критерии приёма задачи разработки в читаемый вид.  
Аргументы  
task — Объект задачи разработки.  
Возвращает  
Форматированная строка с критериями приёма задачи.

---
_plan_summary(plan: ProjectPlan) -> str  
Генерирует краткую сводку по текущему состоянию плана проекта.  
Аргументы  
plan — Объект плана проекта.  
Возвращает  
Строка с информацией о прогрессе и статусе плана.

---
_truncate_report(text: str, max_chars: int) -> str  
Обрезает длинный текст, сохраняя начало и конец с указанием пропущенной части.  
Аргументы  
text — Исходный текст.  
max_chars — Максимальное количество символов в результате.  
Возвращает  
Обрезанная строка с маркером пропущенного фрагмента или исходный текст, если он короче лимита.

---
needs_resume_choice(plan: Optional[ProjectPlan], *, auto_resume: bool, user_text: str) -> bool  
Определяет, нужно ли спросить пользователя о продолжении активного плана.  
Аргументы  
plan — Текущий план проекта или None.  
auto_resume — Флаг автоматического возобновления.  
user_text — Текст, введённый пользователем.  
Возвращает  
True, если есть активный план, auto_resume выключен и пользователь ввёл новый запрос.

---
format_manager_status(plan: ProjectPlan, *, max_comment_chars: int = 400) -> str  
Форматирует полное текстовое представление статуса менеджера и текущего плана.  
Аргументы  
plan — Объект плана проекта.  
max_comment_chars — Максимальная длина комментариев при отказе/ошибке.  
Возвращает  
Форматированная строка с деталями плана, задачами и статусами.

---
class ManagerOrchestrator  
Основной класс для управления циклом разработки: планирование, выполнение, ревью, контроль.  
Поля  
_config — Конфигурация приложения.  
_executor — Исполнитель задач, управляющий внешними инструментами и ревью.  
Методы  
__init__(config: AppConfig) — Инициализирует оркестратор с конфигурацией и реестром инструментов.  
run(session: Session, user_text: str, bot, context, dest: dict) — Основной асинхронный метод запуска цикла управления проектом.

---
async def _start_new_plan(session: Session, user_text: str, bot, context, dest: dict) -> Optional[ProjectPlan]  
Создаёт новый план проекта на основе текста пользователя.  
Аргументы  
session — Сессия выполнения, содержащая рабочую директорию и инструменты.  
user_text — Исходное описание задачи от пользователя.  
bot — Экземпляр бота для отправки сообщений.  
context — Контекст выполнения (например, для Telegram).  
dest — Словарь с параметрами назначения, например chat_id.  
Возвращает  
Объект ProjectPlan при успехе, иначе None.  
Исключения  
Не выбрасывает явные исключения, обрабатывает ошибки внутри.

---
async def _decompose(session: Session, user_goal: str) -> Optional[ProjectPlan]  
Декомпозирует цель пользователя в структурированный план задач с использованием CLI и агента-нормализатора.  
Аргументы  
session — Активная сессия для выполнения команд.  
user_goal — Целевое описание задачи от пользователя.  
Возвращает  
Созданный план проекта или None при неудаче.  
Исключения  
asyncio.TimeoutError — При превышении времени выполнения CLI.  
Любое исключение от session.run_prompt — Перехватывается и логируется.

---
def _try_parse_plan(raw_text: str, user_goal: str, max_tasks: int) -> Optional[ProjectPlan]  
Пытается извлечь и распарсить JSON-план непосредственно из вывода CLI.  
Аргументы  
raw_text — Текстовый вывод CLI, возможно содержащий JSON.  
user_goal — Целевая задача пользователя.  
max_tasks — Максимальное количество задач в плане.  
Возвращает  
Объект ProjectPlan при успешном парсинге, иначе None.  
Исключения  
Не выбрасывает, все ошибки перехватываются.

---
async def _normalize_plan(cli_output: str, user_goal: str, max_tasks: int, strict: bool = False, workdir: str = "") -> Optional[ProjectPlan]  
Использует агент для извлечения структурированного плана из неструктурированного текста CLI.  
Аргументы  
cli_output — Необработанный вывод CLI.  
user_goal — Цель проекта.  
max_tasks — Максимальное число задач.  
strict — Флаг строгого режима: требует только валидный JSON без пояснений.  
workdir — Путь к рабочей директории для отладочной записи.  
Возвращает  
Объект ProjectPlan при успехе, иначе None.  
Исключения  
JSONDecodeError — При ошибке парсинга ответа агента; перехватывается, возвращается None.

---
def _payload_to_plan(payload: dict, user_goal: str, max_tasks: int) -> Optional[ProjectPlan]  
Преобразует словарь JSON в объект ProjectPlan с валидацией и нормализацией полей.  
Аргументы  
payload — Словарь, полученный из JSON.  
user_goal — Резервная цель проекта, если не указана в payload.  
max_tasks — Ограничивает количество создаваемых задач.  
Возвращает  
Объект ProjectPlan при корректных данных, иначе None.  
Исключения  
Не выбрасывает, все ошибки обрабатываются внутри.

---
async def _notify_plan(session: Session, plan: ProjectPlan, bot, context, dest: dict) -> None  
Отправляет уведомление с текущим состоянием проектного плана в указанный чат.  
Аргументы  
session — Сессия выполнения, содержащая рабочую директорию.  
plan — Проектный план для уведомления.  
bot — Экземпляр бота для отправки сообщений.  
context — Контекст выполнения (например, для Telegram).  
dest — Словарь с назначением, включая chat_id.

---
def _next_ready_task(plan: ProjectPlan) -> Optional[DevTask]  
Возвращает следующую задачу, готовую к выполнению, с учётом зависимостей и нормализации статусов после перезапуска.  
Аргументы  
plan — Проектный план, в котором ищется следующая задача.  
Возвращает  
Готовая задача типа DevTask или None, если нет доступных задач.

---
def _is_plan_blocked(plan: ProjectPlan) -> bool  
Проверяет, заблокирован ли план — все незавершённые задачи находятся в состоянии blocked или failed.  
Аргументы  
plan — Проектный план для проверки.  
Возвращает  
True, если прогресс невозможен из-за блокировок, иначе False.

---
async def _run_loop(session: Session, plan: ProjectPlan, bot, context, dest: dict) -> None  
Основной цикл выполнения плана: последовательно обрабатывает задачи с разработкой, ревью и принятием решений.  
Аргументы  
session — Сессия выполнения с рабочей директорией.  
plan — Проектный план, подлежащий выполнению.  
bot — Экземпляр бота для уведомлений.  
context — Контекст выполнения (например, Telegram).  
dest — Назначение уведомлений, включая chat_id.

---
async def _delegate_develop(self, session: Session, plan: ProjectPlan, task: DevTask) -> Tuple[bool, str]  
Делегирует выполнение задачи разработки CLI-инструменту через сессию.  
Аргументы  
session — Активная сессия выполнения с доступом к CLI.  
plan — Текущий план проекта с контекстом и анализом.  
task — Задача разработки, которую необходимо выполнить.  
Возвращает  
Кортеж из флага успеха и результата (отчёта или сообщения об ошибке).  
Исключения  
asyncio.TimeoutError — При превышении времени выполнения задачи.  
Exception — При других ошибках выполнения.

---
async def _delegate_review(self, session: Session, plan: ProjectPlan, task: DevTask, bot, context, dest: dict) -> ReviewResult  
Делегирует ревью отчёта разработчика специализированному агенту с профилем ревьюера.  
Аргументы  
session — Активная сессия выполнения.  
plan — Текущий план проекта.  
task — Задача, подлежащая ревью.  
bot — Экземпляр бота для отправки уведомлений.  
context — Контекст выполнения (например, Telegram-контекст).  
dest — Словарь назначения для передачи данных между компонентами.  
Возвращает  
Результат ревью в виде объекта ReviewResult.  
Исключения  
Не выбрасывает явных исключений, обрабатывает ошибки внутри и возвращает fallback-результат.

---
def _try_parse_review(self, text: str) -> Optional[ReviewResult]  
Пытается распарсить текст ответа ревьюера как JSON-объект ReviewResult.  
Аргументы  
text — Строка с потенциальным JSON-ответом ревьюера.  
Возвращает  
Объект ReviewResult при успешном парсинге, иначе None.

---
async def _make_decision(self, task: DevTask, review: ReviewResult, workdir: str = "") -> Tuple[str, List[str]]  
Принимает финальное решение по задаче на основе вердикта ревьюера и критериев приёмки с помощью арбитра.  
Аргументы  
task — Задача разработки, по которой принимается решение.  
review — Результат ревью от агент-ревьюера.  
workdir — Рабочая директория для логирования (опционально).  
Возвращает  
Кортеж из итогового вердикта ("approved" или "rejected") и списка причин.  
Исключения  
Не выбрасывает исключений, ошибки парсинга обрабатываются внутри.

---
async def _compose_final_report(self, plan: ProjectPlan, workdir: str = "") -> str  
Формирует финальный отчёт по проекту с использованием LLM на основе данных плана.  
Аргументы  
plan — План проекта, сериализуемый в JSON для передачи модели.  
workdir — Рабочая директория для сохранения отладочной информации (опционально).  
Возвращает  
Строка с отчётом от модели или сообщение об отсутствии ответа.  
Исключения  
Может выбрасывать исключения при ошибках сериализации или вызова chat_completion.

---
async def _run_git(workdir: str, args: List[str]) -> Tuple[int, str]  
Выполняет git-команду в указанной директории и возвращает код завершения и вывод.  
Аргументы  
workdir — Рабочая директория, где выполняется команда.  
args — Аргументы команды git (без префикса "git").  
Возвращает  
Кортеж из кода возврата и вывода команды (включая stderr).  
Исключения  
Не выбрасывает явных исключений, ошибки обрабатываются через код возврата.

---
async def _auto_commit(self, session: Session, task: DevTask, plan: ProjectPlan, bot, context, dest: dict) -> bool  
Выполняет автоматический git-коммит изменений после утверждения задачи.  
Аргументы  
session — Текущая сессия, содержит рабочую директорию.  
task — Утверждённая задача, данные используются для сообщения коммита.  
plan — План проекта, может использоваться для контекста.  
bot — Экземпляр бота для отправки уведомлений.  
context — Контекст выполнения команды бота.  
dest — Словарь с назначением, включая chat_id для уведомлений.  
Возвращает  
True, если коммит был успешно создан, иначе False.  
Исключения  
Не выбрасывает явных исключений, ошибки обрабатываются внутри.

---
def pause(self, session: Session) -> None  
Приостанавливает выполнение плана проекта, устанавливая статус "paused".  
Аргументы  
session — Сессия, в рамках которой находится план проекта.

---
def reset(self, session: Session) -> None  
Сбрасывает план проекта: архивирует текущий (если существует) и удаляет файл плана.  
Аргументы  
session — Сессия, в рамках которой находится план проекта.
