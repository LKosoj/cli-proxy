# agent/plugins/base

Модуль предоставляет базовый функционал для реализации диалоговых сценариев и обработки inline-кнопок в Telegram-ботах. Он включает инструменты для управления состоянием диалога, создания кнопок с привязкой к шагам диалога или автономным действиям, а также единые точки обработки сообщений и колбэков. Модуль предназначен для использования в плагинах, реализующих интерактивные диалоги.

Ключевые структуры данных  
DialogState — состояние активного диалога, включает текущий шаг и произвольные данные

---
def cancel_button() -> Any  
Создаёт inline-кнопку "Отмена" с callback_data для завершения диалога  
Возвращает  
InlineKeyboardMarkup с одной кнопкой "Отмена"

---
def dialog_button(label: str, data: str) -> Any  
Создаёт кнопку, привязанную к текущему диалогу с указанным payload  
Аргументы  
label — отображаемый текст кнопки  
data — строка данных, передаваемая в callback_data  
Возвращает  
InlineKeyboardButton с префиксом `dlg:{plugin_id}:{data}`

---
def action_button(label: str, action: str, payload: str = "") -> Any  
Создаёт кнопку для автономного действия вне диалога  
Аргументы  
label — отображаемый текст кнопки  
action — имя действия, по которому будет вызван обработчик  
payload — дополнительные данные (опционально)  
Возвращает  
InlineKeyboardButton с callback_data вида `cb:{plugin_id}:{action}` или с payload

---
@staticmethod  
def parse_callback_payload(update: Any) -> str  
Извлекает payload из callback_data нажатой кнопки  
Аргументы  
update — объект обновления от Telegram  
Возвращает  
Строку payload из `dlg:...` или `cb:...`, иначе пустую строку

---
def awaiting_input(self, chat_id: int) -> bool  
Проверяет, активен ли диалог с пользователем в указанном чате  
Аргументы  
chat_id — идентификатор чата  
Возвращает  
True, если диалог активен, иначе False

---
def cancel_input(self, chat_id: int) -> bool  
Принудительно завершает активный диалог в указанном чате  
Аргументы  
chat_id — идентификатор чата  
Возвращает  
True, если диалог был завершён, иначе False

---
def dialog_steps(self) -> Dict[str, StepHandler]  
Возвращает отображение шагов диалога на их обработчики  
Возвращает  
Словарь, сопоставляющий имя шага с обработчиком (функция или словарь с "message"/"callback")

---
def callback_handlers(self) -> Dict[str, Callable]  
Возвращает отображение имён действий на их автономные обработчики  
Возвращает  
Словарь, сопоставляющий имя действия с асинхронной функцией (update, context, payload)

---
def step_hint(self, step: str) -> Optional[str]  
Возвращает подсказку для пользователя при некорректном вводе на указанном шаге  
Аргументы  
step — имя текущего шага диалога  
Возвращает  
Текст подсказки или None, если подсказка не требуется

---
def _resolve_step_handler(self, step: str, kind: str = "message") -> Optional[Callable]  
Находит обработчик для указанного шага и типа события  
Аргументы  
step — имя шага диалога  
kind — тип обработчика: "message" или "callback"  
Возвращает  
Функцию-обработчик или None, если не найдена

---
async def handle_message(self, update: Any, context: Any) -> bool  
Обрабатывает входящее текстовое или медиа-сообщение в контексте активного диалога  
Аргументы  
update — объект обновления от Telegram  
context — контекст выполнения от библиотеки python-telegram-bot  
Возвращает  
True, если сообщение обработано диалогом, иначе False  
Исключения  
Любые исключения логируются, диалог завершается, пользователю отправляется сообщение об ошибке

---
async def handle_callback(self, update: Any, context: Any) -> bool  
Обрабатывает нажатие inline-кнопки в контексте диалога или автономного действия  
Аргументы  
update — объект обновления с callback_query  
context — контекст выполнения  
Возвращает  
True, если колбэк был обработан, иначе False  
Исключения  
Любые исключения логируются, диалог завершается, пользователю отправляется уведомление об ошибке

---
class DialogMixin  
Миксин для реализации интерактивных диалогов в плагинах  
Поля  
CANCEL_WORDS — множество текстов, распознаваемых как команда отмены  
DIALOG_TIMEOUT — таймаут диалога в секундах, после которого состояние сбрасывается  
Методы  
_dialogs() — возвращает хранилище диалогов, привязанное к экземпляру  
start_dialog(chat_id: int, step: str, data: Optional[Dict[str, Any]] = None, user_id: int = 0) — запускает новый диалог в указанном чате  
end_dialog(chat_id: int) — завершает диалог в указанном чате  
get_dialog(chat_id: int) — возвращает активное состояние диалога для чата  
set_step(chat_id: int, step: str, data: Optional[Dict[str, Any]] = None) — переводит диалог в новый шаг и обновляет данные  
_ensure_agent_enabled(context: Any) — проверяет, включён ли агент в текущем контексте  
is_cancel_text(text: str) — проверяет, является ли текст командой отмены  
_plugin_id_safe() — возвращает идентификатор плагина, безопасно обрабатывая отсутствие метода  
_cancel_callback_data() — генерирует уникальный callback_data для кнопки отмены  
cancel_markup() — возвращает разметку с кнопкой «Отмена» для инлайн-клавиатуры  
_dialog_callback_commands() — возвращает обработчик CallbackQueryHandler для всех колбэков плагина  
_on_cancel(update, context) — обрабатывает нажатие кнопки отмены  
_on_dialog_callback(update, context) — обрабатывает колбэк в рамках активного диалога  
_on_standalone_callback(update, context) — обрабатывает автономные колбэки (вне диалога)  
dialog_steps() — возвращает словарь шагов диалога и их обработчиков  
callback_handlers() — возвращает словарь автономных колбэк-действий  
handle_message(update, context) — обрабатывает входящее текстовое сообщение в контексте диалога  
handle_callback(update, context) — обрабатывает колбэк-запрос в контексте диалога  
get_message_handlers() — возвращает конфигурацию обработчиков сообщений для диалогов  
awaiting_input(chat_id: int) — проверяет, ожидает ли плагин ввода в указанном чате  
cancel_input(chat_id: int) — отменяет активный диалог в чате  
button(label: str, action: str) — создаёт конфигурацию кнопки для инлайн-меню  
callback_data(action: str) — генерирует callback_data для автономного действия  
dialog_data(step: str) — генерирует callback_data для шага диалога
