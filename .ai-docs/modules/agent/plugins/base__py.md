# agent/plugins/base

Базовый модуль для реализации плагинов инструментов (tools) в агентной системе. Определяет абстрактный класс `ToolPlugin` как основу для всех плагинов, а также предоставляет миксин `DialogMixin` для поддержки интерактивных диалогов с пользователем. Включает стандартные механизмы управления состоянием, обработки команд и интеграции с Telegram UI.

Ключевые структуры данных  
DialogState — состояние активного диалога для одного чата, включая текущий шаг, данные, ID пользователя и время начала  
StepHandler — Тип, описывающий обработчик шага диалога: может быть вызываемым объектом или словарём с ключами "message" и/или "callback"

---
class ToolPlugin  
Абстрактный базовый класс для всех плагинов инструментов.  
Поля  
plugin_id — опциональный строковый идентификатор плагина; если не задан, используется имя класса.  
function_prefix — префикс для имен функций плагина; если не задан, используется результат get_plugin_id().  
Методы  
get_plugin_id() -> str — возвращает уникальный идентификатор плагина.  
get_function_prefix() -> str — возвращает префикс, используемый при регистрации функций.  
initialize(config: Any = None, services: Optional[Dict[str, Any]] = None) -> None — инициализирует плагин с конфигурацией и сервисами.  
close() -> None — вызывается при завершении работы плагина; по умолчанию не делает ничего.  
get_source_name() -> str — возвращает имя источника, используемое в логах; по умолчанию — результат get_plugin_id().  
get_commands() -> List[Dict[str, Any]] — возвращает список доступных команд плагина; по умолчанию — пустой список.  
get_message_handlers() -> List[Dict[str, Any]] — возвращает конфигурации обработчиков текстовых сообщений; по умолчанию — пустой список.  
get_inline_handlers() -> List[Dict[str, Any]] — возвращает конфигурации обработчиков инлайн-запросов; по умолчанию — пустой список.  
get_menu_label() -> Optional[str] — возвращает метку для отображения в главном меню плагинов; если None — скрыт.  
get_menu_actions() -> List[Dict[str, str]] — возвращает список действий для подменю плагина; каждое действие содержит "label" и "action".  
awaiting_input(chat_id: int) -> bool — возвращает True, если плагин ожидает ввода от пользователя в указанном чате.  
cancel_input(chat_id: int) -> bool — отменяет активный диалог в чате; возвращает True, если диалог был отменён.  
get_spec() -> ToolSpec — абстрактный метод, возвращающий спецификацию инструмента.  
execute(args: Dict[str, Any], ctx: Dict[str, Any]) -> Dict[str, Any] — абстрактный метод, выполняющий логику инструмента.

---
class DialogMixin  
Миксин, предоставляющий стандартный протокол для многошаговых интерактивных диалогов.  
Поля  
CANCEL_WORDS — набор слов, распознаваемых как команда отмены диалога.  
DIALOG_TIMEOUT — таймаут (в секундах) неактивного диалога; по умолчанию 300 секунд.  
Методы  
_dialogs() -> Dict[int, DialogState] — возвращает хранилище активных диалогов, привязанное к экземпляру плагина.  
start_dialog(chat_id: int, step: str, data: Optional[Dict[str, Any]] = None, user_id: int = 0) -> None — начинает новый диалог в указанном чате.  
end_dialog(chat_id: int) -> None — завершает и удаляет диалог в указанном чате.  
get_dialog(chat_id: int) -> Optional[DialogState] — возвращает текущее состояние диалога, если оно активно; иначе None.  
set_step(chat_id: int, step: str, data: Optional[Dict[str, Any]] = None) -> None — изменяет текущий шаг диалога и обновляет данные.  
_ensure_agent_enabled(context: Any) -> bool — проверяет, включён ли агент в текущей сессии; возвращает False при ошибках.  
is_cancel_text(text: str) -> bool — проверяет, является ли текст одним из слов отмены.  
_plugin_id_safe() -> str — безопасно получает plugin_id плагина или использует имя класса.  
_cancel_callback_data() -> str — генерирует уникальную строку callback_data для кнопки отмены.  
cancel_markup() -> Any — возвращает объект InlineKeyboardMarkup с кнопкой «Отмена», привязанной к текущему плагину.

---
dialog_button(label: str, data: str) -> Any  
Создаёт кнопку с callback_data, привязанную к текущему диалогу плагина.  
Аргументы  
label — Текст кнопки, отображаемый пользователю  
data — Данные, включаемые в callback_data; будут доступны при обработке нажатия  
Возвращает  
Объект InlineKeyboardButton с префиксом `dlg:{plugin_id}:{data}` в callback_data

---
action_button(label: str, action: str, payload: str = "") -> Any  
Создаёт кнопку для автономного действия вне диалога.  
Аргументы  
label — Текст кнопки  
action — Идентификатор действия, по которому будет выбран обработчик  
payload — Дополнительные данные, передаваемые обработчику (опционально)  
Возвращает  
Объект InlineKeyboardButton с callback_data вида `cb:{plugin_id}:{action}` или `cb:{plugin_id}:{action}:{payload}`

---
@staticmethod parse_callback_payload(update: Any) -> str  
Извлекает полезную нагрузку из callback_data нажатой кнопки.  
Аргументы  
update — Объект обновления от Telegram  
Возвращает  
Строку с payload из callback_data; пустую строку, если payload отсутствует или формат не распознан

---
awaiting_input(chat_id: int) -> bool  
Проверяет, активен ли диалог с указанным чатом.  
Аргументы  
chat_id — Идентификатор чата  
Возвращает  
True, если диалог активен; иначе False

---
cancel_input(chat_id: int) -> bool  
Завершает активный диалог в указанном чате.  
Аргументы  
chat_id — Идентификатор чата  
Возвращает  
True, если диалог был завершён; иначе False

---
dialog_steps() -> Dict[str, StepHandler]  
Возвращает отображение имён шагов диалога на их обработчики.  
Возвращает  
Словарь, где ключ — имя шага, значение — обработчик (вызываемый объект или словарь с "message"/"callback")

---
callback_handlers() -> Dict[str, Callable]  
Возвращает отображение имён автономных действий на их обработчики.  
Возвращает  
Словарь, где ключ — имя действия, значение — асинхронная функция с сигнатурой `(update, context, payload)`

---
step_hint(step: str) -> Optional[str]  
Возвращает подсказку для пользователя при некорректном вводе на указанном шаге.  
Аргументы  
step — Имя текущего шага диалога  
Возвращает  
Текст подсказки или None, если подсказка не требуется

---
_resolve_step_handler(step: str, kind: str = "message") -> Optional[Callable]  
Определяет обработчик для указанного шага и типа события.  
Аргументы  
step — Имя шага диалога  
kind — Тип обработчика: "message" или "callback"  
Возвращает  
Вызываемый объект обработчика или None, если не найден

---
handle_message(update: Any, context: Any) -> bool  
Унифицированный обработчик входящих текстовых и медиа-сообщений во время активного диалога.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения от Telegram  
Возвращает  
True, если сообщение было обработано диалогом; иначе False  
Исключения  
Любые исключения логируются, диалог завершается, пользователю отправляется сообщение об ошибке

---
handle_callback(update: Any, context: Any) -> None  
Унифицированный обработчик нажатий на inline-кнопки в рамках активного диалога.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения от Telegram  
Исключения  
Любые исключения логируются, диалог завершается, пользователю отправляется сообщение об ошибке

---
async def handle_callback(update: Any, context: Any) -> None  
Обрабатывает callback-запрос на текущем шаге диалога.  
Аргументы  
update — объект обновления от Telegram, содержащий callback_query  
context — контекст выполнения от telegram.ext  
Исключения  
Любые исключения логируются, диалог завершается, пользователь получает уведомление об ошибке

---
async def _dispatch_callback(update: Any, context: Any) -> None  
Центральная точка входа для обработки всех callback-данных, маршрутизирует по префиксу.  
Аргументы  
update — объект обновления с callback_query  
context — контекст выполнения

---
async def _on_cancel_button(update: Any, context: Any) -> None  
Обрабатывает нажатие кнопки отмены диалога (callback_data="dlg_cancel:...").  
Аргументы  
update — объект обновления с callback_query  
context — контекст выполнения

---
def _dialog_callback_commands() -> List[Dict[str, Any]]  
Возвращает конфигурацию обработчика колбэков для регистрации в get_commands.  
Возвращает  
Список словарей с настройками обработчика callback-запросов

---
def _dialog_active_filter() -> Any  
Создаёт фильтр, пропускающий только сообщения из чатов с активным диалогом.  
Возвращает  
Объект-фильтр telegram.ext.filters, проверяющий активность диалога по chat_id

---
def get_message_handlers() -> List[Dict[str, Any]]  
Возвращает список обработчиков сообщений, привязанных к активным диалогам.  
Возвращает  
Список конфигураций обработчиков для текстовых (и дополнительных) сообщений

---
def extra_message_filters() -> Any  
Переопределяется для добавления поддержки не-текстовых типов (например, PHOTO).  
Возвращает  
Фильтр telegram.ext.filters для дополнительных типов контента (по умолчанию — пустой)
