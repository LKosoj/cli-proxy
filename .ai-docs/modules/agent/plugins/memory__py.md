# agent/plugins/memory

Модуль реализует инструмент долговременной памяти для агента, позволяющий сохранять, читать и очищать текстовые записи с автоматическим добавлением временных меток. Данные хранятся в файле на диске и сохраняются между сессиями. Инструмент интегрируется в Telegram-интерфейс через меню и команды, поддерживает диалоговый ввод и может вызываться через API агента.

Ключевые структуры данных  
MEMORY_FILE — имя файла по умолчанию для хранения записей памяти (определяется в `agent.tooling.helpers`)

---
def get_menu_label()  
Возвращает метку инструмента в меню.  
Возвращает  
Строка с локализованной меткой "Память"

---
def get_menu_actions()  
Возвращает список действий, доступных в меню инструмента.  
Возвращает  
Список словарей с полями "label" (отображаемое имя) и "action" (идентификатор действия): "Показать", "Добавить запись", "Очистить"

---
def get_commands() -> List[Dict[str, Any]]  
Возвращает команды, ассоциированные с диалоговыми действиями инструмента.  
Возвращает  
Список команд, сгенерированных через `_dialog_callback_commands`

---
def dialog_steps()  
Определяет шаги диалога для интерактивного взаимодействия.  
Возвращает  
Словарь шагов диалога: "wait_content" → обработчик `_on_content`

---
def callback_handlers() -> Dict[str, Callable]  
Возвращает сопоставление идентификаторов действий с обработчиками колбэков.  
Возвращает  
Словарь: "read" → `_cb_read`, "append" → `_cb_append`, "clear" → `_cb_clear`

---
def get_spec() -> ToolSpec  
Возвращает спецификацию инструмента для использования в системе планирования агента.  
Возвращает  
Объект `ToolSpec` с именем "memory", описанием и параметрами для действий read, append, clear  
Исключения  
Не выбрасывает исключения

---
def _memory_path() -> str  
Формирует путь к файлу памяти на основе конфигурации или переменных окружения.  
Возвращает  
Полный путь к файлу памяти, расположенному в рабочей директории или в `AGENT_SANDBOX_ROOT`

---
async def _cb_read(update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Обрабатывает колбэк для отображения содержимого памяти.  
Аргументы  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
payload — строка полезной нагрузки (не используется)  
Исключения  
Любые ошибки чтения файла обрабатываются внутри метода, исключение не выбрасывается

---
async def _cb_append(update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Инициирует диалог добавления новой записи в память.  
Аргументы  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
payload — строка полезной нагрузки (не используется)  
Исключения  
Не выбрасывает исключения

---
async def _cb_clear(update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Обрабатывает колбэк для очистки содержимого памяти.  
Аргументы  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
payload — строка полезной нагрузки (не используется)  
Исключения  
Не выбрасывает исключения

---
async def _on_content(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Обрабатывает ввод пользователя при добавлении записи в память.  
Аргументы  
update — объект обновления от Telegram (содержит введённое сообщение)  
context — контекст выполнения Telegram-бота  
Исключения  
Не выбрасывает исключения

---
async def execute(args: Dict[str, Any], ctx: Dict[str, Any]) -> Dict[str, Any]  
Выполняет действие с памятью по API (чтение, добавление, очистка).  
Аргументы  
args — словарь с параметрами: "action" (обязательный), "content" (для append)  
ctx — контекст выполнения, содержит "state_root" или "cwd" для определения пути  
Возвращает  
Словарь с результатом: {"success": bool, "output": str, "error": str (опционально)}  
Исключения  
Не выбрасывает исключения
