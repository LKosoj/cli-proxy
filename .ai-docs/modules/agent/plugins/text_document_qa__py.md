# agent/plugins/text_document_qa

Модуль реализует инструмент для работы с текстовыми документами в рамках агента: загрузка, просмотр списка, задание вопросов по содержимому и удаление. Документы сохраняются в виде текстовых файлов с метаданными, а взаимодействие происходит через диалоговый интерфейс Telegram. Поддерживается интеграция с LLM через AsyncOpenAI для ответов на вопросы по документам.

Ключевые структуры данных  
ToolSpec — Описание интерфейса инструмента, включая параметры и поведение  
DialogMixin — Базовый класс для управления пошаговыми диалогами с пользователем

---
async def _cb_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Показывает список доступных документов с кнопками действий.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения Telegram-бота  
payload — Дополнительные данные (не используются)  
Возвращает  
None  
Исключения  
Возможны исключения при работе с Telegram API

---
async def _cb_upload(self, update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Запускает диалог загрузки нового документа, запрашивая имя.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения Telegram-бота  
payload — Дополнительные данные (не используются)  
Возвращает  
None  
Исключения  
Возможны исключения при работе с Telegram API

---
async def _cb_ask(self, update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Показывает список документов для выбора, по которому будет задан вопрос.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения Telegram-бота  
payload — Дополнительные данные (не используются)  
Возвращает  
None  
Исключения  
Возможны исключения при работе с Telegram API

---
async def _cb_ask_doc(self, update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Начинает диалог вопроса по конкретному документу, указанному в payload.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения Telegram-бота  
payload — ID документа, по которому будет задан вопрос  
Возвращает  
None  
Исключения  
Возможны исключения при работе с Telegram API

---
async def _cb_delete(self, update: Update, context: ContextTypes.DEFAULT_TYPE, payload: str) -> None  
Удаляет документ по его ID.  
Аргументы  
update — Объект обновления от Telegram  
context — Контекст выполнения Telegram-бота  
payload — ID документа для удаления  
Возвращает  
None  
Исключения  
Возможны исключения при работе с файловой системой или Telegram API

---
def _list_documents(self) -> List[Dict[str, str]]  
Возвращает список доступных документов с их ID и заголовками.  
Аргументы  
Нет  
Возвращает  
Список словарей с ключами "id" и "title" для каждого документа  
Исключения  
Нет явных исключений, ошибки чтения метаданных подавляются

---
def _build_doc_list_keyboard(self, docs: List[Dict[str, str]]) -> List[list]  
Формирует клавиатуру с кнопками действий для каждого документа.  
Аргументы  
docs — Список документов (с "id" и "title")  
Возвращает  
Двумерный список кнопок для InlineKeyboardMarkup  
Исключения  
Нет

---
def _storage_dir(self, state_root: str) -> str  
Формирует путь к директории хранения документов.  
Аргументы  
state_root — Корневая директория состояния агента  
Возвращает  
Путь к директории для хранения текстовых документов  
Исключения  
Нет

---
def _ui_state_root(self) -> str  
Определяет корневую директорию состояния, используя переменные окружения или конфигурацию.  
Аргументы  
Нет  
Возвращает  
Путь к рабочей директории агента  
Исключения  
Нет

---
class TextDocumentQATool(DialogMixin, ToolPlugin)  
Инструмент для диалогового взаимодействия с текстовыми документами: загрузка, список, вопросы, удаление.  
Поля  
Нет публичных полей  
Методы  
get_source_name — Возвращает имя источника инструмента  
get_spec — Возвращает спецификацию инструмента для использования в системе  
get_menu_label — Возвращает метку для меню  
get_menu_actions — Возвращает список действий для отображения в меню  
get_commands — Возвращает команды, связанные с диалогами  
dialog_steps — Определяет шаги диалога и соответствующие обработчики  
callback_handlers — Возвращает сопоставление действий с асинхронными обработчиками

---
class DocumentTool  
Инструмент для управления документами через Telegram-бота с поддержкой диалогов и хранения на диске.  
Поля  
_ui_state_root — функция, возвращающая корневую директорию состояния  
_storage_dir — метод, возвращающий путь к директории хранения документов  
get_dialog — метод получения состояния диалога пользователя  
set_step — метод установки шага диалога  
end_dialog — метод завершения диалога  
parse_callback_payload — извлекает данные из callback-запроса  
cancel_markup — возвращает клавиатуру с кнопкой отмены  
_build_doc_list_keyboard — строит клавиатуру из списка документов  
_list_documents — возвращает список документов  
Методы  
_on_start — обработчик команды /start  
_on_upload — начало загрузки документа  
_on_list — отображение списка документов  
_on_delete_button — обработка удаления документа  
_on_name — обработка ввода имени  
_on_content — обработка ввода содержимого  
_on_doc_select_button — выбор документа для вопроса  
_on_query — обработка вопроса по документу  
execute — основной метод выполнения действий с документами

---
class DialogState  
состояние диалога пользователя, включает текущий шаг и пользовательские данные

---
async def _on_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Запускает диалог выбора действия: загрузка или просмотр документов.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_upload(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Начинает процесс загрузки документа, запрашивая у пользователя имя.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Отображает список доступных документов с кнопками для вопроса и удаления.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_delete_button(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Обрабатывает нажатие кнопки удаления документа.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Обрабатывает ввод имени документа, переходит к шагу ввода содержимого.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_content(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Принимает содержимое документа и сохраняет его через execute.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_doc_select_button(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Обрабатывает выбор документа для задания вопроса.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def _on_query(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None  
Принимает вопрос пользователя по выбранному документу и возвращает ответ.  
Аргументы  
self — экземпляр класса  
update — объект обновления от Telegram  
context — контекст выполнения Telegram-бота  
Возвращает  
None  
Исключения  
Не выбрасывает явных исключений

---
async def execute(self, args: Dict[str, Any], ctx: Dict[str, Any]) -> Dict[str, Any]  
Выполняет действия с документами: загрузку, список, удаление, вопрос по документу.  
Аргументы  
args — словарь с действием и параметрами (action, file_name, file_content, document_id, query)  
ctx — контекст выполнения (state_root, cwd)  
Возвращает  
Словарь с результатом: {"success": bool, "output": str, "error": str}  
Исключения  
Не выбрасывает напрямую, но логирует ошибки ввода-вывода

---
class AsyncOpenAI  
Асинхронный клиент для взаимодействия с OpenAI-совместимым API  
Методы  
create — создаёт асинхронный запрос на генерацию ответа в чате по заданной модели и списку сообщений

---
def read_and_query_document(action: str, path: str, q: str) -> dict  
Выполняет чтение документа и генерацию ответа на вопрос с помощью LLM  
Аргументы  
action — строка действия; допустимо только "query", иначе возвращается ошибка  
path — путь к текстовому файлу, который будет прочитан  
q — вопрос, на который требуется ответить на основе содержимого документа  
Возвращает  
Словарь с ключами "success" (логическое значение), "output" (ответ при успехе) или "error" (сообщение об ошибке при неудаче)  
Исключения  
Все исключения при чтении файла или вызове API перехватываются и возвращаются в виде словаря с "success": False
