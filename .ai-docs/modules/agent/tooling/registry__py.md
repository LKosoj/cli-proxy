# agent/tooling/registry

Модуль предоставляет централизованное управление инструментами (tools), включая их регистрацию, выполнение и состояние.  
Поддерживает параллельное и последовательное выполнение вызовов инструментов в зависимости от их спецификаций.  
Сохраняет контекст выполнения, управляет отложенными вопросами и недавними сообщениями.  
Реализует шаблон одиночки (singleton) для глобального доступа к реестру инструментов в пределах процесса.

Ключевые структуры данных  
ToolRegistry — Основной класс, управляющий инструментами, их спецификациями, состоянием и выполнением

---
class ToolRegistry  
Реестр инструментов, управляющий загрузкой, регистрацией и доступом к плагинам инструментов.  
Поля  
config — Конфигурация приложения  
plugins — Словарь зарегистрированных плагинов по имени  
plugin_instances — Кэш экземпляров плагинов  
specs — Словарь спецификаций инструментов по имени  
_pending_questions — Хранилище ожидающих вопросов  
_recent_messages — Хранилище последних сообщений по чатам  
_task_store — Хранилище задач  
_scheduler_tasks — Хранилище задач планировщика  
_user_tasks — Хранилище пользовательских задач  
_mcp_manager — Менеджер MCP для работы с удалёнными инструментами  
_mcp_loaded — Флаг загрузки MCP-инструментов  
_mcp_lock — Асинхронная блокировка для синхронизации загрузки MCP  
_mcp_tool_keys — Множество ключей загруженных MCP-инструментов  
Методы  
__init__(self, config: Any) — Инициализирует реестр инструментов с заданной конфигурацией. Загружает локальные плагины и кэшированные MCP-инструменты.  
_load_plugins(self) — Загружает локальные плагины из директории plugins.  
_unique_tool_name(self, base: str) -> str — Генерирует уникальное имя инструмента, добавляя суффикс при необходимости.  
_register_mcp_cached_tools(self) — Регистрирует кэшированные MCP-инструменты при инициализации.  
ensure_mcp_loaded(self) — Асинхронно загружает все доступные MCP-инструменты, если они ещё не загружены.  
_build_services(self) -> Dict[str, Any] — Формирует словарь общих сервисов, доступных плагинам.  
register(self, plugin: ToolPlugin) — Регистрирует плагин в реестре после его инициализации и валидации спецификации.  
_normalize_spec_name(self, spec: ToolSpec, plugin: ToolPlugin) -> str — Нормализует имя инструмента с учётом префикса плагина.  
list_tool_names(self) -> List[str] — Возвращает отсортированный список имён всех зарегистрированных инструментов.  
get_definitions(self, allowed_tools: Optional[List[str]] = None, model_family: str = "openai") -> List[Dict[str, Any]] — Возвращает спецификации инструментов в формате, совместимом с указанной моделью.  
get_definitions_async(self, allowed_tools: Optional[List[str]] = None, model_family: str = "openai") -> List[Dict[str, Any]] — Асинхронно возвращает спецификации инструментов, предварительно загрузив MCP-инструменты.  
get_plugin_commands(self, allowed_tools: Optional[List[str]] = None) -> List[Dict[str, Any]] — Возвращает команды всех разрешённых плагинов с проверкой на уникальность.  
any_awaiting_input(self, chat_id: int) -> bool — Проверяет, ожидает ли какой-либо плагин ввода от пользователя в указанном чате.  
cancel_all_inputs(self, chat_id: int) -> int — Отменяет все ожидающие ввода диалоги во всех плагинах для указанного чата.  
get_message_handlers(self, allowed_tools: Optional[List[str]] = None) -> List[Dict[str, Any]] — Возвращает обработчики сообщений от разрешённых плагинов.

---
async def execute_parallel_or_sequential(self, calls: List[Dict], ctx: Any) -> List[Any]  
Выполняет список вызовов инструментов параллельно или последовательно в зависимости от их parallelizable флага  
Аргументы  
calls — Список словарей с полями name/tool, args/arguments  
ctx — Контекст выполнения, передаваемый в инструменты  
Возвращает  
Список результатов выполнения каждого инструмента в порядке вызова  
Исключения  
Может выбрасывать исключения, возникающие при выполнении отдельных инструментов

---
def record_message(self, chat_id: int, message_id: int) -> None  
Сохраняет идентификатор сообщения в истории для указанного чата, ограничивая размер истории 20 последними сообщениями  
Аргументы  
chat_id — Уникальный идентификатор чата  
message_id — Идентификатор сообщения для сохранения

---
def resolve_question(self, question_id: str, answer: str) -> bool  
Устанавливает результат для ожидающего вопроса по его идентификатору, завершая соответствующий future  
Аргументы  
question_id — Идентификатор вопроса  
answer — Текст ответа  
Возвращает  
True, если вопрос был найден и успешно разрешён; иначе False

---
def close_all(self) -> None  
Корректно завершает работу всех загруженных плагинов, вызывая их метод close  
Исключения  
Любые исключения при закрытии плагина логируются, но не прерывают выполнение

---
def get_missing_suggestions(self, name: str) -> List[str]  
Возвращает список из до 3 рекомендаций имён инструментов, близких к заданному имени, на основе нечёткого поиска  
Аргументы  
name — Имя инструмента, для которого ищутся рекомендации  
Возвращает  
Список похожих имён инструментов

---
def get_tool_registry(config: Any) -> ToolRegistry  
Возвращает единый экземпляр реестра инструментов для текущего процесса, инициализируя его при первом вызове  
Аргументы  
config — Конфигурация для инициализации реестра, если он ещё не создан  
Возвращает  
Единственный экземпляр ToolRegistry для текущего процесса
