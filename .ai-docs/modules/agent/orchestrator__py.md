# agent/orchestrator

Модуль OrchestratorRunner управляет выполнением задач пользователя, координируя планирование, исполнение шагов и агрегацию результатов. Поддерживает контекст выполнения через сессии и память, адаптируется к промежуточным результатам с перепланированием, и формирует итоговый ответ с использованием LLM. Работает в песочнице и интегрируется с внешними инструментами через диспетчер.

Ключевые структуры данных  
PlanStep — Описание одного шага в плане выполнения задачи, включая заголовок, тип и зависимости.  
ExecutorRequest — Запрос к исполнителю для выполнения конкретного шага.  
ExecutorResponse — Ответ от исполнителя после выполнения шага, включая результаты и статус.

---
class OrchestratorRunner  
Координирует процесс выполнения пользовательской задачи: планирование, исполнение, адаптацию и финализацию.  
Поля  
_config — Конфигурация приложения (AppConfig).  
_executor — Исполнитель шагов (Executor).  
_dispatcher — Диспетчер инструментов (Dispatcher).  
_log — Логгер для внутренних сообщений.  
Методы  
__init__(self, config: AppConfig) — Инициализирует оркестратор с заданной конфигурацией.  
_load_session(self, cwd: str) -> Dict[str, Any] — Загружает сессионные данные из SESSION.json.  
_build_orchestrator_context(self, session_data: Dict[str, Any], task_key: str) -> str — Формирует текстовый контекст истории оркестратора.

---
async run(self, session: Any, user_text: str, bot: Any, context: Any, dest: Dict[str, Any]) -> str  
Запускает полный цикл обработки пользовательского запроса: планирование, выполнение шагов, финализация.  
Аргументы  
session — Объект сессии с уникальным идентификатором.  
user_text — Текст запроса пользователя.  
bot — Бот-транспорт для отправки ответов (может быть None).  
context — Контекст выполнения (не используется напрямую).  
dest — Словарь с назначением (например, chat_id, chat_type).  
Возвращает  
Финальный текстовый ответ на запрос пользователя.  
Исключения  
Логирует ошибки, но не выбрасывает напрямую; ожидается обработка внутри.

---
async def compose_final_answer(session: Session, bot: Bot, context: Context, dest: Destination, step_results: List[dict], artifacts: List[dict], corr_id: str, chat_id: int) -> str  
Формирует и отправляет финальный ответ пользователю, включая основной результат и дополнительные материалы.  
Аргументы  
session — сессия взаимодействия с пользователем  
bot — экземпляр бота для отправки сообщений  
context — контекст выполнения  
dest — назначение для отправки выходных данных  
step_results — список результатов выполненных шагов  
artifacts — список файлов (артефактов) для отправки  
corr_id — идентификатор корреляции для логирования  
chat_id — идентификатор чата для отправки сообщений  
Возвращает  
Итоговый текстовый результат, объединённый из результатов шагов  
Исключения  
Любое исключение логируется, но не прерывает выполнение; при ошибках отправки используется резервный ответ

---
def _seed_completed_sets(steps: List[PlanStep]) -> tuple[set[str], set[str]]  
Инициализирует множества успешно и неуспешно завершённых шагов на основе предыдущих результатов.  
Аргументы  
steps — список шагов плана  
Возвращает  
Кортеж из двух множеств: идентификаторы шагов с успешным и неуспешным статусом

---
def _progress_context() -> str  
Формирует ограниченное текстовое представление последних результатов шагов для использования в контексте перепланирования.  
Возвращает  
JSON-строка с последними 25 результатами шагов или пустая строка при ошибке

---
async def plan_steps(config: Config, user_text: str, context: str) -> List[PlanStep]  
Генерирует план выполнения в виде списка шагов на основе пользовательского запроса и текущего контекста.  
Аргументы  
config — конфигурация планировщика  
user_text — исходный или дополненный текст запроса пользователя  
context — дополнительный контекст выполнения (например, предыдущие результаты)  
Возвращает  
Список шагов выполнения (PlanStep), сформированных на основе анализа запроса и контекста  
Исключения  
Может выбрасывать исключения при ошибках генерации плана, которые обрабатываются на уровне вызывающего кода

---
def _order_steps_safely(steps: List[PlanStep]) -> List[PlanStep]  
Упорядочивает шаги с учётом зависимостей (depends_on), обеспечивая корректную последовательность выполнения.  
Аргументы  
steps — исходный список шагов  
Возвращает  
Новый список шагов, упорядоченный топологически с разрешением зависимостей

---
def _next_batch(steps: List[PlanStep], completed_ok: set[str], completed_fail: set[str], session_id: str) -> tuple[List[PlanStep], List[ExecutorResponse]]  
Определяет следующую порцию шагов для выполнения, учитывая зависимости и статусы завершённых шагов.  
Аргументы  
steps — полный список шагов плана  
completed_ok — множество идентификаторов успешно завершённых шагов  
completed_fail — множество идентификаторов завершённых с ошибкой шагов  
session_id — идентификатор сессии (для логирования)  
Возвращает  
Кортеж: список шагов для выполнения и список пропущенных шагов с их результатами

---
async def _execute_step(step: PlanStep, session: Session, bot: Bot, context: Context, dest: Destination, ctx_summary: str) -> ExecutorResponse  
Выполняет один шаг плана, включая вызов соответствующего инструмента или обработку специальных типов шагов.  
Аргументы  
step — шаг для выполнения  
session — активная сессия  
bot — бот для взаимодействия  
context — контекст выполнения  
dest — место назначения для вывода  
ctx_summary — краткое описание текущего контекста  
Возвращает  
Результат выполнения шага, включая статус, вывод и метаданные

---
def _apply_step_result(step: PlanStep, response: ExecutorResponse, completed_ok: set[str], completed_fail: set[str]) -> None  
Обновляет состояния множеств завершённых шагов на основе результата выполнения.  
Аргументы  
step — выполненный шаг  
response — результат выполнения  
completed_ok — множество успешно завершённых шагов (обновляется)  
completed_fail — множество завершённых с ошибкой шагов (обновляется)

---
def _is_success_status(status: str) -> bool  
Определяет, является ли статус выполнения шага успешным.  
Аргументы  
status — строка статуса (например, "ok", "partial", "error")  
Возвращает  
True, если статус считается успешным

---
async def run_step(self, session: Session, step: Step, req: Request, bot: Bot, context: Context, dest: str, profile: Profile, corr_id: str) -> ExecutorResponse  
Выполняет один шаг диалога, взаимодействуя с исполнителем и обновляя состояние сессии.  
Аргументы  
session — активная сессия пользователя  
step — описание текущего шага выполнения  
req — входной запрос от пользователя  
bot — экземпляр бота для взаимодействия  
context — контекст выполнения диалога  
dest — целевой адресата или назначение сообщения  
profile — профиль пользователя с настройками и разрешёнными инструментами  
corr_id — идентификатор корреляции для логирования  
Возвращает  
Объект ответа от исполнителя с результатом выполнения шага  
Исключения  
Может выбрасывать исключения, связанные с сетевыми вызовами или внутренней логикой исполнителя

---
def record_message(self, chat_id: int, message_id: int) -> None  
Фиксирует отправленное сообщение в системе для последующей ссылки или редактирования.  
Аргументы  
chat_id — идентификатор чата  
message_id — идентификатор отправленного сообщения

---
def resolve_question(self, question_id: str, answer: str) -> bool  
Разрешает ожидающий вопрос от системы, передавая пользовательский ответ.  
Аргументы  
question_id — идентификатор вопроса, на который поступил ответ  
answer — текст ответа от пользователя  
Возвращает  
True, если вопрос успешно разрешён; иначе False

---
def clear_session_cache(self, session_id: str) -> None  
Очищает кэш данных сессии для указанного идентификатора.  
Аргументы  
session_id — идентификатор сессии, данные которой следует очистить

---
def get_plugin_commands(self, profile: Any) -> Dict[str, Any]  
Возвращает доступные команды плагинов, разрешённые для указанного профиля.  
Аргументы  
profile — профиль пользователя, определяющий доступные плагины  
Возвращает  
Словарь команд плагинов, доступных пользователю

---
def get_plugin_ui(self, profile: Any) -> Dict[str, Any]  
Возвращает конфигурацию UI-компонентов плагинов, соответствующих профилю.  
Аргументы  
profile — профиль пользователя  
Возвращает  
Словарь с описанием UI-интерфейсов плагинов

---
async def _maybe_update_memory(self, user_text: str, final_response: str, memory_text: str, cwd: str) -> None  
Принимает решение о необходимости обновления памяти агента и при необходимости сжимает её.  
Аргументы  
user_text — текст запроса пользователя  
final_response — итоговый ответ агента  
memory_text — текущее содержимое памяти  
cwd — рабочая директория агента, где хранится память  
Исключения  
Может выбрасывать исключения при ошибках чтения/записи файлов или работе с LLM при компрессии
