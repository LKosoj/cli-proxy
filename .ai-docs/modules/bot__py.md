# bot

BotApp — Основной класс приложения Telegram-бота для управления сессиями агента, выполнения команд, взаимодействия с Git, обработки файлов и отображения интерфейсов. Интегрирует асинхронные компоненты: Telegram-бот, менеджер сессий, оркестратор агента, Git-операции и метрики. Обеспечивает безопасную песочницу для выполнения команд, буферизацию сообщений и обработку пользовательского ввода через callback-интерфейсы.

Ключевые структуры данных
PendingInput — Хранит отложенный ввод пользователя (текст, изображение, назначение) для последующей обработки

---
def _configure_agent_sandbox() -> None
Настраивает файловую структуру песочницы агента, создавая необходимые директории
Аргументы
Нет аргументов
Возвращает
Нет возвращаемого значения
Исключения
Может выбросить исключение при ошибках доступа к файловой системе

---
def _agent_sandbox_root() -> str
Возвращает путь к корневой директории песочницы агента
Аргументы
Нет аргументов
Возвращает
Строка с путём к корню песочницы
Исключения
Нет исключений

---
def _agent_service_entries() -> set[str]
Возвращает имена служебных файлов/директорий, которые не должны удаляться из песочницы
Аргументы
Нет аргументов
Возвращает
Множество имён служебных записей
Исключения
Нет исключений

---
def _clear_agent_sandbox() -> tuple[int, int]
Очищает содержимое песочницы, удаляя все неслужебные файлы и директории
Аргументы
Нет аргументов
Возвращает
Кортеж: (количество удалённых, количество ошибок)
Исключения
Нет явных исключений (ошибки подсчитываются, но не пробрасываются)

---
def _clear_agent_session_files(session_id: str) -> bool
Удаляет файлы сессии агента, проверяя безопасность пути
Аргументы
session_id — Идентификатор сессии для удаления
Возвращает
True, если удаление прошло успешно или файлов не было
Исключения
Нет явных исключений (ошибки подавляются)

---
def is_allowed(chat_id: int) -> bool
Проверяет, разрешён ли доступ к боту для указанного чата
Аргументы
chat_id — Идентификатор чата Telegram
Возвращает
True, если чат в белом списке
Исключения
Нет исключений

---
def _plugin_awaiting_input(chat_id: int) -> bool
Проверяет, ожидает ли какой-либо плагин текстового ввода от пользователя
Аргументы
chat_id — Идентификатор чата
Возвращает
True, если есть активный ожидаемый ввод
Исключения
Нет явных исключений (ошибки подавляются)

---
def _cancel_plugin_dialogs(chat_id: int) -> None
Отменяет все активные диалоги ввода плагинов для указанного чата
Аргументы
chat_id — Идентификатор чата
Возвращает
Нет возвращаемого значения
Исключения
Нет явных исключений (ошибки подавляются)

---
class PendingInput
Хранит отложенные данные ввода пользователя для асинхронной обработки
Поля
session_id — Идентификатор сессии, с которой связан ввод
text — Текстовое сообщение от пользователя
dest — Словарь с информацией о назначении ввода (например, команда или плагин)
image_path — Опциональный путь к изображению, прикреплённому к сообщению
Методы
Нет методов

---
class BotApp
Основной класс Telegram-бота для управления агентом, сессиями и интерфейсами
Поля
config — Конфигурация приложения (AppConfig)
metrics — Сборщик метрик выполнения
manager — Менеджер сессий (SessionManager)
session_ui — Интерфейс управления сессиями (SessionUI)
agent — Оркестратор выполнения команд (OrchestratorRunner)
manager_orchestrator — Оркестратор управления сессиями (ManagerOrchestrator)
git — Обработчик Git-операций (GitOps)
mcp — Мост для взаимодействия с MCP (MCPBridge)
pending — Очередь отложенного ввода пользователя
agent_tasks — Активные задачи выполнения агента, индексируемые по ID сессии
manager_tasks — Активные задачи менеджера сессий
context_by_chat — Контексты Telegram для каждого чата
Методы
__init__(config: AppConfig) — Инициализирует бота, настраивает логирование, директории и компоненты
_configure_agent_sandbox() — Создаёт структуру директорий песочницы агента
_agent_sandbox_root() — Возвращает корень песочницы агента
_agent_service_entries() — Возвращает имена защищённых элементов песочницы
_clear_agent_sandbox() — Очищает песочницу от пользовательских данных
_clear_agent_session_files(session_id: str) — Удаляет файлы указанной сессии
is_allowed(chat_id: int) — Проверяет доступ чата по whitelist
_plugin_awaiting_input(chat_id: int) — Проверяет, ожидает ли плагин ввода
_cancel_plugin_dialogs(chat_id: int) — Отменяет все активные диалоги ввода плагинов
