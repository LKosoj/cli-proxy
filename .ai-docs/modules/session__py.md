# session

Модуль управляет жизненным циклом сессий взаимодействия с инструментами (tools), обеспечивая создание, активацию, сохранение и восстановление сессий. Поддерживает асинхронное выполнение команд в headless и интерактивном режимах, обработку ввода/вывода, детекцию состояний (простой, конфликты Git), управление временем жизни сессии и сохранение состояния. Основной класс — `Session`, инкапсулирующий поведение сессии. Централизованное управление сессиями осуществляется через `SessionManager`.

Ключевые структуры данных  
Session — объект, представляющий активную сессию взаимодействия с инструментом, включая очередь сообщений, состояние и метаданные  
SessionManager — централизованное управление активными сессиями, включая создание, переключение, сохранение и уничтожение

class Session  
Контекст выполнения CLI-инструмента с поддержкой headless и интерактивного режимов, управление состоянием и обработка вывода  
Поля  
id — уникальный идентификатор сессии  
tool — конфигурация инструмента, запускаемого в сессии  
workdir — рабочая директория сессии  
idle_timeout_sec — таймаут бездействия до автоматической остановки сессии  
config — глобальная конфигурация приложения  
name — опциональное имя сессии  
busy — флаг, указывающий, что сессия в данный момент обрабатывает запрос  
queue — очередь ожидающих сообщений  
run_lock — асинхронная блокировка для сериализации запуска команд  
send_lock — асинхронная блокировка для защиты отправки данных в процесс  
child — экземпляр pexpect.spawn для интерактивного режима  
current_proc — текущий асинхронный процесс (для headless-режима)  
_headless_interrupt_flag — флаг принудительной остановки headless-процесса  
resume_token — маркер для возобновления сессии (например, в чате)  
auto_commands_ran — флаг выполнения автоматических команд при старте  
started_at — временная метка запуска сессии  
last_output_ts — временная метка последнего вывода  
last_tick_ts — временная метка последнего "тика" (периодического вывода)  
last_tick_value — последнее значение тика  
tick_seen — количество обработанных тиков  
git_busy — флаг активности Git-операции  
git_conflict — флаг наличия конфликта слияния  
git_conflict_files — список файлов, участвующих в конфликте  
git_conflict_kind — тип конфликта (например, "merge", "rebase")  
agent_enabled — включен ли режим агента  
manager_enabled — включен ли режим менеджера  
agent_memory — словарь с памятью агента (состояние между запросами)  
project_root — корень проекта (определяется автоматически)  
state_summary — краткое описание состояния сессии  
state_updated_at — временная метка последнего обновления состояния  
headless_forced_stop — причина принудительной остановки headless-процесса  
Методы  
async run_prompt(prompt: str, image_path: Optional[str] = None) -> str — выполняет запрос в сессии, с поддержкой изображений и fallback на интерактивный режим  
async _run_headless(prompt: str, cmd_template: Optional[List[str]] = None, image_path: Optional[str] = None) -> str — запускает команду в headless-режиме с асинхронным чтением вывода  
async _run_interactive(prompt: str) -> str — запускает выполнение команды в интерактивной сессии через pexpect в отдельном потоке  
def _ensure_child() -> None — гарантирует наличие активной pexpect-сессии; при отсутствии — запускает новый процесс  
def _run_interactive_sync(prompt: str) -> str — синхронная реализация интерактивного выполнения команды с детекцией простоя и обновлением состояния  
def interrupt() -> None — прерывает текущий процесс (headless) или отправляет сигнал прерывания (интерактивный режим)  
def close() -> None — закрывает интерактивную сессию (pexpect), если она активна  
def _maybe_update_resume(output: str) -> None — обновляет токен возобновления, если в выводе найдено совпадение с `resume_regex`  
def _maybe_autoset_resume_regex(output: str) -> None — автоматически определяет и устанавливает регулярное выражение для возобновления, если оно не задано  
def _update_activity(text: str) -> None — обновляет временные метки активности и значение тикера на основе извлечённых токенов  
def is_active_by_tick(now: Optional[float] = None, window_sec: int = 3) -> bool — проверяет, была ли сессия активной в течение указанного временного окна  
def _cli_process_name() -> Optional[str] — определяет имя основного исполняемого файла CLI-инструмента, исключая обёртки (python, node и т.п.)  
def _is_cli_process_alive(name: str) -> bool — проверяет, запущен ли процесс с указанным именем в системе через `ps -ef`

---
class SessionManager  
Централизованное управление активными сессиями, включая создание, переключение, сохранение и уничтожение  
Поля  
config — глобальная конфигурация приложения  
sessions — словарь активных сессий по идентификаторам  
active_session_id — идентификатор текущей активной сессии  
_counter — счётчик для генерации уникальных ID сессий  
on_session_change — колбэк, вызываемый при изменении активной сессии  
Методы  
def create(tool: ToolConfig, workdir: str, name: Optional[str] = None) -> Session — создаёт новую сессию для указанного инструмента и рабочей директории  
def get(session_id: str) -> Optional[Session] — возвращает сессию по её идентификатору  
def active() -> Optional[Session] — возвращает активную в данный момент сессию  
def set_active(session_id: str) -> bool — устанавливает указанную сессию как активную  
def close(session_id: str) -> bool — закрывает и удаляет сессию по идентификатору  
def _fire_session_change() -> None — вызывает зарегистрированный обратный вызов при изменении состояния сессии  
def _persist_sessions() -> None — сохраняет текущее состояние всех сессий в файл  
def _restore_sessions() -> None — восстанавливает сессии из сохранённого состояния на диске

---
async run_prompt(prompt: str, image_path: Optional[str] = None) -> str  
Выполняет пользовательский запрос в сессии, выбирая между headless и интерактивным режимом, с поддержкой изображений  
Аргументы  
prompt — текст запроса для отправки инструменту  
image_path — путь к изображению (если поддерживается)  
Возвращает  
Строка с ответом от инструмента  
Исключения  
RuntimeError — если инструмент не поддерживает изображения, но они переданы

---
async _run_headless(prompt: str, cmd_template: Optional[List[str]] = None, image_path: Optional[str] = None) -> str  
Запускает инструмент в headless-режиме (без интерактивной сессии), передаёт запрос и собирает вывод  
Аргументы  
prompt — текст запроса  
cmd_template — шаблон команды (опционально, иначе используется конфиг инструмента)  
image_path — путь к изображению (если требуется)  
Возвращает  
Строка с полным выводом процесса  
Исключения  
Exception — при ошибках запуска процесса или чтения вывода

---
async _run_interactive(prompt: str) -> str  
Запускает выполнение команды в интерактивной сессии через pexpect в отдельном потоке  
Аргументы  
prompt — команда или ввод, отправляемый в интерактивный процесс  
Возвращает  
Накопленный вывод до момента завершения или таймаута без активности  
Исключения  
Exception — при ошибках взаимодействия с pexpect

---
def _ensure_child() -> None  
Гарантирует наличие активной pexpect-сессии; при отсутствии — запускает новый процесс  
Аргументы  
Нет  
Исключения  
Подавляет исключения при запуске процесса или отправке автокоманд

---
def _run_interactive_sync(prompt: str) -> str  
Синхронная реализация интерактивного выполнения команды с детекцией простоя и обновлением состояния  
Аргументы  
prompt — ввод, отправляемый в процесс  
Возвращает  
Собранный вывод команды; при отсутствии регулярного выражения приглашения — по таймауту простоя  
Исключения  
Не выбрасывает исключения напрямую, ошибки логируются

---
def interrupt() -> None  
Прерывает текущий процесс (headless) или отправляет сигнал прерывания (интерактивный режим)  
Аргументы  
Нет  
Исключения  
Подавляет все исключения, возникающие при попытке завершения процесса

---
def close() -> None  
Закрывает интерактивную сессию (pexpect), если она активна  
Аргументы  
Нет  
Исключения  
Подавляет исключения при закрытии сессии

---
def _maybe_update_resume(output: str) -> None  
Обновляет токен возобновления, если в выводе найдено совпадение с `resume_regex`  
Аргументы  
output — текст вывода процесса  
Исключения  
Не выбрасывает исключения

---
def _maybe_autoset_resume_regex(output: str) -> None  
Автоматически определяет и устанавливает регулярное выражение для возобновления, если оно не задано  
Аргументы  
output — вывод процесса, анализируемый на наличие шаблона возобновления  
Исключения  
Не выбрасывает исключения

---
def _update_activity(text: str) -> None  
Обновляет временные метки активности и значение тикера на основе извлечённых токенов  
Аргументы  
text — текст вывода, из которого извлекаются токены активности  
Исключения  
Не выбрасывает исключения

---
def is_active_by_tick(now: Optional[float] = None, window_sec: int = 3) -> bool  
Проверяет, была ли сессия активной в течение указанного временного окна  
Аргументы  
now — текущее время (по умолчанию — time.time())  
window_sec — длительность окна активности в секундах  
Возвращает  
True, если сессия была активной в течение последних `window_sec` секунд  
Исключения  
Нет

---
def _cli_process_name() -> Optional[str]  
Определяет имя основного исполняемого файла CLI-инструмента, исключая обёртки (python, node и т.п.)  
Возвращает  
Имя процесса или None, если команда не задана  
Исключения  
Нет

---
def _is_cli_process_alive(name: str) -> bool  
Проверяет, запущен ли процесс с указанным именем в системе через `ps -ef`  
Аргументы  
name — имя процесса для проверки  
Возвращает  
True, если процесс найден и активен  
Исключения  
Нет

---
def create(tool: ToolConfig, workdir: str, name: Optional[str] = None) -> Session  
Создаёт новую сессию для указанного инструмента и рабочей директории  
Аргументы  
tool — конфигурация инструмента, с которым будет создана сессия  
workdir — рабочая директория для сессии  
name — опциональное имя сессии  
Возвращает  
Новый объект сессии  
Исключения  
Не выбрасывает исключения, но ошибки при сохранении состояния подавляются

---
def get(session_id: str) -> Optional[Session]  
Возвращает сессию по её идентификатору  
Аргументы  
session_id — уникальный идентификатор сессии  
Возвращает  
Объект сессии или None, если сессия не найдена  
Исключения  
Нет

---
def active() -> Optional[Session]  
Возвращает активную в данный момент сессию  
Возвращает  
Активная сессия или None, если активной сессии нет  
Исключения  
Нет

---
def set_active(session_id: str) -> bool  
Устанавливает указанную сессию как активную  
Аргументы  
session_id — идентификатор сессии, которую нужно сделать активной  
Возвращает  
True, если сессия найдена и успешно установлена как активная, иначе False  
Исключения  
Нет

---
def close(session_id: str) -> bool  
Закрывает и удаляет сессию по идентификатору  
Аргументы  
session_id — идентификатор сессии для закрытия  
Возвращает  
True, если сессия была успешно закрыта и удалена, иначе False  
Исключения  
Нет

---
def _fire_session_change() -> None  
Вызывает зарегистрированный обратный вызов при изменении состояния сессии  
Исключения  
Любые исключения, возникшие при выполнении обратного вызова, логируются и подавляются

---
def _persist_sessions() -> None  
Сохраняет текущее состояние всех сессий в файл  
Исключения  
Ошибки при сериализации или записи подавляются

---
def _restore_sessions() -> None  
Восстанавливает сессии из сохранённого состояния на диске  
Исключения  
Ошибки при чтении или парсинге логируются и подавляются

---
def run_tool_help(tool: ToolConfig, workdir: str, idle_timeout_sec: int) -> str  
Выполняет команду справки для указанного инструмента и возвращает её вывод  
Аргументы  
tool — конфигурация инструмента  
workdir — рабочая директория для запуска команды  
idle_timeout_sec — максимальное время ожидания ответа  
Возвращает  
Текст вывода команды справки или сообщение об отсутствии данных  
Исключения  
Нет
