# session

Модуль реализует управление сессиями выполнения внешних инструментов (например, AI-агентов или CLI-приложений) в интерактивном или headless-режиме. Обеспечивает асинхронное выполнение команд, обработку ввода/вывода, детекцию состояний (активность, простоя, конфликты Git), поддержку изображений и возобновление сессий. Состояние сессий сохраняется и восстанавливается через внешние хранилища, а процессы изолируются с использованием `pexpect` и `asyncio.subprocess`. Управление централизовано через `SessionManager`, отвечающий за создание, переключение и персистентность сессий.

Ключевые структуры данных  
Session — Основная единица выполнения, представляющая сессию взаимодействия с инструментом, включая состояние, процесс, буферы, настройки и очередь сообщений  
SessionManager — Централизованное управление коллекцией сессий: создание, активация, сохранение, восстановление и уведомления об изменениях

---
```python
async def run_prompt(self, prompt: str, image_path: Optional[str] = None) -> str
```
Выполняет запрос к инструменту с поддержкой изображений, выбирая режим (headless/интерактивный) в зависимости от конфигурации  
Аргументы  
prompt — текст запроса для передачи инструменту  
image_path — путь к изображению, если требуется (опционально)  
Возвращает  
строку с ответом от инструмента  
Исключения  
RuntimeError — если инструмент не поддерживает изображения, но они переданы

---
```python
async def _run_headless(self, prompt: str, cmd_template: Optional[List[str]] = None, image_path: Optional[str] = None) -> str
```
Запускает инструмент в headless-режиме (без интерактивного терминала) с передачей команды через stdin или аргументы  
Аргументы  
prompt — текст запроса  
cmd_template — шаблон команды для выполнения (если не указан, используется конфигурация инструмента)  
image_path — путь к изображению (если требуется)  
Возвращает  
вывод инструмента в виде строки  
Исключения  
Exception — при ошибках выполнения процесса, таймаутах или прерывании

---
```python
def _update_activity(self, output_chunk: str) -> None
```
Обновляет временную метку активности, анализирует вывод на наличие тиков, конфликтов Git и других состояний  
Аргументы  
output_chunk — фрагмент вывода от процесса для анализа  
Возвращает  
None

---
```python
def _pid_exists(pid: int) -> bool
```
Проверяет, существует ли процесс с указанным PID  
Аргументы  
pid — идентификатор процесса  
Возвращает  
True, если процесс существует; False, если завершён или не найден

---
```python
async def _run_headless(self) -> str
```
Выполняет CLI-инструмент в headless-режиме и возвращает весь собранный вывод  
Аргументы  
self — экземпляр Session  
Возвращает  
Строка с выводом процесса; при ошибках может содержать предупреждение  
Исключения  
Внутренние исключения перехватываются и логируются, внешних не выбрасывает

---
```python
async def _run_interactive(self, prompt: str) -> str
```
Отправляет команду в интерактивный режим и асинхронно ожидает ответ  
Аргументы  
prompt — команда для отправки в интерактивный процесс  
Возвращает  
Вывод, полученный до появления приглашения или по таймауту  
Исключения  
Внутренние исключения перехватываются и логируются

---
```python
def _ensure_child(self) -> None
```
Гарантирует, что дочерний процесс (pexpect) запущен; при необходимости создаёт его  
Аргументы  
self — экземпляр Session  
Исключения  
Может подавлять исключения при отправке auto-команд

---
```python
def _run_interactive_sync(self, prompt: str) -> str
```
Синхронная реализация отправки команды в интерактивный режим  
Аргументы  
prompt — команда для отправки  
Возвращает  
Вывод от CLI до приглашения или по таймауту без приглашения  
Исключения  
Внутренние исключения при ожидании подавляются

---
```python
def interrupt(self) -> None
```
Прерывает текущий процесс (headless или интерактивный) с использованием сигналов или управляющей последовательности  
Аргументы  
self — экземпляр Session  
Исключения  
Подавляет все исключения при попытке завершения

---
```python
def close(self) -> None
```
Закрывает интерактивный процесс (pexpect), принудительно при необходимости  
Аргументы  
self — экземпляр Session  
Исключения  
Подавляет исключения при закрытии

---
```python
def _maybe_update_resume(self, output: str) -> None
```
Обновляет токен возобновления, если в выводе найдено совпадение с регулярным выражением возобновления  
Аргументы  
output — вывод CLI для анализа  
Исключения  
Импорт `re` и `strip_ansi` не обрабатывается отдельно

---
```python
def _maybe_autoset_resume_regex(self, output: str) -> None
```
Автоматически устанавливает регулярное выражение возобновления, если оно не задано и может быть выведено из вывода  
Аргументы  
output — вывод CLI для анализа  
Исключения  
Подавляет исключения при сохранении конфигурации

---
```python
def _update_activity(self, text: str) -> None
```
Обновляет временные метки активности и последнее значение тика на основе нового вывода  
Аргументы  
text — фрагмент вывода для извлечения токенов активности  
Исключения  
Не выбрасывает исключений

---
```python
def is_active_by_tick(self, now: Optional[float] = None, window_sec: int = 3) -> bool
```
Проверяет, была ли сессия активной в течение указанного окна времени по последнему тику  
Аргументы  
now — текущее время (по умолчанию time.time())  
window_sec — длительность окна активности в секундах  
Возвращает  
True, если сессия была активна в течение последних window_sec секунд

---
```python
def _cli_process_name(self) -> Optional[str]
```
Определяет имя основного исполняемого файла CLI, исключая обёртки вроде python, node и т.п.  
Аргументы  
self — экземпляр Session  
Возвращает  
Имя основного процесса или None, если команда не задана

---
```python
def _is_cli_process_alive(self, name: str) -> bool
```
Проверяет, запущен ли процесс с указанным именем в системе через `ps -ef`  
Аргументы  
name — имя процесса для поиска  
Возвращает  
True, если процесс найден в списке запущенных  
Исключения  
Логирует ошибки, возвращает False при любых исключениях

---
```python
def get(self, session_id: str) -> Optional[Session]
```
Возвращает сессию по её идентификатору  
Аргументы  
session_id — уникальный идентификатор сессии  
Возвращает  
Объект сессии, если найден; иначе None

---
```python
def active(self) -> Optional[Session]
```
Возвращает активную сессию  
Возвращает  
Объект активной сессии, если она установлена; иначе None

---
```python
def set_active(self, session_id: str) -> bool
```
Устанавливает сессию с указанным ID как активную  
Аргументы  
session_id — идентификатор сессии, которую нужно активировать  
Возвращает  
True, если сессия существует и была успешно активирована; иначе False

---
```python
def close(self, session_id: str) -> bool
```
Закрывает и удаляет сессию по её идентификатору  
Аргументы  
session_id — идентификатор сессии для закрытия  
Возвращает  
True, если сессия была найдена и успешно закрыта; иначе False

---
```python
def _fire_session_change(self) -> None
```
Вызывает зарегистрированный callback при изменении состояния сессий  
Исключения  
Любые исключения, возникшие при вызове callback, логируются, но не прерывают выполнение

---
```python
def _persist_sessions(self) -> None
```
Сохраняет текущее состояние всех сессий на диск в указанный файл  
Исключения  
Исключения при сериализации или записи подавляются

---
```python
def _restore_sessions(self) -> None
```
Восстанавливает сессии из сохранённого состояния на диске  
Исключения  
Ошибки чтения или парсинга логируются, но не прерывают выполнение

---
```python
def run_tool_help(tool: ToolConfig, workdir: str, idle_timeout_sec: int) -> str
```
Запускает команду помощи для указанного инструмента и возвращает её вывод  
Аргументы  
tool — конфигурация инструмента, для которого запрашивается помощь  
workdir — рабочая директория, в которой запускается команда  
idle_timeout_sec — максимальное время ожидания ответа от инструмента  
Возвращает  
Текст вывода команды помощи или сообщение об отсутствии данных

---
class SessionManager  
Управляет коллекцией сессий, обеспечивает создание, переключение и восстановление состояния  
Поля  
config — конфигурация приложения  
sessions — словарь активных сессий по идентификаторам  
active_session_id — идентификатор текущей активной сессии  
_counter — счётчик для генерации уникальных ID сессий  
on_session_change — опциональный callback, вызываемый при изменении активной сессии  
Методы  
__init__(config) — инициализирует менеджер и восстанавливает сессии из состояния  
create(tool_name, workdir) — создаёт новую сессию, делает её активной и сохраняет состояние
