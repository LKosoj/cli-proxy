# session

Модуль реализует управление сессиями взаимодействия с внешними инструментами через командную строку. Поддерживает как headless-режим (однократные команды), так и интерактивный режим (через pexpect). Сессии сохраняют состояние, обнаруживают приглашения и токены возобновления, управляют таймаутами. Работает в асинхронной среде, обеспечивает потокобезопасность и сохранение состояния между перезапусками.

Ключевые структуры данных  
Session — состояние сессии взаимодействия с инструментом, включая процесс, историю, токены и активность  
SessionManager — централизованное управление множеством сессий, переключение, сохранение, создание и удаление

---
@dataclass
class Session
Сессия выполнения внешнего инструмента с поддержкой headless и интерактивного режимов
Поля
id — уникальный идентификатор сессии  
tool — конфигурация инструмента, с которым работает сессия  
workdir — рабочая директория сессии  
idle_timeout_sec — таймаут бездействия в секундах  
config — глобальная конфигурация приложения  
name — опциональное имя сессии  
busy — флаг занятости сессии  
queue — очередь команд, ожидающих выполнения  
run_lock — асинхронный замок для синхронизации выполнения  
child — экземпляр pexpect.spawn для интерактивного режима  
current_proc — текущий асинхронный процесс в headless-режиме  
resume_token — токен для возобновления сессии (например, ID чата)  
auto_commands_ran — флаг выполнения автоматических команд при старте  
started_at — временная метка начала сессии  
last_output_ts — время последнего вывода  
last_tick_ts — время последнего изменения тик-токена  
last_tick_value — последнее значение тик-токена  
tick_seen — количество изменений тик-токена  
git_busy — флаг активности Git-операции  
git_conflict — флаг наличия конфликта слияния  
git_conflict_files — список файлов, участвующих в конфликте  
git_conflict_kind — тип конфликта (если обнаружен)
Методы
async run_prompt(prompt: str, image_path: Optional[str] = None) -> str — выполняет запрос к инструменту, с поддержкой изображений и fallback на интерактивный режим  
async _run_headless(prompt: str, cmd_template: Optional[List[str]] = None, image_path: Optional[str] = None) -> str — запускает команду в headless-режиме  
async _run_interactive(prompt: str) -> str — запускает команду в интерактивном режиме через pexpect  
_ensure_child() — инициализирует или восстанавливает pexpect-процесс, если он неактивен  
_interrupt_sync() — синхронно прерывает текущую команду в интерактивном режиме  
_close_sync() — синхронно закрывает pexpect-процесс  
_maybe_update_resume(output: str) — извлекает и сохраняет токен возобновления из вывода, если задан resume_regex  
_maybe_autoset_resume_regex(output: str) — автоматически определяет и устанавливает resume_regex, если он не задан  
_update_activity(text: str) — обновляет временные метки активности и тик-токены на основе вывода  
is_active_by_tick(now: Optional[float] = None, window_sec: int = 3) -> bool — проверяет активность сессии по последнему изменению тик-токена

---
class SessionManager
Менеджер сессий, обеспечивающий создание, переключение, сохранение и удаление сессий
Поля
config — глобальная конфигурация приложения  
sessions — словарь активных сессий по ID  
active_session_id — ID активной сессии  
_counter — счётчик для генерации уникальных ID
Методы
async create_session(tool_name: str, workdir: str, session_name: Optional[str] = None) -> Session — создаёт новую сессию с указанным инструментом и рабочей директорией, сохраняет её и делает активной  
get_session(session_id: str) -> Optional[Session] — возвращает сессию по ID или None, если не найдена  
get_active_session() -> Optional[Session] — возвращает активную сессию или None  
set_active_session(session_id: str) -> bool — устанавливает сессию с указанным ID как активную, возвращает успех операции  
list_sessions() -> List[Dict[str, Any]] — возвращает список краткой информации о всех сессиях  
async delete_session(session_id: str) -> bool — удаляет сессию по ID, закрывает её и удаляет состояние, возвращает успех операции  
async cleanup_inactive_sessions() -> None — закрывает неактивные сессии, опираясь на таймауты и активность  
save_state() — сохраняет состояние менеджера (активная сессия) в постоянное хранилище  
load_state() — загружает состояние менеджера (активную сессию) из постоянного хранилища

---
create(tool_name: str, workdir: str) -> Session
Создаёт новую сессию для указанного инструмента в заданной рабочей директории.
Аргументы
tool_name — имя инструмента, зарегистрированного в конфигурации  
workdir — путь к рабочей директории сессии
Возвращает
Новый объект сессии с уникальным идентификатором
Исключения
Исключения не пробрасываются наружу — ошибки при чтении состояния логируются

---
get(session_id: str) -> Optional[Session]
Возвращает сессию по её идентификатору или None, если сессия не найдена.
Аргументы
session_id — строковый идентификатор сессии
Возвращает
Объект Session или None, если сессия не существует

---
active() -> Optional[Session]
Возвращает активную сессию или None, если активной сессии нет.
Возвращает
Текущая активная сессия или None

---
set_active(session_id: str) -> bool
Устанавливает указанную сессию как активную.
Аргументы
session_id — идентификатор сессии, которую нужно сделать активной
Возвращает
True, если сессия найдена и установлена как активная, иначе False

---
close(session_id: str) -> bool
Закрывает сессию по идентификатору, удаляет её из менеджера и очищает связанное состояние.
Аргументы
session_id — идентификатор сессии для закрытия
Возвращает
True, если сессия была успешно закрыта, иначе False

---
_persist_sessions() -> None
Сохраняет текущее состояние всех сессий в файл.

---
_restore_sessions() -> None
Восстанавливает сессии из сохранённого состояния на диске.

---
run_tool_help(tool: ToolConfig, workdir: str, idle_timeout_sec: int) -> str
Выполняет команду справки для указанного инструмента и возвращает её вывод.
Аргументы
tool — конфигурация инструмента  
workdir — рабочая директория для запуска инструмента  
idle_timeout_sec — максимальное время ожидания ответа от инструмента
Возвращает
Текст вывода команды справки или сообщение об отсутствии данных
Исключения
Исключения перехватываются и подавляются — возвращается заглушка при ошибках
