# utils

Модуль предоставляет инструменты для обработки текста с ANSI-кодами, преобразования Markdown и Mermaid-диаграмм в HTML, а также нормализации вывода терминала. Основное применение — подготовка чистого, визуально корректного HTML-представления из сырых терминальных логов, включая удаление служебных строк, дубликатов и безопасное отображение разметки. Поддерживается интеграция с внешним сервисом mermaid.ink для рендеринга диаграмм.

Ключевые структуры данных  
fg_color — текущий цвет текста в формате CSS (используется внутри замыкания функции strip_ansi)  
bold — флаг жирного начертания текста (управляется в процессе разбора ANSI-кодов)  
open_span — флаг, указывающий, открыт ли в данный момент HTML-тег `<span>`

---
def sandbox_root(workdir: str) -> str  
Возвращает путь к корневой директории песочницы для заданной рабочей директории.  
Аргументы  
workdir — путь к рабочей директории  
Возвращает  
Путь к директории `_sandbox` внутри workdir

---
def sandbox_shared_dir(workdir: str) -> str  
Возвращает путь к общей директории в песочнице.  
Аргументы  
workdir — путь к рабочей директории  
Возвращает  
Путь к директории `_shared` внутри песочницы

---
def sandbox_session_dir(workdir: str, session_id: str) -> str  
Возвращает путь к директории сессии в песочнице.  
Аргументы  
workdir — путь к рабочей директории  
session_id — идентификатор сессии  
Возвращает  
Путь к директории сессии внутри песочницы

---
def strip_ansi(text: str) -> str  
Преобразует строку с ANSI-кодами разметки в HTML-представление.  
Аргументы  
text — входная строка с ANSI-кодами разметки  
Возвращает  
Строка, в которой ANSI-разметка заменена на соответствующие HTML-теги `<span>` с inline-стилями  
Исключения  
Не выбрасывает исключения

---
def has_ansi(text: str) -> bool  
Проверяет, содержит ли строка ANSI-коды.  
Аргументы  
text — входной текст  
Возвращает  
True, если текст содержит ANSI-коды, иначе False

---
def extract_tick_tokens(text: str) -> List[str]  
Извлекает временные метки или тики (например, "12:34:56" или "5 sec") из текста.  
Аргументы  
text — входной текст  
Возвращает  
Список найденных временных меток

---
def ansi_to_html(text: str) -> str  
Преобразует текст с ANSI-кодами в полноценный HTML-документ с поддержкой Markdown, Mermaid и цветного форматирования.  
Аргументы  
text — входной текст с ANSI-кодами и разметкой  
Возвращает  
HTML-строка, готовая к отображению в браузере  
Исключения  
Может выбрасывать исключения при ошибках HTTP-запроса к mermaid.ink

---
def normalize_text(text: str, strip_ansi: bool = True) -> str  
Нормализует текст: удаляет ANSI-коды (опционально), строки MCP и дублирующиеся блоки.  
Аргументы  
text — входной текст  
strip_ansi — флаг, указывающий, нужно ли убрать ANSI-коды  
Возвращает  
Очищенный и нормализованный текст

---
def strip_ansi_codes(text: str) -> str  
Синоним функции strip_ansi для совместимости.  
Аргументы  
text — входной текст  
Возвращает  
Текст без ANSI-кодов

---
def _remove_mcp_lines(text: List[str]) -> List[str]  
Удаляет строки, начинающиеся с "mcp:", между первым вхождением и строкой "mcp startup:".  
Аргументы  
text — входной текст построчно  
Возвращает  
Текст без MCP-строк в указанном диапазоне

---
def _dedupe_repeated_blocks(text: str) -> str  
Удаляет последовательные повторяющиеся блоки строк в тексте.  
Аргументы  
text — входной текст  
Возвращает  
Текст без повторяющихся блоков

---
def _render_mermaid_svg(source: str) -> Optional[str]  
Отправляет Mermaid-диаграмму на рендеринг в mermaid.ink и возвращает SVG.  
Аргументы  
source — исходный код диаграммы на языке Mermaid  
Возвращает  
SVG-разметка диаграммы или None при ошибке  
Исключения  
Выбрасывает исключения при сетевых ошибках или таймаутах

---
def _apply_ansi_to_html(html_text: str) -> str  
Применяет преобразование ANSI-кодов в цветные HTML-теги внутри уже сгенерированного HTML.  
Аргументы  
html_text — HTML-текст, в котором нужно обработать ANSI-фрагменты  
Возвращает  
HTML с цветным форматированием, соответствующим ANSI-кодам

---
def _ansi_to_html_fragment(text: str) -> str  
Преобразует фрагмент текста с ANSI-кодами в HTML-разметку с цветами.  
Аргументы  
text — текст, содержащий ANSI-последовательности  
Возвращает  
HTML-фрагмент с применённым цветовым форматированием

---
def build_command(cmd_template: List[str], prompt: str, resume: Optional[str] = None, image: Optional[str] = None) -> Tuple[List[str], bool]  
Формирует команду из шаблона, подставляя значения подсказки, идентификатора продолжения и изображения.  
Аргументы  
cmd_template — шаблон команды в виде списка строк  
prompt — текст подсказки для вставки вместо `{prompt}`  
resume — идентификатор продолжения диалога (опционально)  
image — путь к изображению (опционально)  
Возвращает  
Кортеж из списка строк (готовая команда) и флага, указывающего, нужно ли передавать подсказку через stdin

---
def detect_prompt_regex(lines: List[str]) -> Optional[str]  
Определяет регулярное выражение для распознавания приглашения командной строки по последним строкам вывода.  
Аргументы  
lines — список строк вывода (возможно, с ANSI-разметкой)  
Возвращает  
Строка с регулярным выражением для поиска приглашения, или `None`, если определить не удалось

---
def detect_resume_regex(text: str) -> Optional[str]  
Ищет в тексте шаблоны, указывающие на наличие идентификатора продолжения сессии.  
Аргументы  
text — текст для анализа (например, вывод API)  
Возвращает  
Регулярное выражение для извлечения идентификатора продолжения, или `None`, если не найдено

---
def make_html_file(html_text: str, prefix: str) -> str  
Создаёт временный HTML-файл с указанным содержимым и возвращает путь к нему.  
Аргументы  
html_text — содержимое HTML-файла  
prefix — префикс для имени временного файла  
Возвращает  
Полный путь к созданному временному HTML-файлу  
Исключения  
Может выбросить исключение при ошибках ввода-вывода

---
def build_preview(text: str, max_chars: int) -> str  
Формирует краткий предварительный просмотр текста с ограничением по длине.  
Аргументы  
text — исходный текст (возможно, с ANSI-разметкой)  
max_chars — максимальное количество символов в предварительном просмотре  
Возвращает  
Обрезанный текст с суффиксом `...(обрезано)...`, если длина превышает лимит

---
def escape_html_text(text: str) -> str  
Экранирует специальные символы HTML в строке.  
Аргументы  
text — строка для экранирования  
Возвращает  
Строка с заменёнными символами `<`, `>`, `&` и другими на соответствующие HTML-сущности

---
def is_within_root(path: str, root: str) -> bool  
Проверяет, находится ли путь внутри заданного корневого каталога (защита от выхода за пределы).  
Аргументы  
path — проверяемый путь  
root — корневой каталог  
Возвращает  
`True`, если путь находится внутри `root`, иначе `False`  
Исключения  
Возвращает `False` при любых ошибках разрешения путей

---
def resolve_env_value(value: Optional[str]) -> Optional[str]  
Разрешает переменные окружения в строке с помощью `os.path.expandvars`.  
Аргументы  
value — строка, возможно, содержащая переменные окружения (например, `$HOME`)  
Возвращает  
Строка с подставленными значениями переменных окружения или `None`, если входное значение `None`
