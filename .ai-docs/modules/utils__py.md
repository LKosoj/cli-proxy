# utils

Модуль предоставляет инструменты для обработки текста, содержащего ANSI-коды, Markdown и Mermaid-диаграммы, с последующей конвертацией в HTML. Основное назначение — преобразование терминального вывода (например, логов) в читаемый HTML-формат с сохранением цветового форматирования и визуализацией диаграмм. Поддерживаются фильтрация служебных строк, удаление дубликатов блоков и извлечение временных меток.

Ключевые структуры данных  
_ANSI_FG_COLORS — словарь, сопоставляющий коды цветов ANSI с соответствующими CSS-цветами (не экспортируется напрямую, используется внутри функций)

strip_ansi(text)
Удаляет ANSI-escape последовательности из строки.
Аргументы
text — входной текст с возможными ANSI-кодами
Возвращает
текст без ANSI-кодов
Исключения
не выбрасывает
---
has_ansi(text)
Проверяет, содержит ли строка ANSI-коды.
Аргументы
text — входной текст
Возвращает
True, если найдены ANSI-коды, иначе False
Исключения
не выбрасывает
---
extract_tick_tokens(text)
Извлекает временные метки и тики (например, "12:34:56" или "5s") из текста.
Аргументы
text — входной текст
Возвращает
список найденных временных меток
Исключения
не выбрасывает
---
ansi_to_html(text)
Преобразует текст с ANSI-кодами в полноценный HTML-документ с поддержкой Markdown и Mermaid.
Аргументы
text — входной текст с ANSI-кодами и разметкой
Возвращает
валидный HTML-документ как строку
Исключения
не выбрасывает
---
_normalize_text(text, strip_ansi)
Нормализует текст: удаляет ANSI, фильтрует MCP-строки, устраняет повторяющиеся блоки.
Аргументы
text — исходный текст
strip_ansi — флаг, указывающий, нужно ли удалять ANSI-коды
Возвращает
нормализованный текст
Исключения
не выбрасывает
---
strip_ansi_codes(text)
Удаляет ANSI-коды из текста (синоним strip_ansi).
Аргументы
text — текст для обработки
Возвращает
текст без ANSI-кодов
Исключения
не выбрасывает
---
_remove_mcp_lines(text)
Удаляет строки между первым вхождением "mcp:" и строкой "mcp startup:".
Аргументы
text — входной текст построчно
Возвращает
текст без MCP-блоков
Исключения
не выбрасывает
---
_dedupe_repeated_blocks(text)
Удаляет последовательные повторяющиеся блоки строк.
Аргументы
text — входной текст
Возвращает
текст без дублирующихся блоков
Исключения
не выбрасывает
---
_render_mermaid_svg(source)
Преобразует Mermaid-диаграмму в SVG через внешний сервис mermaid.ink.
Аргументы
source — исходный код диаграммы Mermaid
Возвращает
SVG-разметку как строку или None при ошибке
Исключения
не выбрасывает
---
_apply_ansi_to_html(html_text)
Применяет цветовое форматирование ANSI к HTML-тексту.
Аргументы
html_text — HTML-текст с ANSI-кодами в текстовых узлах
Возвращает
HTML с добавленным стилем для ANSI-цветов
Исключения
не выбрасывает
---
_ansi_to_html_fragment(text)
Конвертирует фрагмент текста с ANSI-кодами в HTML с цветами.
Аргументы
text — текстовый фрагмент с ANSI-кодами
Возвращает
HTML-фрагмент с тегами <span> и стилями
Исключения
не выбрасывает
---
_span()
Обновляет HTML-тег <span> в выходном потоке в зависимости от текущего стиля и состояния открытия тега
Аргументы
Нет аргументов
Возвращает
Нет возвращаемого значения
Исключения
Нет исключений
---
build_command(cmd_template: List[str], prompt: str, resume: Optional[str] = None, image: Optional[str] = None) -> Tuple[List[str], bool]
Формирует команду из шаблона с подстановкой значений {prompt}, {resume}, {image} и управлением флагами
Аргументы
cmd_template — шаблон команды в виде списка строк
prompt — текст запроса для подстановки вместо {prompt}
resume — идентификатор возобновления диалога (опционально)
image — путь к изображению для подстановки (опционально)
Возвращает
Кортеж из списка строк (готовая команда) и флага, указывающего, нужно ли передавать prompt через stdin
Исключения
Нет исключений
---
detect_prompt_regex(lines: List[str]) -> Optional[str]
Определяет регулярное выражение для поиска приглашения ввода на основе анализа последних строк
Аргументы
lines — список строк вывода с возможной ANSI-разметкой
Возвращает
Строку с регулярным выражением, если приглашение обнаружено, иначе None
Исключения
Нет исключений
---
detect_resume_regex(text: str) -> Optional[str]
Обнаруживает в тексте шаблоны, указывающие на наличие идентификатора сессии, и возвращает соответствующее регулярное выражение
Аргументы
text — текст для анализа (возможно, с ANSI-разметкой)
Возвращает
Строку с регулярным выражением для извлечения идентификатора сессии, если найдено, иначе None
Исключения
Нет исключений
---
make_html_file(html_text: str, prefix: str) -> str
Создаёт временный HTML-файл с указанным содержимым и возвращает путь к нему
Аргументы
html_text — содержимое HTML-страницы
prefix — префикс для имени временного файла
Возвращает
Путь к созданному временному HTML-файлу
Исключения
Может выбросить исключение при ошибках ввода-вывода (не перехватывается)
---
build_preview(text: str, max_chars: int) -> str
Формирует краткий текстовый превью заданной длины, удаляя ANSI-разметку
Аргументы
text — исходный текст, возможно, с ANSI-разметкой
max_chars — максимальное количество символов в превью
Возвращает
Обрезанный до max_chars текст без ANSI-разметки
Исключения
Нет исключений
---
escape_html_text(text: str) -> str
Экранирует специальные HTML-символы в строке
Аргументы
text — строка для экранирования
Возвращает
Экранированная строка, безопасная для вставки в HTML
Исключения
Нет исключений
---
is_within_root(path: str, root: str) -> bool
Проверяет, находится ли путь внутри заданного корневого каталога (защита от выхода за пределы)
Аргументы
path — проверяемый путь
root — корневой каталог
Возвращает
True, если путь находится внутри root, иначе False
Исключения
Возвращает False при любых ошибках (например, доступе к файловой системе)
---
resolve_env_value(value: Optional[str]) -> Optional[str]
Раскрывает переменные окружения в строке с помощью os.path.expandvars
Аргументы
value — строка с переменными окружения (например, $HOME), может быть None
Возвращает
Строка с раскрытыми переменными окружения или None, если входное значение None
Исключения
Нет исключений
