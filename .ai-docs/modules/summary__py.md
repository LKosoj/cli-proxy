# summary

Модуль предоставляет асинхронные функции для генерации кратких резюме текста с использованием OpenAI API. Основной функционал включает очистку входного текста, адаптацию длины резюме под объём исходных данных и извлечение ключевой информации из конца текста. Поддерживается настройка через переменные окружения и конфигурационный объект, а также обработка ошибок API. Дополнительно модуль предоставляет функциональность для генерации сообщений коммитов с использованием языковых моделей через OpenAI-compatible API. Основные функции позволяют получать краткие или детализированные сообщения коммитов на основе текстового описания изменений. Поддерживается асинхронный и синхронный вызов, автоматическая обработка ответов и извлечение структурированных данных.

Ключевые структуры данных
AppConfig — конфигурационный объект приложения, содержащий настройки по умолчанию, включая параметры OpenAI

---
async def _summarize_with_cfg(text: str, max_chars: int, cfg: Tuple[str, str, str]) -> str
Генерирует краткое резюме текста с помощью модели OpenAI, учитывая его длину и содержание конца.
Аргументы
text — исходный текст для резюмирования
max_chars — максимальное количество символов в итоговом резюме
cfg — кортеж из (API-ключ, модель, базовый URL) для настройки клиента OpenAI
Возвращает
Строка с резюме на русском языке, адаптированная по длине и структуре, либо обрезанная версия при превышении лимита
Исключения
Исключения от OpenAI API (APITimeoutError, APIConnectionError, APIStatusError) не обрабатываются внутри функции

---
async def summarize_text(text: str, max_chars: int = 3000, config: Optional[AppConfig] = None) -> Optional[str]
Возвращает краткое резюме текста или сам текст, если он короче 3000 символов; использует настройки из config или переменных окружения.
Аргументы
text — входной текст для обработки
max_chars — максимальная длина резюме в символах (по умолчанию 3000)
config — опциональный объект конфигурации приложения
Возвращает
Строка с резюме или оригинальный текст, если он короткий; None, если конфигурация недоступна
Исключения
Внутренние исключения OpenAI API не перехватываются

---
async def summarize_text_with_reason(text: str, max_chars: int = 3000, config: Optional[AppConfig] = None) -> Tuple[Optional[str], Optional[str]]
Аналогична summarize_text, но возвращает также причину неудачи при ошибке.
Аргументы
text — входной текст для обработки
max_chars — максимальная длина резюме в символах (по умолчанию 3000)
config — опциональный объект конфигурации приложения
Возвращает
Кортеж из (резюме или None, описание ошибки или None)
Исключения
APITimeoutError — возвращает "таймаут OpenAI"
APIConnectionError — возвращает "нет соединения с OpenAI"
APIStatusError — возвращает "ошибка OpenAI HTTP {status_code}"
Exception — возвращает "неожиданный ответ OpenAI"

---
def _get_openai_config(config: Optional[AppConfig] = None) -> Optional[Tuple[str, str, str]]
Извлекает и объединяет настройки OpenAI из переменных окружения и/или объекта конфигурации.
Аргументы
config — опциональный объект конфигурации приложения
Возвращает
Кортеж (api_key, model, base_url) при наличии ключа и модели; иначе None

---
def _strip_cli_preamble(text: str) -> str
Удаляет заголовок в формате CLI (метаданные, разделители), если он содержит блок "user:" и похож на технический отчёт.
Аргументы
text — входной текст
Возвращает
Очищенный текст без заголовка, если он распознан; иначе исходный текст

---
def _length_bucket(text_len: int) -> str
Определяет категорию длины текста: "короткий", "средний" или "длинный".
Аргументы
text_len — длина текста в символах
Возвращает
Строку с категорией длины

---
def _suggest_max_tokens(text: str, max_chars: int) -> int
Рассчитывает оптимальное значение max_tokens для генерации, исходя из длины текста и лимита символов.
Аргументы
text — исходный текст
max_chars — максимальное количество символов в выводе
Возвращает
Рекомендуемое количество токенов (от 200 до 1200)

---
def _compact_reason(reason: str) -> str
Сжимает текст причины до 120 символов, добавляя многоточие при обрезке.
Аргументы
reason — исходная строка с описанием
Возвращает
Сжатая строка длиной не более 120 символов

---
def _tail_digest(text: str) -> str
Извлекает и структурирует ключевую информацию из последних строк текста: результаты изменений или вопросы.
Аргументы
text — исходный текст
Возвращает
Строка с ключевыми пунктами из конца текста (результаты или вопросы), отформатированная как маркированный список

---
async def _chat_completion_async(config: AppConfig, system: str, user: str, max_tokens: int, temperature: float) -> str
Выполняет асинхронный запрос к модели для генерации текста на основе системного и пользовательского сообщений
Аргументы
config — Конфигурация приложения с данными для подключения к API
system — Системное сообщение, задающее поведение модели
user — Пользовательский ввод — описание изменений
max_tokens — Максимальное число токенов в ответе
temperature — Параметр креативности генерации
Возвращает
Сгенерированный текст ответа модели или пустая строка при ошибке
Исключения
Может выбрасывать исключения, связанные с сетевым запросом или API

---
async def suggest_commit_message_async(text: str, config: Optional[AppConfig] = None) -> Optional[str]
Генерирует краткое сообщение коммита на русском языке длиной до ~80 символов
Аргументы
text — Текст с описанием изменений (обрезается до 12000 символов)
config — Конфигурация приложения с настройками API
Возвращает
Краткое сообщение коммита без точки в конце или None при ошибке

---
async def suggest_commit_message_detailed_async(text: str, config: Optional[AppConfig] = None) -> Optional[Tuple[str, str]]
Генерирует детализированное сообщение коммита, включающее заголовок и тело с пунктами изменений
Аргументы
text — Текст с описанием изменений (обрезается до 12000 символов)
config — Конфигурация приложения с настройками API
Возвращает
Кортеж из заголовка и тела сообщения или None при ошибке

---
def suggest_commit_message(text: str, config: Optional[AppConfig] = None) -> Optional[str]
Синхронная версия функции suggest_commit_message_async
Аргументы
text — Текст с описанием изменений
config — Конфигурация приложения с настройками API
Возвращает
Краткое сообщение коммита или None, если вызов невозможен в текущем контексте

---
def suggest_commit_message_detailed(text: str, config: Optional[AppConfig] = None) -> Optional[Tuple[str, str]]
Синхронная версия функции suggest_commit_message_detailed_async
Аргументы
text — Текст с описанием изменений
config — Конфигурация приложения с настройками API
Возвращает
Кортеж из заголовка и тела сообщения или None, если вызов невозможен в текущем контексте
