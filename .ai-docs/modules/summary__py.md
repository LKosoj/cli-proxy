# summary

Модуль для асинхронного создания кратких резюме текстов с использованием OpenAI. Предоставляет функции для генерации сжатых, содержательных резюме на русском языке с адаптацией длины под объём входного текста. Поддерживает кэширование клиентов для эффективного взаимодействия с API OpenAI. Включает обработку конфигурации, нормализацию текста и извлечение ключевой информации из конца текста. Также предоставляет функциональность для генерации сообщений коммитов с использованием OpenAI API. Основные функции позволяют получать краткие и детализированные сообщения на основе текстового описания изменений. Внутренние вспомогательные функции обрабатывают ошибки, формируют запросы и извлекают значимые фрагменты текста. Поддерживается асинхронный и синхронный вызов.

Ключевые структуры данных  
AppConfig — конфигурация приложения, содержащая параметры доступа к OpenAI API

---
async def summarize_text(text: str, max_chars: int = 3000, config: Optional[AppConfig] = None) -> Optional[str]  
Асинхронно генерирует краткое резюме текста с адаптацией под его длину и ограничение по символам.  
Аргументы  
text — Входной текст для резюмирования.  
max_chars — Максимальное количество символов в резюме (по умолчанию 3000).  
config — Опциональная конфигурация приложения; если не задана, используется через переменные окружения.  
Возвращает  
Резюме текста как строку или None, если конфигурация недоступна.  
Исключения  
Не выбрасывает исключения напрямую, но может пропускать ошибки API через внутреннюю логику.

---
async def summarize_text_with_reason(text: str, max_chars: int = 3000, config: Optional[AppConfig] = None) -> Tuple[Optional[str], Optional[str]]  
Асинхронно генерирует резюме и возвращает его вместе с причиной отказа (если резюме не создано).  
Аргументы  
text — Входной текст для резюмирования.  
max_chars — Максимальное количество символов в резюме (по умолчанию 3000).  
config — Опциональная конфигурация приложения.  
Возвращает  
Кортеж из резюме (или None) и причины (или None, если резюме успешно).  
Исключения  
APIConnectionError — При ошибках подключения к API OpenAI.  
APITimeoutError — При превышении времени ожидания ответа от API.  
APIStatusError — При ошибке статуса ответа от API (например, 4xx/5xx).

---
def _get_openai_config(config: Optional[AppConfig] = None)  
Возвращает кортеж с настройками OpenAI (ключ, модель, базовый URL) из конфига или переменных окружения.  
Аргументы  
config — Опциональный объект конфигурации приложения.  
Возвращает  
Кортеж (api_key, model, base_url) или None, если ключ или модель не заданы.

---
def _strip_cli_preamble(text: str) -> str  
Удаляет заголовок CLI-формата (метаданные, разделители) из текста, если он обнаружен.  
Аргументы  
text — Входной текст, из которого нужно удалить преамбулу.  
Возвращает  
Очищенный текст без заголовка.

---
def _length_bucket(text_len: int) -> str  
Определяет категорию длины текста: "короткий", "средний" или "длинный".  
Аргументы  
text_len — Длина текста в символах.  
Возвращает  
Строку с категорией длины.

---
def _suggest_max_tokens(text: str, max_chars: int) -> int  
Рассчитывает рекомендуемое количество токенов для генерации на основе длины текста и лимита символов.  
Аргументы  
text — Входной текст.  
max_chars — Максимальное количество символов в резюме.  
Возвращает  
Число токенов, рекомендуемых для параметра max_tokens.

---
def _compact_reason(reason: str) -> str  
Сжимает текст причины до 120 символов с обрезанием и добавлением многоточия при необходимости.  
Аргументы  
reason — Исходный текст причины.  
Возвращает  
Сжатая версия текста длиной не более 120 символов.

---
async def _summarize_with_cfg(text: str, max_chars: int, cfg: Tuple[str, str, str]) -> str  
Генерирует резюме с использованием заданной конфигурации OpenAI (ключ, модель, URL).  
Аргументы  
text — Очищенный текст для резюмирования.  
max_chars — Максимальное количество символов в резюме.  
cfg — Кортеж с параметрами (api_key, model, base_url).  
Возвращает  
Сгенерированное резюме как строку.  
Исключения  
APIConnectionError — При проблемах подключения к API.  
APITimeoutError — При таймауте запроса.  
APIStatusError — При ошибке статуса ответа API.

---
async def _chat_completion_async(config: AppConfig, system: str, user: str, max_tokens: int, temperature: float) -> str  
Выполняет асинхронный запрос к OpenAI для генерации текста на основе системного и пользовательского сообщений.  
Аргументы  
config — конфигурация приложения с параметрами API.  
system — системное сообщение, задающее поведение модели.  
user — пользовательский ввод с описанием задачи.  
max_tokens — максимальное число токенов в ответе.  
temperature — параметр креативности генерации.  
Возвращает  
Сгенерированный текст ответа или пустая строка при ошибке.

---
async def suggest_commit_message_async(text: str, config: Optional[AppConfig] = None) -> Optional[str]  
Генерирует краткое сообщение коммита на русском языке в одну строку до ~80 символов.  
Аргументы  
text — текст с описанием изменений (обрезается до 12000 символов).  
config — конфигурация для доступа к OpenAI API.  
Возвращает  
Сгенерированное сообщение коммита или None при ошибке или отсутствии конфигурации.

---
async def suggest_commit_message_detailed_async(text: str, config: Optional[AppConfig] = None) -> Optional[Tuple[str, str]]  
Генерирует детализированное сообщение коммита, включающее заголовок и тело с пунктами изменений.  
Аргументы  
text — текст с описанием изменений (обрезается до 12000 символов).  
config — конфигурация для доступа к OpenAI API.  
Возвращает  
Кортеж из заголовка и тела сообщения или None при ошибке или отсутствии данных.

---
def suggest_commit_message(text: str, config: Optional[AppConfig] = None) -> Optional[str]  
Синхронная версия функции suggest_commit_message_async.  
Аргументы  
text — текст с описанием изменений.  
config — конфигурация для доступа к OpenAI API.  
Возвращает  
Сгенерированное краткое сообщение коммита или None, если вызов не в главном потоке или ошибка.

---
def suggest_commit_message_detailed(text: str, config: Optional[AppConfig] = None) -> Optional[Tuple[str, str]]  
Синхронная версия функции suggest_commit_message_detailed_async.  
Аргументы  
text — текст с описанием изменений.  
config — конфигурация для доступа к OpenAI API.  
Возвращает  
Кортеж из заголовка и тела детального сообщения или None, если вызов не в главном потоке или ошибка.

---
def _tail_digest(text: str) -> str  
Извлекает и структурирует последние значимые строки текста, отбирая результаты, вопросы и другие элементы.  
Аргументы  
text — входной текст, разбиваемый на строки.  
Возвращает  
Форматированный список до 4 пунктов в виде маркированного списка, обрезанных до 240 символов.
