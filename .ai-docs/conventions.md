# Соглашения

## Именование и форматирование

- **Переменные и функции**: `snake_case` (например, `pending_session_rename`, `build_sessions_menu`).
- **Классы**: `PascalCase` (например, `SessionUI`, `GitOps`).
- **Константы**: `UPPER_SNAKE_CASE` (например, `TOOL_TIMEOUT_MS`, `OUTPUT_TRIM_LEN`).
- **Файлы и модули**: `snake_case.py` (например, `session_manager.py`, `tooling_helpers.py`).
- **Конфигурационные ключи**: `snake_case` (например, `manager_auto_commit`, `idle_timeout_sec`).

## Структура кода

- Классы и функции сопровождаются docstring в формате Google Style.
- Модули начинаются с краткого описания назначения.
- Импорты группируются: стандартная библиотека, сторонние, внутренние.
- Длинные строки разбиваются по 88 символов (PEP 8).

## Обработка ошибок

- Исключения логируются через `logging.exception()` с контекстом.
- Сетевые операции (Telegram, HTTP) обрабатываются с повторными попытками.
- Критические сбои (например, потеря соединения с MCP) не прерывают работу бота.
- Ошибки валидации входных данных возвращаются пользователю в понятной форме.

## Работа с данными

- Состояние сессий и планов сохраняется в JSON с атомарной записью.
- Используются потокобезопасные операции чтения/записи (`read_json_locked`, `write_json_locked`).
- Пути проверяются на безопасность (`is_within_root`) перед использованием.
- Чувствительные данные (токены, ключи) не логируются и не передаются в вывод.

## Логирование

- Уровни: `INFO` — основные события, `ERROR` — сбои, `DEBUG` — отладка.
- Формат: `%(asctime)s %(levelname)s %(message)s`.
- Логи разделяются по назначению: основной, ошибки, агенты.
- Ротация: ежедневно, хранится один архивный файл.

## Конфигурация

- Основной файл: `config.yaml`.
- Переменные окружения имеют приоритет над значениями в YAML.
- Поддерживаются подстановки `${VAR}`.
- Файл `.env` загружается автоматически из той же директории, что и `config.yaml`.

## Безопасность

- Доступ к боту ограничен `whitelist_chat_ids`.
- Команды проверяются на опасные паттерны (`BLOCKED_PATTERNS_PATH`).
- Запрещён доступ к чувствительным файлам (`.env`, `id_rsa`, `secrets.yaml`).
- Плагины и инструменты выполняются в изолированной среде (песочнице).

## Тестирование

- Модульные тесты покрывают ключевые сценарии: загрузка конфигурации, обработка команд, восстановление состояния.
- Используются моки для изоляции внешних зависимостей (Telegram API, MCP).
- Тесты запускаются в изолированной временной директории (`tmp_path`).
- Проверяется устойчивость к граничным случаям и сбоям.
