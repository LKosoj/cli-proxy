# Соглашения

## Именование и форматирование

- **Переменные и функции**: `snake_case` (например, `pending_session_rename`, `build_sessions_menu`).
- **Классы**: `PascalCase` (например, `SessionUI`, `BotApp`, `MCPBridge`).
- **Константы**: `UPPER_SNAKE_CASE` (например, `OPENAI_API_KEY`, `MAX_MESSAGE_LENGTH`).
- **Файлы конфигурации**: `config.yaml` — строгая структура с вложенными секциями, без сортировки ключей при сохранении.
- **Имена файлов состояния**: `state.json`, `toolhelp.json` — размещаются по путям из `config.defaults`.

## Управление состоянием

- **Сессии**: ключ сессии формируется как `{tool}::{workdir}` через `make_key()`.
- **Активная сессия**: хранится в служебной записи `_active` в `state.json`.
- **Дополнительные данные сессий**: сохраняются в поле `_sessions` (произвольная структура).
- **Сохранение**: все изменения состояния фиксируются через `save_state()` и `update_state()` с атомарной записью.
- **Ошибки чтения/записи**: логируются, но не прерывают выполнение.

## Обработка пользовательского ввода

- **Колбэки**: обрабатываются через `handle_callback()` с возвратом `True` при успешной обработке, иначе `False`.
- **Текстовые сообщения**: обрабатываются в `handle_pending_message()` при наличии ожидания ввода (например, переименование).
- **Отмена операций**: поддерживается по вводу `"-"`, `"отмена"` или `/cancel`.
- **Безопасность ввода**: все пути проверяются через `is_within_root()` для предотвращения выхода за пределы `workdir`.

## Конфигурация

- **Приоритет значений**: переменные окружения (`${VAR}`) имеют приоритет над `config.yaml`.
- **Обязательные параметры**:
  - `telegram.token` — токен бота.
  - `whitelist_chat_ids` — список разрешённых чатов.
  - `mtproto.api_id`, `mtproto.api_hash` — при включённой MTProto-интеграции.
- **Опциональные компоненты**: `telethon` — только при `mtproto.enabled: true`.

## Логирование и ошибки

- **Формат логов**: `YYYY-MM-DD HH:MM:SS | УРОВЕНЬ | сообщение`.
- **Ротация**: ежедневно в 03:00 UTC, хранится один архив.
- **Обработка ошибок**:
  - Сетевые сбои: повторные попытки отправки (до 5 раз, экспоненциальная задержка).
  - Ошибки выполнения: возвращаются пользователю через `_send_message`.
  - Критические сбои: логируются, бот продолжает работу.

## Работа с файлами

- **Временные файлы**:
  - Изображения: очищаются старше 24 часов.
  - HTML-вывод: удаляются после отправки.
  - MTProto-артефакты: очищаются по `mtproto_cleanup_days`.
- **Ограничения**:
  - Изображения: до `image_max_mb` (по умолчанию 10 МБ).
  - Текстовые вложения: до 300 КБ для вставки в промпт.
  - Отправка в Telegram: до 45 МБ.

## Интерактивные интерфейсы

- **Клавиатуры**: `InlineKeyboardMarkup` с постраничным отображением (10 элементов на страницу).
- **Состояния меню**: управляются через `dirs_menu`, `files_menu`, `state_menu` по `chat_id`.
- **Подтверждение действий**: обязательное для удаления, коммитов, сброса состояния.

## Безопасность

- **Доступ**: проверка `is_allowed(chat_id)` по `whitelist_chat_ids`.
- **Git-токены**: передаются через `GIT_ASKPASS` (временный скрипт), не сохраняются.
- **MTProto-сессии**: хранятся в зашифрованном виде или через `session_string`.
- **Опасные команды**: блокируются или требуют подтверждения (на будущее — контроль через `approval-mode`).

## Тестирование

- **Запуск**: `pytest -q`
- **Покрытие**: основные сценарии — создание сессии, обработка колбэков, ввод имени, Git-операции.
- **Моки**: внешние зависимости (API, процессы) заменяются заглушками.
