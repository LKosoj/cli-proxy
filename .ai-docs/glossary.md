# Глоссарий

## Сессия
Изолированный контекст выполнения CLI-инструмента (например, Codex, Claude). Содержит рабочую директорию, очередь команд, состояние процесса и токен возобновления. Сохраняется в `state.json` и восстанавливается после перезапуска бота.

## SessionManager
Центральный компонент управления сессиями. Обеспечивает создание, активацию, сохранение и восстановление сессий. Гарантирует потокобезопасность через `run_lock`. Восстанавливает сессии из `state.json` при старте.

## SessionUI
Класс, реализующий интерфейс управления сессиями через Telegram. Формирует inline-клавиатуры, обрабатывает колбэки и текстовые сообщения. Поддерживает: выбор сессии, переименование, изменение resume-токена, просмотр статуса.

## GitOps
Модуль для выполнения Git-операций через Telegram. Поддерживает: `pull`, `push`, `commit`, `merge`, `rebase`, `stash`. Использует `github_token` через `GIT_ASKPASS` для безопасной аутентификации. Работает асинхронно, блокирует параллельные операции через `git_busy`.

## MTProto
Интеграция с Telegram API через библиотеку Telethon. Позволяет отправлять сообщения и файлы в указанные чаты (`targets`) без участия бота. Требует `api_id`, `api_hash`, `session_string`. Управляется через `MTProtoUI`.

## MCPBridge
TCP-сервер, принимающий JSON-запросы от внешних клиентов. Проверяет токен, передаёт промпт в `BotApp`, возвращает результат. Формат: `{"token": "...", "prompt": "...", "session_id": "..."}`. Включается через `mcp.enabled`.

## State (состояние)
Файл `state.json`, хранящий:
- Сохранённые сессии: `{tool}::{workdir}` → `SessionState`
- Активную сессию: `_active` → `ActiveState`
- Дополнительные данные: `_sessions`

Управление: `load_state()`, `save_state()`, `update_state()`, `get_state()`.

## ToolHelp
Кэш справочной информации об инструментах. Хранится в `toolhelp.json`. Структура: `tool_name` → `ToolHelpEntry` (content, updated_at). Обновляется командой `/toolhelp`.

## Preset
Предустановленный промпт, доступный через `/preset`. Определяется в `config.yaml` в секции `presets`. Пример: `tests: "Запусти тесты и покажи результат"`.

## Inline-меню
Интерактивные клавиатуры в Telegram. Используются для:
- Навигации по сессиям (`/sessions`)
- Выбора директорий (`/dirs`)
- Управления Git-операциями
- Подтверждения действий

Реализованы через `InlineKeyboardMarkup` и `callback_data`.

## Resume-токен
Идентификатор для возобновления сессии (например, `thread_id` в OpenAI). Сохраняется в `SessionState.resume_token`. Используется при перезапуске инструмента через `resume_cmd`.

## Headless-режим
Режим выполнения без интерактивного ввода. Команда запускается с `{prompt}`, вывод обрабатывается полностью. Противопоставляется интерактивному режиму.

## ANSI → HTML
Преобразование цветного терминального вывода в HTML с помощью `ansi2html`. Поддерживает цвета, жирный текст, списки задач. Используется для отправки форматированного лога в Telegram.

## Mermaid-рендеринг
Конвертация блоков Mermaid в SVG через `https://mermaid.ink/svg/`. Встраивается в HTML-вывод. Таймаут: 10 сек.

## Буферизация сообщений
Отложенная отправка длинных сообщений через `message_buffer`. Сообщения группируются и отправляются пачками с задержкой, чтобы избежать лимитов Telegram.

## Whitelist
Список разрешённых `chat_id` в `config.yaml`. Проверяется через `is_allowed()`. Ограничивает доступ к боту.

## Git-конфликт
Состояние, при котором операция `merge` или `rebase` завершается с конфликтами. Отслеживается через `git_conflict_files`. Пользователю предлагается: `Abort`, `Continue`, `Просмотр diff`, `Помощь агента`.

## Tick-токен
Специальная метка в выводе инструмента (например, `>>> tick`), сигнализирующая об активности. Используется для определения завершения вывода при `idle_timeout_sec`.

## MCP (Model Context Protocol)
Протокол обмена данными с внешними клиентами. Реализован через `MCPBridge` как TCP-сервер с JSON-интерфейсом. Позволяет интегрировать бота в сторонние системы.
