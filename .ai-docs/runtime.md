# Запуск и окружение

## Запуск приложения

Точка входа — `__main__.py`. Запуск выполняется командой:
```bash
python -m bot
```

Приложение инициализируется в следующем порядке:
1. Загрузка переменных окружения из `.env`-файла в директории конфигурации.
2. Загрузка `config.yaml` через `load_config()`.
3. Построение экземпляра `BotApp` с помощью `build_app()`.
4. Запуск polling-режима через `application.run_polling()`.

## Окружение и конфигурация

### Переменные окружения
- `.env`-файл загружается автоматически из директории, указанной в `CONFIG_PATH`.
- Поддерживаются стандартные префиксы: `export KEY=value`, комментарии `#`, кавычки.
- Приоритет: переменные окружения > значения в `.env` > значения в `config.yaml`.

### Конфигурационный файл (`config.yaml`)
Обязательные параметры:
```yaml
telegram:
  token: "YOUR_BOT_TOKEN"
  whitelist_chat_ids: [123456789]  # ID разрешённых пользователей

defaults:
  workdir: "/path/to/working/directory"
  log_path: "/path/to/bot.log"
```

Ключевые секции:
- `tools.*` — настройка CLI-инструментов (команды, режимы, переменные окружения).
- `mcp.*` — включение TCP-моста для внешних клиентов.
- `manager_*` — параметры режима оркестрации (таймауты, лимиты, автокоммит).
- `presets` — шаблоны задач для быстрого запуска.

## Зависимости

Установка зависимостей:
```bash
pip install -r requirements.txt
```

Ключевые пакеты:
- `python-telegram-bot==20.7` — основа бота.
- `openai`, `httpx` — интеграция с LLM.
- `pexpect`, `ansi2html` — выполнение и рендеринг CLI-вывода.
- `PyYAML`, `md2tgmd` — конфигурация и форматирование.
- `duckduckgo-search`, `youtube-transcript-api` — внешние источники данных.

## Требования к системе

- Python 3.10+
- Доступ к `git` в `PATH` (для Git-операций).
- Установленные CLI-инструменты (Codex, Gemini и др.) — если используются.
- Свободный порт (по умолчанию `8888`) — если включён MCP-сервер.

## Рекомендации по развёртыванию

1. **Безопасность**:
   - Ограничьте доступ через `whitelist_chat_ids`.
   - Храните `.env` вне версии.
   - Используйте `sandbox_root` для изоляции рабочих директорий.

2. **Логирование**:
   - Настройте ротацию логов через `TimedRotatingFileHandler`.
   - Мониторьте `bot_error.log` для отладки.

3. **Восстановление**:
   - Состояние сессий сохраняется в `state.json`.
   - После перезапуска бот восстанавливает активные сессии и очереди.

4. **Производительность**:
   - Установите `idle_timeout_sec` для автоматического завершения неактивных сессий.
   - Ограничьте `manager_max_tasks` и `manager_max_attempts` во избежание бесконечных циклов.
