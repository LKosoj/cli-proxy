# Запуск и окружение

## Запуск бота

Бот запускается через основной скрипт `bot.py` в режиме polling:

```bash
python bot.py
```

При старте:
1. Загружается конфигурация из `config.yaml`.
2. Инициализируются компоненты: менеджер сессий, интерфейсы (SessionUI, GitOps, MTProtoUI), MCP-сервер.
3. Устанавливаются обработчики команд и колбэков.
4. Автоматически восстанавливаются сессии из `state.json`.
5. Запускается polling-режим получения обновлений от Telegram.

## Окружение

### Переменные окружения

Бот поддерживает подстановку переменных окружения в `config.yaml` через синтаксис `${VAR}`. Приоритет — переменные окружения выше значений в YAML.

Ключевые переменные:
- `TELEGRAM_TOKEN` — токен бота (альтернатива `telegram.token` в config).
- `OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_BASE_URL` — для генерации резюме и сообщений коммитов.
- `GITHUB_TOKEN` — для доступа к приватным репозиториям (через `GIT_ASKPASS`).
- `TELETHON_API_ID`, `TELETHON_API_HASH` — при использовании MTProto.

### Файлы состояния

- `state.json` — основной файл состояния: активная сессия, токены, очереди, метаданные.
- `toolhelp.json` — кэш справки по инструментам (результаты `/toolhelp`).

Файлы создаются автоматически при первом сохранении. Ошибки чтения/записи логируются, но не прерывают работу.

### Рабочие директории

- `workdir` — корневая директория сессий (настраивается в `defaults.workdir`).
- `image_temp_dir` — временные файлы изображений (очищаются старше 24 часов).
- `mtproto_output_dir` — результаты отправки через MTProto (очистка по `mtproto_cleanup_days`).
- `log_path` — логи с ротацией (ежедневно в 03:00 UTC, хранится 1 архив).

## Зависимости

Установка зависимостей:
```bash
pip install -r requirements.txt
```

Ключевые пакеты:
- `python-telegram-bot` — основа бота.
- `pexpect` — управление CLI-процессами.
- `ansi2html` — конвертация цветного вывода.
- `markdown-it-py[linkify,plugins]` — безопасный рендеринг Markdown.
- `telethon` — опционально, для MTProto-интеграции.
- `pytest` — тестирование (`pytest -q`).

## Тестирование

Запуск тестов:
```bash
pytest -q
```

Тесты проверяют:
- Обработку команд и колбэков.
- Работу сессий и очередей.
- Корректность генерации интерфейсов.
- Парсинг конфигурации и состояния.

## Особенности запуска

- **Автовосстановление**: после перезапуска бот восстанавливает все сессии из `state.json`.
- **Безопасность**: доступ только по `whitelist_chat_ids`, проверка путей через `is_within_root()`.
- **MTProto**: при отсутствии `session_string` требуется ручная авторизация (однократно).
- **MCP-сервер**: запускается только при `mcp.enabled: true`, слушает указанный хост/порт.
- **Буферизация**: длинные сообщения отправляются асинхронно с отложенной отправкой.
